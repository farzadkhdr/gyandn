<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .table-responsive {
            border-radius: 5px;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .system-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .copyright {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            body {
                background-color: white;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        .vehicle-details, .customer-details {
            display: none;
            margin-top: 20px;
        }
        
        .suggestion-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .status-returned {
            background-color: #d4edda;
        }
        
        .status-not-returned {
            background-color: #f8d7da;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .invoice-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .invoice-logo img {
            max-width: 200px;
            height: auto;
        }
        
        .custom-logo {
            max-height: 50px;
            margin-right: 10px;
        }
        
        .currency-badge {
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .user-only {
            display: none;
        }
        
        .system-logo-large {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 15px;
        }
        
        .signature-area {
            margin-top: 50px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }
        
        .maintenance-status {
            background-color: #fff3cd;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .vehicle-image {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="text-center mb-4">
            <i class="fas fa-car fa-3x text-primary mb-3"></i>
            <h2>Car Rental System</h2>
            <p class="text-muted">Please login to continue</p>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <div class="text-center mt-3">
            <small class="text-muted">Default admin password: 000000</small>
        </div>
        <div class="text-center mt-4">
            <small class="text-muted">Created by Farzad Programmer - Not Editable</small>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img id="headerLogo" src="" class="custom-logo" style="display: none;">
                    <span id="headerSystemName">Car Rental System</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> <span id="currentUser">Admin</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key"></i> Change Password</a></li>
                                <li class="admin-only"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userManagementModal"><i class="fas fa-users"></i> User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar d-none d-md-block no-print">
                    <div class="logo-container">
                        <img id="sidebarLogo" src="" class="system-logo-large" style="display: none;">
                        <span class="system-name" id="sidebarSystemName">RentalSys</span>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item dashboard-item">
                            <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item vehicles-item">
                            <a class="nav-link" href="#vehicles" data-bs-toggle="tab">
                                <i class="fas fa-car"></i> Vehicles
                            </a>
                        </li>
                        <li class="nav-item customers-item">
                            <a class="nav-link" href="#customers" data-bs-toggle="tab">
                                <i class="fas fa-users"></i> Customers
                            </a>
                        </li>
                        <li class="nav-item rentals-item">
                            <a class="nav-link" href="#rentals" data-bs-toggle="tab">
                                <i class="fas fa-receipt"></i> Rentals
                            </a>
                        </li>
                        <li class="nav-item returns-item">
                            <a class="nav-link" href="#returns" data-bs-toggle="tab">
                                <i class="fas fa-undo"></i> Vehicle Returns
                            </a>
                        </li>
                        <li class="nav-item maintenance-item">
                            <a class="nav-link" href="#maintenance" data-bs-toggle="tab">
                                <i class="fas fa-tools"></i> Vehicle Maintenance
                            </a>
                        </li>
                        <li class="nav-item payments-item">
                            <a class="nav-link" href="#payments" data-bs-toggle="tab">
                                <i class="fas fa-money-bill-wave"></i> Payments
                            </a>
                        </li>
                        <li class="nav-item fines-item">
                            <a class="nav-link" href="#fines" data-bs-toggle="tab">
                                <i class="fas fa-gavel"></i> Fines & Taxes
                            </a>
                        </li>
                        <li class="nav-item reports-item">
                            <a class="nav-link" href="#reports" data-bs-toggle="tab">
                                <i class="fas fa-chart-bar"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item frr-item">
                            <a class="nav-link" href="#frr" data-bs-toggle="tab">
                                <i class="fas fa-file-alt"></i> F.RETU.RENT
                            </a>
                        </li>
                        <li class="nav-item admin-only settings-item">
                            <a class="nav-link" href="#settings" data-bs-toggle="tab">
                                <i class="fas fa-cogs"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    <div class="copyright">
                        Created by Farzad Programmer<br>Not Editable
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-10 ms-sm-auto col-lg-10 px-4">
                    <div class="tab-content mt-4">
                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard">
                            <h2 class="mb-4">Dashboard</h2>
                            <div class="row" id="dashboardStats">
                                <!-- Dashboard statistics will be loaded here -->
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Recent Rentals
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="recentRentalsTable">
                                                        <!-- Recent rentals will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Vehicle Status
                                        </div>
                                        <div class="card-body">
                                            <canvas id="vehicleStatusChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicles Tab -->
                        <div class="tab-pane fade" id="vehicles">
                            <h2 class="mb-4">Vehicle Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#addVehicle">Add Vehicle</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleList">Vehicle List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleHistory">Vehicle History</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="addVehicle">
                                    <div class="card">
                                        <div class="card-header">
                                            Add New Vehicle
                                        </div>
                                        <div class="card-body">
                                            <form id="addVehicleForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleName" class="form-label">Vehicle Name</label>
                                                        <input type="text" class="form-control" id="vehicleName" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleOdometer" class="form-label">Odometer</label>
                                                        <input type="number" class="form-control" id="vehicleOdometer" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleVin" class="form-label">VIN #</label>
                                                        <input type="text" class="form-control" id="vehicleVin" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehiclePlate" class="form-label">Plate Number</label>
                                                        <input type="text" class="form-control" id="vehiclePlate" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleColor" class="form-label">Color</label>
                                                        <input type="text" class="form-control" id="vehicleColor" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleModel" class="form-label">Model</label>
                                                        <input type="text" class="form-control" id="vehicleModel" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleRentalPrice" class="form-label">Rental Price (per day)</label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="vehicleRentalPrice" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleImage" class="form-label">Vehicle Image</label>
                                                        <input type="file" class="form-control" id="vehicleImage" accept="image/*">
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Add Vehicle</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleSearch" placeholder="Search vehicles...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Image</th>
                                                            <th>Name</th>
                                                            <th>Model</th>
                                                            <th>Color</th>
                                                            <th>Plate #</th>
                                                            <th>Odometer</th>
                                                            <th>Rental Price</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleTableBody">
                                                        <!-- Vehicle data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Vehicle Details Section -->
                                    <div class="card vehicle-details" id="vehicleDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeVehicleDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="vehicleDetailsContent">
                                            <!-- Vehicle details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleHistory">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleHistorySearch" placeholder="Search by vehicle name...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleHistorySearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Vehicle</th>
                                                            <th>Customer</th>
                                                            <th>Rental Date</th>
                                                            <th>Return Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleHistoryTableBody">
                                                        <!-- Vehicle history will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Customers Tab -->
                        <div class="tab-pane fade" id="customers">
                            <h2 class="mb-4">Customer Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#addCustomer">Add Customer</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#customerList">Customer List</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="addCustomer">
                                    <div class="card">
                                        <div class="card-header">
                                            Add New Customer
                                        </div>
                                        <div class="card-body">
                                            <form id="addCustomerForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerFullName" class="form-label">Full Name</label>
                                                        <input type="text" class="form-control" id="customerFullName" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerAge" class="form-label">Age</label>
                                                        <input type="number" class="form-control" id="customerAge" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerId" class="form-label">PS/ID</label>
                                                        <input type="text" class="form-control" id="customerId" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerNationality" class="form-label">Nationality</label>
                                                        <input type="text" class="form-control" id="customerNationality" placeholder="Type country name..." required>
                                                        <div class="suggestion-list" id="nationalitySuggestions"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerContact" class="form-label">Contact Number</label>
                                                        <input type="text" class="form-control" id="customerContact" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="customerAddress" class="form-label">Address</label>
                                                        <input type="text" class="form-control" id="customerAddress" required>
                                                    </div>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="guaranteeDoc" class="form-label">Guarantee / Document</label>
                                                    <input type="file" class="form-control" id="guaranteeDoc">
                                                </div>
                                                <button type="submit" class="btn btn-primary">Add Customer</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="customerList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                                                <button class="btn btn-outline-secondary" type="button" id="customerSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Full Name</th>
                                                            <th>Age</th>
                                                            <th>ID</th>
                                                            <th>Nationality</th>
                                                            <th>Contact</th>
                                                            <th>Total Debt</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="customerTableBody">
                                                        <!-- Customer data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Customer Details Section -->
                                    <div class="card customer-details" id="customerDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeCustomerDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="customerDetailsContent">
                                            <!-- Customer details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rentals Tab -->
                        <div class="tab-pane fade" id="rentals">
                            <h2 class="mb-4">Rental Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Create New Rental
                                </div>
                                <div class="card-body">
                                    <form id="createRentalForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="rentalCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="rentalCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="customerSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="rentalVehicle" class="form-label">Vehicle</label>
                                                <input type="text" class="form-control" id="rentalVehicle" placeholder="Search vehicle...">
                                                <div class="suggestion-list" id="vehicleSuggestions"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="rentalAmount" class="form-label">Rental Amount (per day)</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="rentalAmount" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="rentalDays" class="form-label">Rental Days</label>
                                                <input type="number" class="form-control" id="rentalDays" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="rentalStartDate" class="form-label">Rental Start Date</label>
                                                <input type="date" class="form-control" id="rentalStartDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="rentalEndDate" class="form-label">Rental End Date</label>
                                                <input type="date" class="form-control" id="rentalEndDate" required>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="invoiceCode" class="form-label">Invoice Code</label>
                                                <input type="text" class="form-control" id="invoiceCode">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Create Rental</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Rental History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="rentalSearch" placeholder="Search by invoice code...">
                                        <button class="btn btn-outline-secondary" type="button" id="rentalSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Invoice Code</th>
                                                    <th>Customer</th>
                                                    <th>Vehicle</th>
                                                    <th>Start Date</th>
                                                    <th>End Date</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rentalTableBody">
                                                <!-- Rental data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Invoice for Printing -->
                            <div id="invoicePrint" class="print-only" style="display: none;">
                                <div class="invoice-logo">
                                    <img id="printLogo" src="" style="max-width: 200px; display: none;">
                                    <h3 id="printSystemName">Car Rental System</h3>
                                </div>
                                <div class="card">
                                    <div class="card-header text-center">
                                        <h3>Car Rental Invoice</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Invoice Code:</strong> <span id="printInvoiceCode"></span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Date:</strong> <span id="printInvoiceDate"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Customer:</strong> <span id="printCustomerName"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Vehicle:</strong> <span id="printVehicleName"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Customer ID:</strong> <span id="printCustomerId"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Customer Address:</strong> <span id="printCustomerAddress"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental Amount (per day):</strong> <span id="printRentalAmount"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental Days:</strong> <span id="printRentalDays"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental History:</strong>
                                                <div id="printRentalHistory"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <hr>
                                                <h4 class="text-end">Total: <span id="printTotalAmount"></span></h4>
                                            </div>
                                        </div>
                                        <div class="row signature-area">
                                            <div class="col-6">
                                                <strong>Customer Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000;"></div>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Company Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Returns Tab -->
                        <div class="tab-pane fade" id="returns">
                            <h2 class="mb-4">Vehicle Returns</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Return Vehicle
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="returnInvoiceSearch" class="form-label">Search by Invoice Code</label>
                                            <input type="text" class="form-control" id="returnInvoiceSearch" placeholder="Search invoice code...">
                                            <div class="suggestion-list" id="returnInvoiceSuggestions"></div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary me-2" id="searchInvoiceBtn">Search</button>
                                        </div>
                                    </div>
                                    <div id="returnFormContainer" style="display: none;">
                                        <form id="returnVehicleForm">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Customer</label>
                                                    <input type="text" class="form-control" id="returnCustomer" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Vehicle</label>
                                                    <input type="text" class="form-control" id="returnVehicle" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Rental Start Date</label>
                                                    <input type="text" class="form-control" id="returnRentalStartDate" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Expected Return Date</label>
                                                    <input type="text" class="form-control" id="returnExpectedDate" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="returnActualDate" class="form-label">Actual Return Date</label>
                                                    <input type="date" class="form-control" id="returnActualDate" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="returnFine" class="form-label">Late Return Fine</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="returnFine" value="0">
                                                        <span class="input-group-text">AED</span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="returnNotes" class="form-label">Notes</label>
                                                <textarea class="form-control" id="returnNotes" rows="3"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-success">Complete Return</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Return History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="returnHistorySearch" placeholder="Search returns...">
                                        <button class="btn btn-outline-secondary" type="button" id="returnHistorySearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Invoice Code</th>
                                                    <th>Customer</th>
                                                    <th>Vehicle</th>
                                                    <th>Rental Date</th>
                                                    <th>Return Date</th>
                                                    <th>Rental Days</th>
                                                    <th>Total Amount</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="returnHistoryTableBody">
                                                <!-- Return history will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Maintenance Tab -->
                        <div class="tab-pane fade" id="maintenance">
                            <h2 class="mb-4">Vehicle Maintenance</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Schedule Maintenance
                                </div>
                                <div class="card-body">
                                    <form id="scheduleMaintenanceForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceVehicle" class="form-label">Vehicle</label>
                                                <input type="text" class="form-control" id="maintenanceVehicle" placeholder="Search vehicle...">
                                                <div class="suggestion-list" id="maintenanceVehicleSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceType" class="form-label">Maintenance Type</label>
                                                <select class="form-select" id="maintenanceType" required>
                                                    <option value="">Select Type</option>
                                                    <option value="Oil Change">Oil Change</option>
                                                    <option value="Tire Replacement">Tire Replacement</option>
                                                    <option value="Brake Service">Brake Service</option>
                                                    <option value="Engine Tune-up">Engine Tune-up</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceDate" class="form-label">Maintenance Date</label>
                                                <input type="date" class="form-control" id="maintenanceDate" required>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="maintenanceCost" class="form-label">Cost</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="maintenanceCost" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="maintenanceNotes" class="form-label">Notes</label>
                                            <textarea class="form-control" id="maintenanceNotes" rows="3"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Schedule Maintenance</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Maintenance History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="maintenanceSearch" placeholder="Search maintenance...">
                                        <button class="btn btn-outline-secondary" type="button" id="maintenanceSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Vehicle</th>
                                                    <th>Type</th>
                                                    <th>Date</th>
                                                    <th>Cost</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="maintenanceTableBody">
                                                <!-- Maintenance data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments">
                            <h2 class="mb-4">Payment Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Record Payment
                                </div>
                                <div class="card-body">
                                    <form id="recordPaymentForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="paymentCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="paymentCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="paymentCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label">Current Debt</label>
                                                <div class="form-control" id="currentDebtAmount">0 AED</div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="paymentAmount" class="form-label">Payment Amount</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="paymentAmount" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="paymentDate" class="form-label">Payment Date</label>
                                                <input type="date" class="form-control" id="paymentDate" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="paymentNotes" class="form-label">Notes</label>
                                            <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Record Payment</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Payment History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="paymentSearch" placeholder="Search payments...">
                                        <button class="btn btn-outline-secondary" type="button" id="paymentSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentTableBody">
                                                <!-- Payment data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fines & Taxes Tab -->
                        <div class="tab-pane fade" id="fines">
                            <h2 class="mb-4">Fines & Taxes</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Add Fine/Tax
                                </div>
                                <div class="card-body">
                                    <form id="addFineTaxForm">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fineCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="fineCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="fineCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fineType" class="form-label">Type</label>
                                                <select class="form-select" id="fineType" required>
                                                    <option value="">Select Type</option>
                                                    <option value="Fine">Fine</option>
                                                    <option value="Tax">Tax</option>
                                                    <option value="Penalty">Penalty</option>
                                                    <option value="Salik">Salik</option>
                                                    <option value="Parking">Parking</option>
                                                    <option value="Car Wash">Car Wash</option>
                                                    <option value="Fuel">Fuel</option>
                                                    <option value="Delivery fees">Delivery fees</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="fineAmount" class="form-label">Amount</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="fineAmount" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="fineDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="fineDate" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="fineReason" class="form-label">Reason</label>
                                            <textarea class="form-control" id="fineReason" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Fine/Tax</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <span>Fines & Taxes History</span>
                                    <div class="input-group" style="width: 300px;">
                                        <input type="text" class="form-control" id="fineSearch" placeholder="Search fines/taxes...">
                                        <button class="btn btn-outline-secondary" type="button" id="fineSearchBtn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Type</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Reason</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fineTableBody">
                                                <!-- Fines data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Tab -->
                        <div class="tab-pane fade" id="reports">
                            <h2 class="mb-4">Reports</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Generate Report
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <label for="reportType" class="form-label">Report Type</label>
                                            <select class="form-select" id="reportType">
                                                <option value="rental">Rental Report</option>
                                                <option value="payment">Payment Report</option>
                                                <option value="vehicle">Vehicle Report</option>
                                                <option value="customer">Customer Report</option>
                                                <option value="customerActivity">Customer Activity Report</option>
                                                <option value="maintenance">Maintenance Report</option>
                                                <option value="fine">Fine & Tax Report</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reportStartDate" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="reportStartDate">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="reportEndDate" class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="reportEndDate">
                                        </div>
                                    </div>
                                    <div class="row mb-3" id="customerReportOptions" style="display: none;">
                                        <div class="col-md-6">
                                            <label for="reportCustomer" class="form-label">Customer</label>
                                            <input type="text" class="form-control" id="reportCustomer" placeholder="Search customer...">
                                            <div class="suggestion-list" id="reportCustomerSuggestions"></div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <button class="btn btn-primary me-2" id="generateReportBtn">Generate Report</button>
                                            <button class="btn btn-success me-2" id="exportExcelBtn">Export to Excel</button>
                                            <button class="btn btn-secondary" id="printReportBtn">Print Report</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Report Results
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="reportTable">
                                            <thead>
                                                <tr>
                                                    <!-- Table headers will be populated based on report type -->
                                                </tr>
                                            </thead>
                                            <tbody id="reportTableBody">
                                                <!-- Report data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- F.RETU.RENT Tab -->
                        <div class="tab-pane fade" id="frr">
                            <h2 class="mb-4">F.RETU.RENT - Combined Reports</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Filter Data
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <label for="frrStartDate" class="form-label">Start Date</label>
                                            <input type="date" class="form-control" id="frrStartDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="frrEndDate" class="form-label">End Date</label>
                                            <input type="date" class="form-control" id="frrEndDate">
                                        </div>
                                        <div class="col-md-3">
                                            <label for="frrCustomer" class="form-label">Customer</label>
                                            <input type="text" class="form-control" id="frrCustomer" placeholder="Search customer...">
                                            <div class="suggestion-list" id="frrCustomerSuggestions"></div>
                                        </div>
                                        <div class="col-md-3">
                                            <label for="frrVehicle" class="form-label">Vehicle</label>
                                            <input type="text" class="form-control" id="frrVehicle" placeholder="Search vehicle...">
                                            <div class="suggestion-list" id="frrVehicleSuggestions"></div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <button class="btn btn-primary me-2" id="frrFilterBtn">Filter</button>
                                            <button class="btn btn-success me-2" id="frrExportExcelBtn">Export to Excel</button>
                                            <button class="btn btn-secondary" id="frrPrintBtn">Print</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Combined Data
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover" id="frrTable">
                                            <thead>
                                                <tr>
                                                    <th>Invoice Code</th>
                                                    <th>Customer</th>
                                                    <th>Vehicle</th>
                                                    <th>Rental Date</th>
                                                    <th>Return Date</th>
                                                    <th>Rental Amount</th>
                                                    <th>Fine Amount</th>
                                                    <th>Tax Amount</th>
                                                    <th>Payment Amount</th>
                                                    <th>Total Amount</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody id="frrTableBody">
                                                <!-- Combined data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <h2 class="mb-4">System Settings</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    General Settings
                                </div>
                                <div class="card-body">
                                    <form id="systemSettingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="systemName" class="form-label">System Name</label>
                                                <input type="text" class="form-control" id="systemName" value="Car Rental System">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="systemCurrency" class="form-label">Currency</label>
                                                <select class="form-select" id="systemCurrency">
                                                    <option value="AED" selected>AED (UAE Dirham)</option>
                                                    <option value="USD">USD (US Dollar)</option>
                                                    <option value="EUR">EUR (Euro)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="systemLogo" class="form-label">System Logo</label>
                                                <input type="file" class="form-control" id="systemLogo" accept="image/*">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="lateReturnFee" class="form-label">Late Return Fee (per day)</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="lateReturnFee" value="50">
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="taxRate" class="form-label">Tax Rate (%)</label>
                                                <input type="number" class="form-control" id="taxRate" value="5" step="0.1">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Last Login</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody">
                                <!-- User data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mt-3" data-bs-toggle="modal" data-bs-target="#addUserModal">Add User</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add User Modal -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add User</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserForm">
                        <div class="mb-3">
                            <label for="newUsername" class="form-label">Username</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserPassword" class="form-label">Password</label>
                            <input type="password" class="form-control" id="newUserPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newUserRole" class="form-label">Role</label>
                            <select class="form-select" id="newUserRole" required>
                                <option value="admin">Admin</option>
                                <option value="user">User</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Add User</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalTitle">Edit</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="editModalBody">
                    <!-- Edit form will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Modal -->
    <div class="modal fade" id="notificationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Vehicle Return Reminder</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationContent">
                    <!-- Notification content will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Global variables
        let currentUser = null;
        let systemSettings = {
            systemName: "Car Rental System",
            currency: "AED",
            lateReturnFee: 50,
            taxRate: 5
        };
        
        // Sample data - starting from scratch
        let users = [
            { username: "admin", password: "000000", role: "admin", lastLogin: new Date() }
        ];
        
        let vehicles = [];
        let customers = [];
        let rentals = [];
        let returns = [];
        let payments = [];
        let fines = [];
        let maintenance = [];
        
        // Country list for nationality suggestions
        const countries = [
            "Afghanistan", "Albania", "Algeria", "Andorra", "Angola", "Antigua and Barbuda", "Argentina", "Armenia", "Australia", "Austria",
            "Azerbaijan", "Bahamas", "Bahrain", "Bangladesh", "Barbados", "Belarus", "Belgium", "Belize", "Benin", "Bhutan",
            "Bolivia", "Bosnia and Herzegovina", "Botswana", "Brazil", "Brunei", "Bulgaria", "Burkina Faso", "Burundi", "Cabo Verde", "Cambodia",
            "Cameroon", "Canada", "Central African Republic", "Chad", "Chile", "China", "Colombia", "Comoros", "Congo", "Costa Rica",
            "Croatia", "Cuba", "Cyprus", "Czech Republic", "Denmark", "Djibouti", "Dominica", "Dominican Republic", "Ecuador", "Egypt",
            "El Salvador", "Equatorial Guinea", "Eritrea", "Estonia", "Eswatini", "Ethiopia", "Fiji", "Finland", "France", "Gabon",
            "Gambia", "Georgia", "Germany", "Ghana", "Greece", "Grenada", "Guatemala", "Guinea", "Guinea-Bissau", "Guyana",
            "Haiti", "Honduras", "Hungary", "Iceland", "India", "Indonesia", "Iran", "Iraq", "Ireland", "Israel",
            "Italy", "Jamaica", "Japan", "Jordan", "Kazakhstan", "Kenya", "Kiribati", "Korea, North", "Korea, South", "Kosovo",
            "Kuwait", "Kyrgyzstan", "Laos", "Latvia", "Lebanon", "Lesotho", "Liberia", "Libya", "Liechtenstein", "Lithuania",
            "Luxembourg", "Madagascar", "Malawi", "Malaysia", "Maldives", "Mali", "Malta", "Marshall Islands", "Mauritania", "Mauritius",
            "Mexico", "Micronesia", "Moldova", "Monaco", "Mongolia", "Montenegro", "Morocco", "Mozambique", "Myanmar", "Namibia",
            "Nauru", "Nepal", "Netherlands", "New Zealand", "Nicaragua", "Niger", "Nigeria", "North Macedonia", "Norway", "Oman",
            "Pakistan", "Palau", "Palestine", "Panama", "Papua New Guinea", "Paraguay", "Peru", "Philippines", "Poland", "Portugal",
            "Qatar", "Romania", "Russia", "Rwanda", "Saint Kitts and Nevis", "Saint Lucia", "Saint Vincent and the Grenadines", "Samoa", "San Marino", "Sao Tome and Principe",
            "Saudi Arabia", "Senegal", "Serbia", "Seychelles", "Sierra Leone", "Singapore", "Slovakia", "Slovenia", "Solomon Islands", "Somalia",
            "South Africa", "South Sudan", "Spain", "Sri Lanka", "Sudan", "Suriname", "Sweden", "Switzerland", "Syria", "Taiwan",
            "Tajikistan", "Tanzania", "Thailand", "Timor-Leste", "Togo", "Tonga", "Trinidad and Tobago", "Tunisia", "Turkey", "Turkmenistan",
            "Tuvalu", "Uganda", "Ukraine", "United Arab Emirates", "United Kingdom", "United States", "Uruguay", "Uzbekistan", "Vanuatu", "Vatican City",
            "Venezuela", "Vietnam", "Yemen", "Zambia", "Zimbabwe"
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user is already logged in
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainApp();
            }
            
            // Login form submission
            document.getElementById('loginForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = user;
                    user.lastLogin = new Date();
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    showMainApp();
                } else {
                    alert('Invalid username or password');
                }
            });
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', function() {
                currentUser = null;
                localStorage.removeItem('currentUser');
                showLoginScreen();
            });
            
            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const currentPassword = document.getElementById('currentPassword').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                
                if (currentPassword !== currentUser.password) {
                    alert('Current password is incorrect');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    alert('New passwords do not match');
                    return;
                }
                
                currentUser.password = newPassword;
                users.find(u => u.username === currentUser.username).password = newPassword;
                alert('Password changed successfully');
                document.getElementById('changePasswordModal').querySelector('.btn-close').click();
                document.getElementById('changePasswordForm').reset();
            });
            
            // Add user form
            document.getElementById('addUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('newUsername').value;
                const password = document.getElementById('newUserPassword').value;
                const role = document.getElementById('newUserRole').value;
                
                if (users.find(u => u.username === username)) {
                    alert('Username already exists');
                    return;
                }
                
                users.push({
                    username: username,
                    password: password,
                    role: role,
                    lastLogin: null
                });
                
                alert('User added successfully');
                document.getElementById('addUserModal').querySelector('.btn-close').click();
                document.getElementById('addUserForm').reset();
                loadUserManagement();
            });
            
            // System settings form
            document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
                e.preventDefault();
                systemSettings.systemName = document.getElementById('systemName').value;
                systemSettings.currency = document.getElementById('systemCurrency').value;
                systemSettings.lateReturnFee = parseFloat(document.getElementById('lateReturnFee').value);
                systemSettings.taxRate = parseFloat(document.getElementById('taxRate').value);
                
                // Update system name in UI
                document.getElementById('headerSystemName').textContent = systemSettings.systemName;
                document.getElementById('sidebarSystemName').textContent = systemSettings.systemName;
                document.getElementById('printSystemName').textContent = systemSettings.systemName;
                
                // Handle logo upload
                const logoFile = document.getElementById('systemLogo').files[0];
                if (logoFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const logoDataUrl = e.target.result;
                        document.getElementById('headerLogo').src = logoDataUrl;
                        document.getElementById('headerLogo').style.display = 'inline';
                        document.getElementById('sidebarLogo').src = logoDataUrl;
                        document.getElementById('sidebarLogo').style.display = 'block';
                        document.getElementById('printLogo').src = logoDataUrl;
                        document.getElementById('printLogo').style.display = 'block';
                        localStorage.setItem('systemLogo', logoDataUrl);
                    };
                    reader.readAsDataURL(logoFile);
                }
                
                localStorage.setItem('systemSettings', JSON.stringify(systemSettings));
                alert('Settings saved successfully');
            });
            
            // Load saved settings
            const savedSettings = localStorage.getItem('systemSettings');
            if (savedSettings) {
                systemSettings = JSON.parse(savedSettings);
                document.getElementById('systemName').value = systemSettings.systemName;
                document.getElementById('systemCurrency').value = systemSettings.currency;
                document.getElementById('lateReturnFee').value = systemSettings.lateReturnFee;
                document.getElementById('taxRate').value = systemSettings.taxRate;
                
                // Update UI with saved settings
                document.getElementById('headerSystemName').textContent = systemSettings.systemName;
                document.getElementById('sidebarSystemName').textContent = systemSettings.systemName;
                document.getElementById('printSystemName').textContent = systemSettings.systemName;
            }
            
            // Load saved logo
            const savedLogo = localStorage.getItem('systemLogo');
            if (savedLogo) {
                document.getElementById('headerLogo').src = savedLogo;
                document.getElementById('headerLogo').style.display = 'inline';
                document.getElementById('sidebarLogo').src = savedLogo;
                document.getElementById('sidebarLogo').style.display = 'block';
                document.getElementById('printLogo').src = savedLogo;
                document.getElementById('printLogo').style.display = 'block';
            }
            
            // Initialize suggestion lists
            initializeSuggestionLists();
            
            // Initialize event listeners for various forms
            initializeFormListeners();
            
            // Check for vehicle return reminders
            checkVehicleReturnReminders();
        });
        
        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }
        
        // Show main application
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUser').textContent = currentUser.username;
            
            // Show/hide admin-only elements
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = currentUser.role === 'admin' ? 'block' : 'none';
            });
            
            // Load initial data
            loadDashboard();
            loadVehicleList();
            loadCustomerList();
            loadRentalList();
            loadReturnHistory();
            loadMaintenanceList();
            loadPaymentList();
            loadFineList();
            loadUserManagement();
            
            // Set up tab change listeners
            setupTabListeners();
        }
        
        // Initialize suggestion lists
        function initializeSuggestionLists() {
            // Nationality suggestions
            const nationalityInput = document.getElementById('customerNationality');
            const nationalitySuggestions = document.getElementById('nationalitySuggestions');
            
            nationalityInput.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filteredCountries = countries.filter(country => 
                    country.toLowerCase().includes(value)
                );
                
                if (filteredCountries.length > 0 && value) {
                    nationalitySuggestions.innerHTML = '';
                    filteredCountries.forEach(country => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = country;
                        div.addEventListener('click', function() {
                            nationalityInput.value = country;
                            nationalitySuggestions.style.display = 'none';
                        });
                        nationalitySuggestions.appendChild(div);
                    });
                    nationalitySuggestions.style.display = 'block';
                } else {
                    nationalitySuggestions.style.display = 'none';
                }
            });
            
            // Close suggestion list when clicking outside
            document.addEventListener('click', function(e) {
                if (!nationalityInput.contains(e.target) && !nationalitySuggestions.contains(e.target)) {
                    nationalitySuggestions.style.display = 'none';
                }
            });
            
            // Customer suggestions for various forms
            setupCustomerSuggestions('rentalCustomer', 'customerSuggestions');
            setupCustomerSuggestions('paymentCustomer', 'paymentCustomerSuggestions');
            setupCustomerSuggestions('fineCustomer', 'fineCustomerSuggestions');
            setupCustomerSuggestions('frrCustomer', 'frrCustomerSuggestions');
            setupCustomerSuggestions('reportCustomer', 'reportCustomerSuggestions');
            
            // Vehicle suggestions for various forms
            setupVehicleSuggestions('rentalVehicle', 'vehicleSuggestions');
            setupVehicleSuggestions('maintenanceVehicle', 'maintenanceVehicleSuggestions');
            setupVehicleSuggestions('frrVehicle', 'frrVehicleSuggestions');
            
            // Invoice suggestions for returns
            setupInvoiceSuggestions('returnInvoiceSearch', 'returnInvoiceSuggestions');
        }
        
        // Setup customer suggestions
        function setupCustomerSuggestions(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filteredCustomers = customers.filter(customer => 
                    customer.fullName.toLowerCase().includes(value)
                );
                
                if (filteredCustomers.length > 0 && value) {
                    suggestions.innerHTML = '';
                    filteredCustomers.forEach(customer => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = customer.fullName;
                        div.addEventListener('click', function() {
                            input.value = customer.fullName;
                            suggestions.style.display = 'none';
                            
                            // Set rental amount if this is the rental form
                            if (inputId === 'rentalCustomer') {
                                const vehicleInput = document.getElementById('rentalVehicle');
                                if (vehicleInput.value) {
                                    const vehicle = vehicles.find(v => v.name === vehicleInput.value);
                                    if (vehicle) {
                                        document.getElementById('rentalAmount').value = vehicle.rentalPrice;
                                    }
                                }
                            }
                            
                            // Update current debt if this is the payment form
                            if (inputId === 'paymentCustomer') {
                                updateCurrentDebt(customer.id);
                            }
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });
            
            // Close suggestion list when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }
        
        // Setup vehicle suggestions
        function setupVehicleSuggestions(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const value = this.value.toLowerCase();
                const filteredVehicles = vehicles.filter(vehicle => 
                    vehicle.name.toLowerCase().includes(value) && vehicle.status === "Available"
                );
                
                if (filteredVehicles.length > 0 && value) {
                    suggestions.innerHTML = '';
                    filteredVehicles.forEach(vehicle => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = vehicle.name;
                        div.addEventListener('click', function() {
                            input.value = vehicle.name;
                            suggestions.style.display = 'none';
                            
                            // Set rental amount if this is the rental form
                            if (inputId === 'rentalVehicle') {
                                document.getElementById('rentalAmount').value = vehicle.rentalPrice;
                            }
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });
            
            // Close suggestion list when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }
        
        // Setup invoice suggestions for returns
        function setupInvoiceSuggestions(inputId, suggestionsId) {
            const input = document.getElementById(inputId);
            const suggestions = document.getElementById(suggestionsId);
            
            input.addEventListener('input', function() {
                const value = this.value.toUpperCase();
                const filteredInvoices = rentals.filter(rental => 
                    rental.invoiceCode.includes(value) && rental.status === "Active"
                );
                
                if (filteredInvoices.length > 0 && value) {
                    suggestions.innerHTML = '';
                    filteredInvoices.forEach(rental => {
                        const div = document.createElement('div');
                        div.className = 'suggestion-item';
                        div.textContent = rental.invoiceCode;
                        div.addEventListener('click', function() {
                            input.value = rental.invoiceCode;
                            suggestions.style.display = 'none';
                            loadReturnForm(rental.id);
                        });
                        suggestions.appendChild(div);
                    });
                    suggestions.style.display = 'block';
                } else {
                    suggestions.style.display = 'none';
                }
            });
            
            // Close suggestion list when clicking outside
            document.addEventListener('click', function(e) {
                if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                    suggestions.style.display = 'none';
                }
            });
        }
        
        // Initialize form listeners
        function initializeFormListeners() {
            // Add vehicle form
            document.getElementById('addVehicleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const name = document.getElementById('vehicleName').value;
                const odometer = parseInt(document.getElementById('vehicleOdometer').value);
                const vin = document.getElementById('vehicleVin').value;
                const plate = document.getElementById('vehiclePlate').value;
                const color = document.getElementById('vehicleColor').value;
                const model = document.getElementById('vehicleModel').value;
                const rentalPrice = parseFloat(document.getElementById('vehicleRentalPrice').value);
                const imageFile = document.getElementById('vehicleImage').files[0];
                
                let imageDataUrl = null;
                if (imageFile) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imageDataUrl = e.target.result;
                        completeAddVehicle(name, odometer, vin, plate, color, model, rentalPrice, imageDataUrl);
                    };
                    reader.readAsDataURL(imageFile);
                } else {
                    completeAddVehicle(name, odometer, vin, plate, color, model, rentalPrice, null);
                }
            });
            
            // Add customer form
            document.getElementById('addCustomerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const fullName = document.getElementById('customerFullName').value;
                const age = parseInt(document.getElementById('customerAge').value);
                const idNumber = document.getElementById('customerId').value;
                const nationality = document.getElementById('customerNationality').value;
                const contact = document.getElementById('customerContact').value;
                const address = document.getElementById('customerAddress').value;
                
                const newCustomer = {
                    id: customers.length > 0 ? Math.max(...customers.map(c => c.id)) + 1 : 1,
                    fullName: fullName,
                    age: age,
                    idNumber: idNumber,
                    nationality: nationality,
                    contact: contact,
                    address: address,
                    totalDebt: 0
                };
                
                customers.push(newCustomer);
                alert('Customer added successfully');
                document.getElementById('addCustomerForm').reset();
                loadCustomerList();
            });
            
            // Create rental form
            document.getElementById('createRentalForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const customerName = document.getElementById('rentalCustomer').value;
                const vehicleName = document.getElementById('rentalVehicle').value;
                const amount = parseFloat(document.getElementById('rentalAmount').value);
                const days = parseInt(document.getElementById('rentalDays').value);
                const startDate = document.getElementById('rentalStartDate').value;
                const endDate = document.getElementById('rentalEndDate').value;
                const invoiceCode = document.getElementById('invoiceCode').value || `INV${String(rentals.length + 1).padStart(3, '0')}`;
                
                const customer = customers.find(c => c.fullName === customerName);
                const vehicle = vehicles.find(v => v.name === vehicleName);
                
                if (!customer) {
                    alert('Please select a valid customer');
                    return;
                }
                
                if (!vehicle) {
                    alert('Please select a valid vehicle');
                    return;
                }
                
                if (vehicle.status !== "Available") {
                    alert('Selected vehicle is not available for rental');
                    return;
                }
                
                const newRental = {
                    id: rentals.length > 0 ? Math.max(...rentals.map(r => r.id)) + 1 : 1,
                    invoiceCode: invoiceCode,
                    customerId: customer.id,
                    vehicleId: vehicle.id,
                    startDate: startDate,
                    endDate: endDate,
                    amount: amount * days,
                    status: "Active"
                };
                
                // Update vehicle status
                vehicle.status = "Rented";
                
                rentals.push(newRental);
                alert('Rental created successfully');
                document.getElementById('createRentalForm').reset();
                loadRentalList();
                loadVehicleList();
                loadDashboard();
                
                // Print invoice
                printInvoice(newRental.id);
            });
            
            // Return vehicle form
            document.getElementById('returnVehicleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const invoiceCode = document.getElementById('returnInvoiceSearch').value;
                const actualReturnDate = document.getElementById('returnActualDate').value;
                const fine = parseFloat(document.getElementById('returnFine').value) || 0;
                const notes = document.getElementById('returnNotes').value;
                
                const rental = rentals.find(r => r.invoiceCode === invoiceCode);
                if (!rental) {
                    alert('Invalid invoice code');
                    return;
                }
                
                // Update rental status
                rental.status = "Completed";
                
                // Update vehicle status
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                if (vehicle) {
                    vehicle.status = "Available";
                }
                
                // Create return record
                const newReturn = {
                    id: returns.length > 0 ? Math.max(...returns.map(r => r.id)) + 1 : 1,
                    rentalId: rental.id,
                    actualReturnDate: actualReturnDate,
                    fine: fine,
                    notes: notes
                };
                
                returns.push(newReturn);
                
                // If there's a fine, add it to fines
                if (fine > 0) {
                    const customer = customers.find(c => c.id === rental.customerId);
                    if (customer) {
                        customer.totalDebt += fine;
                        
                        const newFine = {
                            id: fines.length > 0 ? Math.max(...fines.map(f => f.id)) + 1 : 1,
                            customerId: customer.id,
                            type: "Fine",
                            amount: fine,
                            date: actualReturnDate,
                            reason: "Late return",
                            status: "Unpaid"
                        };
                        
                        fines.push(newFine);
                    }
                }
                
                alert('Vehicle return completed successfully');
                document.getElementById('returnVehicleForm').reset();
                document.getElementById('returnFormContainer').style.display = 'none';
                loadReturnHistory();
                loadRentalList();
                loadVehicleList();
                loadDashboard();
                loadFineList();
            });
            
            // Schedule maintenance form
            document.getElementById('scheduleMaintenanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const vehicleName = document.getElementById('maintenanceVehicle').value;
                const type = document.getElementById('maintenanceType').value;
                const date = document.getElementById('maintenanceDate').value;
                const cost = parseFloat(document.getElementById('maintenanceCost').value);
                const notes = document.getElementById('maintenanceNotes').value;
                
                const vehicle = vehicles.find(v => v.name === vehicleName);
                if (!vehicle) {
                    alert('Please select a valid vehicle');
                    return;
                }
                
                const newMaintenance = {
                    id: maintenance.length > 0 ? Math.max(...maintenance.map(m => m.id)) + 1 : 1,
                    vehicleId: vehicle.id,
                    type: type,
                    date: date,
                    cost: cost,
                    notes: notes,
                    status: "Scheduled"
                };
                
                maintenance.push(newMaintenance);
                alert('Maintenance scheduled successfully');
                document.getElementById('scheduleMaintenanceForm').reset();
                loadMaintenanceList();
            });
            
            // Record payment form
            document.getElementById('recordPaymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const customerName = document.getElementById('paymentCustomer').value;
                const amount = parseFloat(document.getElementById('paymentAmount').value);
                const date = document.getElementById('paymentDate').value;
                const notes = document.getElementById('paymentNotes').value;
                
                const customer = customers.find(c => c.fullName === customerName);
                if (!customer) {
                    alert('Please select a valid customer');
                    return;
                }
                
                const newPayment = {
                    id: payments.length > 0 ? Math.max(...payments.map(p => p.id)) + 1 : 1,
                    customerId: customer.id,
                    amount: amount,
                    date: date,
                    notes: notes
                };
                
                payments.push(newPayment);
                
                // Update customer debt
                customer.totalDebt -= amount;
                if (customer.totalDebt < 0) customer.totalDebt = 0;
                
                alert('Payment recorded successfully');
                document.getElementById('recordPaymentForm').reset();
                loadPaymentList();
                loadCustomerList();
                
                // Update current debt display
                updateCurrentDebt(customer.id);
            });
            
            // Add fine/tax form
            document.getElementById('addFineTaxForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const customerName = document.getElementById('fineCustomer').value;
                const type = document.getElementById('fineType').value;
                const amount = parseFloat(document.getElementById('fineAmount').value);
                const date = document.getElementById('fineDate').value;
                const reason = document.getElementById('fineReason').value;
                
                const customer = customers.find(c => c.fullName === customerName);
                if (!customer) {
                    alert('Please select a valid customer');
                    return;
                }
                
                const newFine = {
                    id: fines.length > 0 ? Math.max(...fines.map(f => f.id)) + 1 : 1,
                    customerId: customer.id,
                    type: type,
                    amount: amount,
                    date: date,
                    reason: reason,
                    status: "Unpaid"
                };
                
                fines.push(newFine);
                customer.totalDebt += amount;
                
                alert('Fine/Tax added successfully');
                document.getElementById('addFineTaxForm').reset();
                loadFineList();
                loadCustomerList();
            });
            
            // Search invoice for returns
            document.getElementById('searchInvoiceBtn').addEventListener('click', function() {
                const invoiceCode = document.getElementById('returnInvoiceSearch').value;
                const rental = rentals.find(r => r.invoiceCode === invoiceCode && r.status === "Active");
                
                if (rental) {
                    loadReturnForm(rental.id);
                } else {
                    alert('No active rental found with this invoice code');
                }
            });
            
            // Generate report
            document.getElementById('generateReportBtn').addEventListener('click', function() {
                generateReport();
            });
            
            // Export to Excel
            document.getElementById('exportExcelBtn').addEventListener('click', function() {
                exportToExcel();
            });
            
            // Print report
            document.getElementById('printReportBtn').addEventListener('click', function() {
                window.print();
            });
            
            // F.RETU.RENT filter
            document.getElementById('frrFilterBtn').addEventListener('click', function() {
                loadFRRData();
            });
            
            // F.RETU.RENT export to Excel
            document.getElementById('frrExportExcelBtn').addEventListener('click', function() {
                exportFRRToExcel();
            });
            
            // F.RETU.RENT print
            document.getElementById('frrPrintBtn').addEventListener('click', function() {
                window.print();
            });
            
            // Customer selection for payment form
            document.getElementById('paymentCustomer').addEventListener('input', function() {
                const customerName = this.value;
                const customer = customers.find(c => c.fullName === customerName);
                if (customer) {
                    updateCurrentDebt(customer.id);
                } else {
                    document.getElementById('currentDebtAmount').textContent = '0 AED';
                }
            });
            
            // Report type change
            document.getElementById('reportType').addEventListener('change', function() {
                const reportType = this.value;
                const customerOptions = document.getElementById('customerReportOptions');
                
                if (reportType === 'customerActivity') {
                    customerOptions.style.display = 'block';
                } else {
                    customerOptions.style.display = 'none';
                }
            });
        }
        
        // Complete add vehicle after image processing
        function completeAddVehicle(name, odometer, vin, plate, color, model, rentalPrice, imageDataUrl) {
            const newVehicle = {
                id: vehicles.length > 0 ? Math.max(...vehicles.map(v => v.id)) + 1 : 1,
                name: name,
                model: model,
                color: color,
                plate: plate,
                vin: vin,
                odometer: odometer,
                rentalPrice: rentalPrice,
                image: imageDataUrl,
                status: "Available"
            };
            
            vehicles.push(newVehicle);
            alert('Vehicle added successfully');
            document.getElementById('addVehicleForm').reset();
            loadVehicleList();
        }
        
        // Update current debt display
        function updateCurrentDebt(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (customer) {
                document.getElementById('currentDebtAmount').textContent = `${customer.totalDebt} AED`;
            }
        }
        
        // Setup tab listeners
        function setupTabListeners() {
            // Dashboard tab
            document.querySelector('.dashboard-item a').addEventListener('click', function() {
                loadDashboard();
            });
            
            // Vehicles tab
            document.querySelector('.vehicles-item a').addEventListener('click', function() {
                loadVehicleList();
            });
            
            // Customers tab
            document.querySelector('.customers-item a').addEventListener('click', function() {
                loadCustomerList();
            });
            
            // Rentals tab
            document.querySelector('.rentals-item a').addEventListener('click', function() {
                loadRentalList();
            });
            
            // Returns tab
            document.querySelector('.returns-item a').addEventListener('click', function() {
                loadReturnHistory();
            });
            
            // Maintenance tab
            document.querySelector('.maintenance-item a').addEventListener('click', function() {
                loadMaintenanceList();
            });
            
            // Payments tab
            document.querySelector('.payments-item a').addEventListener('click', function() {
                loadPaymentList();
            });
            
            // Fines tab
            document.querySelector('.fines-item a').addEventListener('click', function() {
                loadFineList();
            });
            
            // Reports tab
            document.querySelector('.reports-item a').addEventListener('click', function() {
                // Reports are generated on demand
            });
            
            // F.RETU.RENT tab
            document.querySelector('.frr-item a').addEventListener('click', function() {
                loadFRRData();
            });
        }
        
        // Load dashboard
        function loadDashboard() {
            // Calculate statistics
            const totalVehicles = vehicles.length;
            const availableVehicles = vehicles.filter(v => v.status === "Available").length;
            const rentedVehicles = vehicles.filter(v => v.status === "Rented").length;
            const totalCustomers = customers.length;
            const activeRentals = rentals.filter(r => r.status === "Active").length;
            
            // Calculate total payment (revenue)
            const totalPayment = rentals.reduce((sum, rental) => {
                if (rental.status === "Completed") {
                    return sum + rental.amount;
                }
                return sum;
            }, 0);
            
            // Update dashboard stats
            const dashboardStats = document.getElementById('dashboardStats');
            dashboardStats.innerHTML = `
                <div class="col-md-3">
                    <div class="card dashboard-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${totalVehicles}</h4>
                                    <p>Total Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-car fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${availableVehicles}</h4>
                                    <p>Available Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${rentedVehicles}</h4>
                                    <p>Rented Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-road fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card dashboard-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${totalPayment} <span class="currency-badge">AED</span></h4>
                                    <p>Total Payment</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Load recent rentals
            const recentRentalsTable = document.getElementById('recentRentalsTable');
            recentRentalsTable.innerHTML = '';
            
            const recentRentals = rentals.slice(-5).reverse();
            recentRentals.forEach(rental => {
                const customer = customers.find(c => c.id === rental.customerId);
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${rental.startDate}</td>
                    <td>${rental.amount} AED</td>
                    <td><span class="badge ${rental.status === 'Active' ? 'bg-warning' : 'bg-success'}">${rental.status}</span></td>
                `;
                recentRentalsTable.appendChild(row);
            });
            
            // Create vehicle status chart
            createVehicleStatusChart(availableVehicles, rentedVehicles);
        }
        
        // Create vehicle status chart
        function createVehicleStatusChart(available, rented) {
            const ctx = document.getElementById('vehicleStatusChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (window.vehicleStatusChart) {
                window.vehicleStatusChart.destroy();
            }
            
            window.vehicleStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Rented'],
                    datasets: [{
                        data: [available, rented],
                        backgroundColor: ['#28a745', '#ffc107'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        // Load vehicle list
        function loadVehicleList() {
            const vehicleTableBody = document.getElementById('vehicleTableBody');
            vehicleTableBody.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        ${vehicle.image ? `<img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}">` : '<div class="text-muted">No Image</div>'}
                    </td>
                    <td>${vehicle.name}</td>
                    <td>${vehicle.model}</td>
                    <td>${vehicle.color}</td>
                    <td>${vehicle.plate}</td>
                    <td>${vehicle.odometer.toLocaleString()}</td>
                    <td>${vehicle.rentalPrice} AED</td>
                    <td><span class="badge ${vehicle.status === 'Available' ? 'bg-success' : 'bg-warning'}">${vehicle.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary view-vehicle" data-id="${vehicle.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-vehicle" data-id="${vehicle.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-vehicle" data-id="${vehicle.id}">Delete</button>
                    </td>
                `;
                vehicleTableBody.appendChild(row);
            });
            
            // Add event listeners for vehicle actions
            document.querySelectorAll('.view-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    const vehicleId = parseInt(this.getAttribute('data-id'));
                    viewVehicleDetails(vehicleId);
                });
            });
            
            document.querySelectorAll('.edit-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    const vehicleId = parseInt(this.getAttribute('data-id'));
                    editVehicle(vehicleId);
                });
            });
            
            document.querySelectorAll('.delete-vehicle').forEach(button => {
                button.addEventListener('click', function() {
                    const vehicleId = parseInt(this.getAttribute('data-id'));
                    deleteVehicle(vehicleId);
                });
            });
            
            // Vehicle search
            document.getElementById('vehicleSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('vehicleSearch').value.toLowerCase();
                filterVehicleList(searchTerm);
            });
            
            document.getElementById('vehicleSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterVehicleList(searchTerm);
            });
        }
        
        // Filter vehicle list
        function filterVehicleList(searchTerm) {
            const rows = document.querySelectorAll('#vehicleTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View vehicle details
        function viewVehicleDetails(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const detailsContent = document.getElementById('vehicleDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        ${vehicle.image ? `<img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}" style="max-width: 100%;">` : '<div class="text-muted">No Image Available</div>'}
                    </div>
                    <div class="col-md-6">
                        <p><strong>Name:</strong> ${vehicle.name}</p>
                        <p><strong>Model:</strong> ${vehicle.model}</p>
                        <p><strong>Color:</strong> ${vehicle.color}</p>
                        <p><strong>Plate Number:</strong> ${vehicle.plate}</p>
                        <p><strong>VIN:</strong> ${vehicle.vin}</p>
                        <p><strong>Odometer:</strong> ${vehicle.odometer.toLocaleString()} km</p>
                        <p><strong>Rental Price:</strong> ${vehicle.rentalPrice} AED/day</p>
                        <p><strong>Status:</strong> <span class="badge ${vehicle.status === 'Available' ? 'bg-success' : 'bg-warning'}">${vehicle.status}</span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Rental History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Invoice Code</th>
                                        <th>Customer</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${getVehicleRentalHistory(vehicleId)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('vehicleDetailsCard').style.display = 'block';
        }
        
        // Get vehicle rental history
        function getVehicleRentalHistory(vehicleId) {
            const vehicleRentals = rentals.filter(r => r.vehicleId === vehicleId);
            let html = '';
            
            if (vehicleRentals.length === 0) {
                html = '<tr><td colspan="5" class="text-center">No rental history</td></tr>';
            } else {
                vehicleRentals.forEach(rental => {
                    const customer = customers.find(c => c.id === rental.customerId);
                    html += `
                        <tr>
                            <td>${rental.invoiceCode}</td>
                            <td>${customer ? customer.fullName : 'N/A'}</td>
                            <td>${rental.startDate}</td>
                            <td>${rental.endDate}</td>
                            <td>${rental.amount} AED</td>
                        </tr>
                    `;
                });
            }
            
            return html;
        }
        
        // Edit vehicle
        function editVehicle(vehicleId) {
            const vehicle = vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Vehicle';
            modalBody.innerHTML = `
                <form id="editVehicleForm">
                    <input type="hidden" id="editVehicleId" value="${vehicle.id}">
                    <div class="mb-3">
                        <label for="editVehicleName" class="form-label">Vehicle Name</label>
                        <input type="text" class="form-control" id="editVehicleName" value="${vehicle.name}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleModel" class="form-label">Model</label>
                        <input type="text" class="form-control" id="editVehicleModel" value="${vehicle.model}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleColor" class="form-label">Color</label>
                        <input type="text" class="form-control" id="editVehicleColor" value="${vehicle.color}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVehiclePlate" class="form-label">Plate Number</label>
                        <input type="text" class="form-control" id="editVehiclePlate" value="${vehicle.plate}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleVin" class="form-label">VIN</label>
                        <input type="text" class="form-control" id="editVehicleVin" value="${vehicle.vin}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleOdometer" class="form-label">Odometer</label>
                        <input type="number" class="form-control" id="editVehicleOdometer" value="${vehicle.odometer}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleRentalPrice" class="form-label">Rental Price (per day)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editVehicleRentalPrice" value="${vehicle.rentalPrice}" required>
                            <span class="input-group-text">AED</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleImage" class="form-label">Vehicle Image</label>
                        <input type="file" class="form-control" id="editVehicleImage" accept="image/*">
                        ${vehicle.image ? `<div class="mt-2"><img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}"></div>` : ''}
                    </div>
                    <div class="mb-3">
                        <label for="editVehicleStatus" class="form-label">Status</label>
                        <select class="form-select" id="editVehicleStatus" required>
                            <option value="Available" ${vehicle.status === 'Available' ? 'selected' : ''}>Available</option>
                            <option value="Rented" ${vehicle.status === 'Rented' ? 'selected' : ''}>Rented</option>
                            <option value="Maintenance" ${vehicle.status === 'Maintenance' ? 'selected' : ''}>Maintenance</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editVehicleForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editVehicleId').value);
                const name = document.getElementById('editVehicleName').value;
                const model = document.getElementById('editVehicleModel').value;
                const color = document.getElementById('editVehicleColor').value;
                const plate = document.getElementById('editVehiclePlate').value;
                const vin = document.getElementById('editVehicleVin').value;
                const odometer = parseInt(document.getElementById('editVehicleOdometer').value);
                const rentalPrice = parseFloat(document.getElementById('editVehicleRentalPrice').value);
                const status = document.getElementById('editVehicleStatus').value;
                const imageFile = document.getElementById('editVehicleImage').files[0];
                
                const vehicleIndex = vehicles.findIndex(v => v.id === id);
                if (vehicleIndex !== -1) {
                    let imageDataUrl = vehicles[vehicleIndex].image;
                    
                    if (imageFile) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            imageDataUrl = e.target.result;
                            completeEditVehicle(id, name, model, color, plate, vin, odometer, rentalPrice, status, imageDataUrl, editModal);
                        };
                        reader.readAsDataURL(imageFile);
                    } else {
                        completeEditVehicle(id, name, model, color, plate, vin, odometer, rentalPrice, status, imageDataUrl, editModal);
                    }
                }
            });
        }
        
        // Complete edit vehicle after image processing
        function completeEditVehicle(id, name, model, color, plate, vin, odometer, rentalPrice, status, imageDataUrl, editModal) {
            const vehicleIndex = vehicles.findIndex(v => v.id === id);
            if (vehicleIndex !== -1) {
                vehicles[vehicleIndex] = {
                    ...vehicles[vehicleIndex],
                    name: name,
                    model: model,
                    color: color,
                    plate: plate,
                    vin: vin,
                    odometer: odometer,
                    rentalPrice: rentalPrice,
                    image: imageDataUrl,
                    status: status
                };
                
                alert('Vehicle updated successfully');
                editModal.hide();
                loadVehicleList();
                
                // If vehicle details are open, refresh them
                if (document.getElementById('vehicleDetailsCard').style.display === 'block') {
                    viewVehicleDetails(id);
                }
            }
        }
        
        // Delete vehicle
        function deleteVehicle(vehicleId) {
            if (confirm('Are you sure you want to delete this vehicle?')) {
                const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
                if (vehicleIndex !== -1) {
                    // Check if vehicle is currently rented
                    const isRented = rentals.some(r => r.vehicleId === vehicleId && r.status === 'Active');
                    
                    if (isRented) {
                        alert('Cannot delete a vehicle that is currently rented');
                        return;
                    }
                    
                    vehicles.splice(vehicleIndex, 1);
                    alert('Vehicle deleted successfully');
                    loadVehicleList();
                    
                    // Hide details if they were showing for this vehicle
                    document.getElementById('vehicleDetailsCard').style.display = 'none';
                }
            }
        }
        
        // Close vehicle details
        document.getElementById('closeVehicleDetails').addEventListener('click', function() {
            document.getElementById('vehicleDetailsCard').style.display = 'none';
        });
        
        // Load customer list
        function loadCustomerList() {
            const customerTableBody = document.getElementById('customerTableBody');
            customerTableBody.innerHTML = '';
            
            customers.forEach(customer => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer.fullName}</td>
                    <td>${customer.age}</td>
                    <td>${customer.idNumber}</td>
                    <td>${customer.nationality}</td>
                    <td>${customer.contact}</td>
                    <td>${customer.totalDebt} AED</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-customer" data-id="${customer.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-customer" data-id="${customer.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-customer" data-id="${customer.id}">Delete</button>
                    </td>
                `;
                customerTableBody.appendChild(row);
            });
            
            // Add event listeners for customer actions
            document.querySelectorAll('.view-customer').forEach(button => {
                button.addEventListener('click', function() {
                    const customerId = parseInt(this.getAttribute('data-id'));
                    viewCustomerDetails(customerId);
                });
            });
            
            document.querySelectorAll('.edit-customer').forEach(button => {
                button.addEventListener('click', function() {
                    const customerId = parseInt(this.getAttribute('data-id'));
                    editCustomer(customerId);
                });
            });
            
            document.querySelectorAll('.delete-customer').forEach(button => {
                button.addEventListener('click', function() {
                    const customerId = parseInt(this.getAttribute('data-id'));
                    deleteCustomer(customerId);
                });
            });
            
            // Customer search
            document.getElementById('customerSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
                filterCustomerList(searchTerm);
            });
            
            document.getElementById('customerSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterCustomerList(searchTerm);
            });
        }
        
        // Filter customer list
        function filterCustomerList(searchTerm) {
            const rows = document.querySelectorAll('#customerTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View customer details
        function viewCustomerDetails(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const detailsContent = document.getElementById('customerDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Full Name:</strong> ${customer.fullName}</p>
                        <p><strong>Age:</strong> ${customer.age}</p>
                        <p><strong>ID Number:</strong> ${customer.idNumber}</p>
                        <p><strong>Nationality:</strong> ${customer.nationality}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Contact:</strong> ${customer.contact}</p>
                        <p><strong>Address:</strong> ${customer.address}</p>
                        <p><strong>Total Debt:</strong> ${customer.totalDebt} AED</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Rental History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Invoice Code</th>
                                        <th>Vehicle</th>
                                        <th>Start Date</th>
                                        <th>End Date</th>
                                        <th>Amount</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${getCustomerRentalHistory(customerId)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Payment History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Amount</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${getCustomerPaymentHistory(customerId)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Fines & Taxes History</h5>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Type</th>
                                        <th>Amount</th>
                                        <th>Reason</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${getCustomerFinesHistory(customerId)}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsCard').style.display = 'block';
        }
        
        // Get customer rental history
        function getCustomerRentalHistory(customerId) {
            const customerRentals = rentals.filter(r => r.customerId === customerId);
            let html = '';
            
            if (customerRentals.length === 0) {
                html = '<tr><td colspan="6" class="text-center">No rental history</td></tr>';
            } else {
                customerRentals.forEach(rental => {
                    const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                    html += `
                        <tr>
                            <td>${rental.invoiceCode}</td>
                            <td>${vehicle ? vehicle.name : 'N/A'}</td>
                            <td>${rental.startDate}</td>
                            <td>${rental.endDate}</td>
                            <td>${rental.amount} AED</td>
                            <td><span class="badge ${rental.status === 'Active' ? 'bg-warning' : 'bg-success'}">${rental.status}</span></td>
                        </tr>
                    `;
                });
            }
            
            return html;
        }
        
        // Get customer payment history
        function getCustomerPaymentHistory(customerId) {
            const customerPayments = payments.filter(p => p.customerId === customerId);
            let html = '';
            
            if (customerPayments.length === 0) {
                html = '<tr><td colspan="3" class="text-center">No payment history</td></tr>';
            } else {
                customerPayments.forEach(payment => {
                    html += `
                        <tr>
                            <td>${payment.date}</td>
                            <td>${payment.amount} AED</td>
                            <td>${payment.notes}</td>
                        </tr>
                    `;
                });
            }
            
            return html;
        }
        
        // Get customer fines history
        function getCustomerFinesHistory(customerId) {
            const customerFines = fines.filter(f => f.customerId === customerId);
            let html = '';
            
            if (customerFines.length === 0) {
                html = '<tr><td colspan="5" class="text-center">No fines/taxes history</td></tr>';
            } else {
                customerFines.forEach(fine => {
                    html += `
                        <tr>
                            <td>${fine.date}</td>
                            <td>${fine.type}</td>
                            <td>${fine.amount} AED</td>
                            <td>${fine.reason}</td>
                            <td><span class="badge ${fine.status === 'Paid' ? 'bg-success' : 'bg-danger'}">${fine.status}</span></td>
                        </tr>
                    `;
                });
            }
            
            return html;
        }
        
        // Edit customer
        function editCustomer(customerId) {
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Customer';
            modalBody.innerHTML = `
                <form id="editCustomerForm">
                    <input type="hidden" id="editCustomerId" value="${customer.id}">
                    <div class="mb-3">
                        <label for="editCustomerFullName" class="form-label">Full Name</label>
                        <input type="text" class="form-control" id="editCustomerFullName" value="${customer.fullName}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerAge" class="form-label">Age</label>
                        <input type="number" class="form-control" id="editCustomerAge" value="${customer.age}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerId" class="form-label">ID Number</label>
                        <input type="text" class="form-control" id="editCustomerId" value="${customer.idNumber}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerNationality" class="form-label">Nationality</label>
                        <input type="text" class="form-control" id="editCustomerNationality" value="${customer.nationality}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerContact" class="form-label">Contact</label>
                        <input type="text" class="form-control" id="editCustomerContact" value="${customer.contact}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editCustomerAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="editCustomerAddress" value="${customer.address}" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editCustomerForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editCustomerId').value);
                const fullName = document.getElementById('editCustomerFullName').value;
                const age = parseInt(document.getElementById('editCustomerAge').value);
                const idNumber = document.getElementById('editCustomerId').value;
                const nationality = document.getElementById('editCustomerNationality').value;
                const contact = document.getElementById('editCustomerContact').value;
                const address = document.getElementById('editCustomerAddress').value;
                
                const customerIndex = customers.findIndex(c => c.id === id);
                if (customerIndex !== -1) {
                    customers[customerIndex] = {
                        ...customers[customerIndex],
                        fullName: fullName,
                        age: age,
                        idNumber: idNumber,
                        nationality: nationality,
                        contact: contact,
                        address: address
                    };
                    
                    alert('Customer updated successfully');
                    editModal.hide();
                    loadCustomerList();
                    
                    // If customer details are open, refresh them
                    if (document.getElementById('customerDetailsCard').style.display === 'block') {
                        viewCustomerDetails(id);
                    }
                }
            });
        }
        
        // Delete customer
        function deleteCustomer(customerId) {
            if (confirm('Are you sure you want to delete this customer?')) {
                // Check if customer has active rentals
                const hasActiveRentals = rentals.some(r => r.customerId === customerId && r.status === 'Active');
                
                if (hasActiveRentals) {
                    alert('Cannot delete a customer with active rentals');
                    return;
                }
                
                const customerIndex = customers.findIndex(c => c.id === customerId);
                if (customerIndex !== -1) {
                    customers.splice(customerIndex, 1);
                    alert('Customer deleted successfully');
                    loadCustomerList();
                    
                    // Hide details if they were showing for this customer
                    document.getElementById('customerDetailsCard').style.display = 'none';
                }
            }
        }
        
        // Close customer details
        document.getElementById('closeCustomerDetails').addEventListener('click', function() {
            document.getElementById('customerDetailsCard').style.display = 'none';
        });
        
        // Load rental list
        function loadRentalList() {
            const rentalTableBody = document.getElementById('rentalTableBody');
            rentalTableBody.innerHTML = '';
            
            rentals.forEach(rental => {
                const customer = customers.find(c => c.id === rental.customerId);
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rental.invoiceCode}</td>
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${rental.startDate}</td>
                    <td>${rental.endDate}</td>
                    <td>${rental.amount} AED</td>
                    <td><span class="badge ${rental.status === 'Active' ? 'bg-warning' : 'bg-success'}">${rental.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary view-rental" data-id="${rental.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-rental" data-id="${rental.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-rental" data-id="${rental.id}">Delete</button>
                    </td>
                `;
                rentalTableBody.appendChild(row);
            });
            
            // Add event listeners for rental actions
            document.querySelectorAll('.view-rental').forEach(button => {
                button.addEventListener('click', function() {
                    const rentalId = parseInt(this.getAttribute('data-id'));
                    viewRentalDetails(rentalId);
                });
            });
            
            document.querySelectorAll('.edit-rental').forEach(button => {
                button.addEventListener('click', function() {
                    const rentalId = parseInt(this.getAttribute('data-id'));
                    editRental(rentalId);
                });
            });
            
            document.querySelectorAll('.delete-rental').forEach(button => {
                button.addEventListener('click', function() {
                    const rentalId = parseInt(this.getAttribute('data-id'));
                    deleteRental(rentalId);
                });
            });
            
            // Rental search
            document.getElementById('rentalSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('rentalSearch').value.toUpperCase();
                filterRentalList(searchTerm);
            });
            
            document.getElementById('rentalSearch').addEventListener('input', function() {
                const searchTerm = this.value.toUpperCase();
                filterRentalList(searchTerm);
            });
        }
        
        // Filter rental list
        function filterRentalList(searchTerm) {
            const rows = document.querySelectorAll('#rentalTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toUpperCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View rental details
        function viewRentalDetails(rentalId) {
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Rental Details';
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Invoice Code:</strong> ${rental.invoiceCode}</p>
                        <p><strong>Customer:</strong> ${customer ? customer.fullName : 'N/A'}</p>
                        <p><strong>Vehicle:</strong> ${vehicle ? vehicle.name : 'N/A'}</p>
                        <p><strong>Start Date:</strong> ${rental.startDate}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>End Date:</strong> ${rental.endDate}</p>
                        <p><strong>Amount:</strong> ${rental.amount} AED</p>
                        <p><strong>Status:</strong> <span class="badge ${rental.status === 'Active' ? 'bg-warning' : 'bg-success'}">${rental.status}</span></p>
                    </div>
                </div>
                ${rental.status === 'Completed' ? `
                <div class="row mt-3">
                    <div class="col-12">
                        <h5>Return Information</h5>
                        ${getReturnInfo(rentalId)}
                    </div>
                </div>
                ` : ''}
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }
        
        // Get return information
        function getReturnInfo(rentalId) {
            const returnRecord = returns.find(r => r.rentalId === rentalId);
            
            if (returnRecord) {
                return `
                    <p><strong>Actual Return Date:</strong> ${returnRecord.actualReturnDate}</p>
                    <p><strong>Fine:</strong> ${returnRecord.fine} AED</p>
                    <p><strong>Notes:</strong> ${returnRecord.notes}</p>
                `;
            } else {
                return '<p>No return information available</p>';
            }
        }
        
        // Edit rental
        function editRental(rentalId) {
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Rental';
            modalBody.innerHTML = `
                <form id="editRentalForm">
                    <input type="hidden" id="editRentalId" value="${rental.id}">
                    <div class="mb-3">
                        <label for="editRentalInvoiceCode" class="form-label">Invoice Code</label>
                        <input type="text" class="form-control" id="editRentalInvoiceCode" value="${rental.invoiceCode}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRentalCustomer" class="form-label">Customer</label>
                        <input type="text" class="form-control" id="editRentalCustomer" value="${customer ? customer.fullName : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editRentalVehicle" class="form-label">Vehicle</label>
                        <input type="text" class="form-control" id="editRentalVehicle" value="${vehicle ? vehicle.name : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editRentalStartDate" class="form-label">Start Date</label>
                        <input type="date" class="form-control" id="editRentalStartDate" value="${rental.startDate}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRentalEndDate" class="form-label">End Date</label>
                        <input type="date" class="form-control" id="editRentalEndDate" value="${rental.endDate}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRentalAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editRentalAmount" value="${rental.amount}" required>
                            <span class="input-group-text">AED</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editRentalStatus" class="form-label">Status</label>
                        <select class="form-select" id="editRentalStatus" required>
                            <option value="Active" ${rental.status === 'Active' ? 'selected' : ''}>Active</option>
                            <option value="Completed" ${rental.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Cancelled" ${rental.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editRentalForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editRentalId').value);
                const invoiceCode = document.getElementById('editRentalInvoiceCode').value;
                const startDate = document.getElementById('editRentalStartDate').value;
                const endDate = document.getElementById('editRentalEndDate').value;
                const amount = parseFloat(document.getElementById('editRentalAmount').value);
                const status = document.getElementById('editRentalStatus').value;
                
                const rentalIndex = rentals.findIndex(r => r.id === id);
                if (rentalIndex !== -1) {
                    rentals[rentalIndex] = {
                        ...rentals[rentalIndex],
                        invoiceCode: invoiceCode,
                        startDate: startDate,
                        endDate: endDate,
                        amount: amount,
                        status: status
                    };
                    
                    alert('Rental updated successfully');
                    editModal.hide();
                    loadRentalList();
                }
            });
        }
        
        // Delete rental
        function deleteRental(rentalId) {
            if (confirm('Are you sure you want to delete this rental?')) {
                const rentalIndex = rentals.findIndex(r => r.id === rentalId);
                if (rentalIndex !== -1) {
                    // If rental is active, make the vehicle available again
                    if (rentals[rentalIndex].status === 'Active') {
                        const vehicle = vehicles.find(v => v.id === rentals[rentalIndex].vehicleId);
                        if (vehicle) {
                            vehicle.status = 'Available';
                        }
                    }
                    
                    rentals.splice(rentalIndex, 1);
                    alert('Rental deleted successfully');
                    loadRentalList();
                    loadVehicleList();
                }
            }
        }
        
        // Load return history
        function loadReturnHistory() {
            const returnHistoryTableBody = document.getElementById('returnHistoryTableBody');
            returnHistoryTableBody.innerHTML = '';
            
            returns.forEach(returnRecord => {
                const rental = rentals.find(r => r.id === returnRecord.rentalId);
                if (!rental) return;
                
                const customer = customers.find(c => c.id === rental.customerId);
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                
                // Calculate rental days
                const startDate = new Date(rental.startDate);
                const returnDate = new Date(returnRecord.actualReturnDate);
                const rentalDays = Math.ceil((returnDate - startDate) / (1000 * 60 * 60 * 24));
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rental.invoiceCode}</td>
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${rental.startDate}</td>
                    <td>${returnRecord.actualReturnDate}</td>
                    <td>${rentalDays}</td>
                    <td>${rental.amount + returnRecord.fine} AED</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-return" data-id="${returnRecord.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-return" data-id="${returnRecord.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-return" data-id="${returnRecord.id}">Delete</button>
                    </td>
                `;
                returnHistoryTableBody.appendChild(row);
            });
            
            // Add event listeners for return actions
            document.querySelectorAll('.view-return').forEach(button => {
                button.addEventListener('click', function() {
                    const returnId = parseInt(this.getAttribute('data-id'));
                    viewReturnDetails(returnId);
                });
            });
            
            document.querySelectorAll('.edit-return').forEach(button => {
                button.addEventListener('click', function() {
                    const returnId = parseInt(this.getAttribute('data-id'));
                    editReturn(returnId);
                });
            });
            
            document.querySelectorAll('.delete-return').forEach(button => {
                button.addEventListener('click', function() {
                    const returnId = parseInt(this.getAttribute('data-id'));
                    deleteReturn(returnId);
                });
            });
            
            // Return history search
            document.getElementById('returnHistorySearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('returnHistorySearch').value.toLowerCase();
                filterReturnHistory(searchTerm);
            });
            
            document.getElementById('returnHistorySearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterReturnHistory(searchTerm);
            });
        }
        
        // Filter return history
        function filterReturnHistory(searchTerm) {
            const rows = document.querySelectorAll('#returnHistoryTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View return details
        function viewReturnDetails(returnId) {
            const returnRecord = returns.find(r => r.id === returnId);
            if (!returnRecord) return;
            
            const rental = rentals.find(r => r.id === returnRecord.rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Return Details';
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Invoice Code:</strong> ${rental.invoiceCode}</p>
                        <p><strong>Customer:</strong> ${customer ? customer.fullName : 'N/A'}</p>
                        <p><strong>Vehicle:</strong> ${vehicle ? vehicle.name : 'N/A'}</p>
                        <p><strong>Rental Start Date:</strong> ${rental.startDate}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Expected Return Date:</strong> ${rental.endDate}</p>
                        <p><strong>Actual Return Date:</strong> ${returnRecord.actualReturnDate}</p>
                        <p><strong>Rental Amount:</strong> ${rental.amount} AED</p>
                        <p><strong>Fine:</strong> ${returnRecord.fine} AED</p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Notes:</strong> ${returnRecord.notes}</p>
                    </div>
                </div>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }
        
        // Edit return
        function editReturn(returnId) {
            const returnRecord = returns.find(r => r.id === returnId);
            if (!returnRecord) return;
            
            const rental = rentals.find(r => r.id === returnRecord.rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Return';
            modalBody.innerHTML = `
                <form id="editReturnForm">
                    <input type="hidden" id="editReturnId" value="${returnRecord.id}">
                    <div class="mb-3">
                        <label for="editReturnInvoiceCode" class="form-label">Invoice Code</label>
                        <input type="text" class="form-control" id="editReturnInvoiceCode" value="${rental.invoiceCode}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editReturnCustomer" class="form-label">Customer</label>
                        <input type="text" class="form-control" id="editReturnCustomer" value="${customer ? customer.fullName : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editReturnVehicle" class="form-label">Vehicle</label>
                        <input type="text" class="form-control" id="editReturnVehicle" value="${vehicle ? vehicle.name : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editReturnActualDate" class="form-label">Actual Return Date</label>
                        <input type="date" class="form-control" id="editReturnActualDate" value="${returnRecord.actualReturnDate}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editReturnFine" class="form-label">Fine</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editReturnFine" value="${returnRecord.fine}" required>
                            <span class="input-group-text">AED</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editReturnNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editReturnNotes" rows="3">${returnRecord.notes}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editReturnForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editReturnId').value);
                const actualReturnDate = document.getElementById('editReturnActualDate').value;
                const fine = parseFloat(document.getElementById('editReturnFine').value);
                const notes = document.getElementById('editReturnNotes').value;
                
                const returnIndex = returns.findIndex(r => r.id === id);
                if (returnIndex !== -1) {
                    // Update customer debt if fine changed
                    const oldFine = returns[returnIndex].fine;
                    if (fine !== oldFine) {
                        const rental = rentals.find(r => r.id === returns[returnIndex].rentalId);
                        if (rental) {
                            const customer = customers.find(c => c.id === rental.customerId);
                            if (customer) {
                                customer.totalDebt = customer.totalDebt - oldFine + fine;
                            }
                        }
                    }
                    
                    returns[returnIndex] = {
                        ...returns[returnIndex],
                        actualReturnDate: actualReturnDate,
                        fine: fine,
                        notes: notes
                    };
                    
                    alert('Return updated successfully');
                    editModal.hide();
                    loadReturnHistory();
                    loadCustomerList();
                }
            });
        }
        
        // Delete return
        function deleteReturn(returnId) {
            if (confirm('Are you sure you want to delete this return record?')) {
                const returnIndex = returns.findIndex(r => r.id === returnId);
                if (returnIndex !== -1) {
                    // Update rental status back to active
                    const rentalId = returns[returnIndex].rentalId;
                    const rentalIndex = rentals.findIndex(r => r.id === rentalId);
                    if (rentalIndex !== -1) {
                        rentals[rentalIndex].status = 'Active';
                    }
                    
                    // Update vehicle status back to rented
                    const vehicleId = rentals[rentalIndex].vehicleId;
                    const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
                    if (vehicleIndex !== -1) {
                        vehicles[vehicleIndex].status = 'Rented';
                    }
                    
                    // Update customer debt
                    const fine = returns[returnIndex].fine;
                    if (fine > 0) {
                        const customerId = rentals[rentalIndex].customerId;
                        const customerIndex = customers.findIndex(c => c.id === customerId);
                        if (customerIndex !== -1) {
                            customers[customerIndex].totalDebt -= fine;
                        }
                    }
                    
                    returns.splice(returnIndex, 1);
                    alert('Return record deleted successfully');
                    loadReturnHistory();
                    loadRentalList();
                    loadVehicleList();
                    loadCustomerList();
                }
            }
        }
        
        // Load return form
        function loadReturnForm(rentalId) {
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            
            document.getElementById('returnCustomer').value = customer ? customer.fullName : 'N/A';
            document.getElementById('returnVehicle').value = vehicle ? vehicle.name : 'N/A';
            document.getElementById('returnRentalStartDate').value = rental.startDate;
            document.getElementById('returnExpectedDate').value = rental.endDate;
            document.getElementById('returnActualDate').value = new Date().toISOString().split('T')[0];
            
            document.getElementById('returnFormContainer').style.display = 'block';
        }
        
        // Load maintenance list
        function loadMaintenanceList() {
            const maintenanceTableBody = document.getElementById('maintenanceTableBody');
            maintenanceTableBody.innerHTML = '';
            
            maintenance.forEach(maintenanceRecord => {
                const vehicle = vehicles.find(v => v.id === maintenanceRecord.vehicleId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${maintenanceRecord.type}</td>
                    <td>${maintenanceRecord.date}</td>
                    <td>${maintenanceRecord.cost} AED</td>
                    <td><span class="badge ${maintenanceRecord.status === 'Completed' ? 'bg-success' : 'bg-warning'}">${maintenanceRecord.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary view-maintenance" data-id="${maintenanceRecord.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-maintenance" data-id="${maintenanceRecord.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-maintenance" data-id="${maintenanceRecord.id}">Delete</button>
                    </td>
                `;
                maintenanceTableBody.appendChild(row);
            });
            
            // Add event listeners for maintenance actions
            document.querySelectorAll('.view-maintenance').forEach(button => {
                button.addEventListener('click', function() {
                    const maintenanceId = parseInt(this.getAttribute('data-id'));
                    viewMaintenanceDetails(maintenanceId);
                });
            });
            
            document.querySelectorAll('.edit-maintenance').forEach(button => {
                button.addEventListener('click', function() {
                    const maintenanceId = parseInt(this.getAttribute('data-id'));
                    editMaintenance(maintenanceId);
                });
            });
            
            document.querySelectorAll('.delete-maintenance').forEach(button => {
                button.addEventListener('click', function() {
                    const maintenanceId = parseInt(this.getAttribute('data-id'));
                    deleteMaintenance(maintenanceId);
                });
            });
            
            // Maintenance search
            document.getElementById('maintenanceSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('maintenanceSearch').value.toLowerCase();
                filterMaintenanceList(searchTerm);
            });
            
            document.getElementById('maintenanceSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterMaintenanceList(searchTerm);
            });
        }
        
        // Filter maintenance list
        function filterMaintenanceList(searchTerm) {
            const rows = document.querySelectorAll('#maintenanceTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View maintenance details
        function viewMaintenanceDetails(maintenanceId) {
            const maintenanceRecord = maintenance.find(m => m.id === maintenanceId);
            if (!maintenanceRecord) return;
            
            const vehicle = vehicles.find(v => v.id === maintenanceRecord.vehicleId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Maintenance Details';
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Vehicle:</strong> ${vehicle ? vehicle.name : 'N/A'}</p>
                        <p><strong>Type:</strong> ${maintenanceRecord.type}</p>
                        <p><strong>Date:</strong> ${maintenanceRecord.date}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Cost:</strong> ${maintenanceRecord.cost} AED</p>
                        <p><strong>Status:</strong> <span class="badge ${maintenanceRecord.status === 'Completed' ? 'bg-success' : 'bg-warning'}">${maintenanceRecord.status}</span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Notes:</strong> ${maintenanceRecord.notes}</p>
                    </div>
                </div>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }
        
        // Edit maintenance
        function editMaintenance(maintenanceId) {
            const maintenanceRecord = maintenance.find(m => m.id === maintenanceId);
            if (!maintenanceRecord) return;
            
            const vehicle = vehicles.find(v => v.id === maintenanceRecord.vehicleId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Maintenance';
            modalBody.innerHTML = `
                <form id="editMaintenanceForm">
                    <input type="hidden" id="editMaintenanceId" value="${maintenanceRecord.id}">
                    <div class="mb-3">
                        <label for="editMaintenanceVehicle" class="form-label">Vehicle</label>
                        <input type="text" class="form-control" id="editMaintenanceVehicle" value="${vehicle ? vehicle.name : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editMaintenanceType" class="form-label">Type</label>
                        <select class="form-select" id="editMaintenanceType" required>
                            <option value="Oil Change" ${maintenanceRecord.type === 'Oil Change' ? 'selected' : ''}>Oil Change</option>
                            <option value="Tire Replacement" ${maintenanceRecord.type === 'Tire Replacement' ? 'selected' : ''}>Tire Replacement</option>
                            <option value="Brake Service" ${maintenanceRecord.type === 'Brake Service' ? 'selected' : ''}>Brake Service</option>
                            <option value="Engine Tune-up" ${maintenanceRecord.type === 'Engine Tune-up' ? 'selected' : ''}>Engine Tune-up</option>
                            <option value="Other" ${maintenanceRecord.type === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editMaintenanceDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editMaintenanceDate" value="${maintenanceRecord.date}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editMaintenanceCost" class="form-label">Cost</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editMaintenanceCost" value="${maintenanceRecord.cost}" required>
                            <span class="input-group-text">AED</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editMaintenanceStatus" class="form-label">Status</label>
                        <select class="form-select" id="editMaintenanceStatus" required>
                            <option value="Scheduled" ${maintenanceRecord.status === 'Scheduled' ? 'selected' : ''}>Scheduled</option>
                            <option value="In Progress" ${maintenanceRecord.status === 'In Progress' ? 'selected' : ''}>In Progress</option>
                            <option value="Completed" ${maintenanceRecord.status === 'Completed' ? 'selected' : ''}>Completed</option>
                            <option value="Cancelled" ${maintenanceRecord.status === 'Cancelled' ? 'selected' : ''}>Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editMaintenanceNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editMaintenanceNotes" rows="3">${maintenanceRecord.notes}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editMaintenanceForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editMaintenanceId').value);
                const type = document.getElementById('editMaintenanceType').value;
                const date = document.getElementById('editMaintenanceDate').value;
                const cost = parseFloat(document.getElementById('editMaintenanceCost').value);
                const status = document.getElementById('editMaintenanceStatus').value;
                const notes = document.getElementById('editMaintenanceNotes').value;
                
                const maintenanceIndex = maintenance.findIndex(m => m.id === id);
                if (maintenanceIndex !== -1) {
                    maintenance[maintenanceIndex] = {
                        ...maintenance[maintenanceIndex],
                        type: type,
                        date: date,
                        cost: cost,
                        status: status,
                        notes: notes
                    };
                    
                    alert('Maintenance updated successfully');
                    editModal.hide();
                    loadMaintenanceList();
                }
            });
        }
        
        // Delete maintenance
        function deleteMaintenance(maintenanceId) {
            if (confirm('Are you sure you want to delete this maintenance record?')) {
                const maintenanceIndex = maintenance.findIndex(m => m.id === maintenanceId);
                if (maintenanceIndex !== -1) {
                    maintenance.splice(maintenanceIndex, 1);
                    alert('Maintenance record deleted successfully');
                    loadMaintenanceList();
                }
            }
        }
        
        // Load payment list
        function loadPaymentList() {
            const paymentTableBody = document.getElementById('paymentTableBody');
            paymentTableBody.innerHTML = '';
            
            payments.forEach(payment => {
                const customer = customers.find(c => c.id === payment.customerId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${payment.amount} AED</td>
                    <td>${payment.date}</td>
                    <td>${payment.notes}</td>
                    <td>
                        <button class="btn btn-sm btn-primary view-payment" data-id="${payment.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-payment" data-id="${payment.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-payment" data-id="${payment.id}">Delete</button>
                    </td>
                `;
                paymentTableBody.appendChild(row);
            });
            
            // Add event listeners for payment actions
            document.querySelectorAll('.view-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const paymentId = parseInt(this.getAttribute('data-id'));
                    viewPaymentDetails(paymentId);
                });
            });
            
            document.querySelectorAll('.edit-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const paymentId = parseInt(this.getAttribute('data-id'));
                    editPayment(paymentId);
                });
            });
            
            document.querySelectorAll('.delete-payment').forEach(button => {
                button.addEventListener('click', function() {
                    const paymentId = parseInt(this.getAttribute('data-id'));
                    deletePayment(paymentId);
                });
            });
            
            // Payment search
            document.getElementById('paymentSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('paymentSearch').value.toLowerCase();
                filterPaymentList(searchTerm);
            });
            
            document.getElementById('paymentSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterPaymentList(searchTerm);
            });
        }
        
        // Filter payment list
        function filterPaymentList(searchTerm) {
            const rows = document.querySelectorAll('#paymentTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View payment details
        function viewPaymentDetails(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const customer = customers.find(c => c.id === payment.customerId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Payment Details';
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Customer:</strong> ${customer ? customer.fullName : 'N/A'}</p>
                        <p><strong>Amount:</strong> ${payment.amount} AED</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Date:</strong> ${payment.date}</p>
                        <p><strong>Notes:</strong> ${payment.notes}</p>
                    </div>
                </div>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }
        
        // Edit payment
        function editPayment(paymentId) {
            const payment = payments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const customer = customers.find(c => c.id === payment.customerId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Payment';
            modalBody.innerHTML = `
                <form id="editPaymentForm">
                    <input type="hidden" id="editPaymentId" value="${payment.id}">
                    <div class="mb-3">
                        <label for="editPaymentCustomer" class="form-label">Customer</label>
                        <input type="text" class="form-control" id="editPaymentCustomer" value="${customer ? customer.fullName : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editPaymentAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editPaymentAmount" value="${payment.amount}" required>
                            <span class="input-group-text">AED</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editPaymentDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editPaymentDate" value="${payment.date}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editPaymentNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editPaymentNotes" rows="3">${payment.notes}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editPaymentForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editPaymentId').value);
                const amount = parseFloat(document.getElementById('editPaymentAmount').value);
                const date = document.getElementById('editPaymentDate').value;
                const notes = document.getElementById('editPaymentNotes').value;
                
                const paymentIndex = payments.findIndex(p => p.id === id);
                if (paymentIndex !== -1) {
                    // Update customer debt if amount changed
                    const oldAmount = payments[paymentIndex].amount;
                    if (amount !== oldAmount) {
                        const customer = customers.find(c => c.id === payments[paymentIndex].customerId);
                        if (customer) {
                            customer.totalDebt = customer.totalDebt + oldAmount - amount;
                        }
                    }
                    
                    payments[paymentIndex] = {
                        ...payments[paymentIndex],
                        amount: amount,
                        date: date,
                        notes: notes
                    };
                    
                    alert('Payment updated successfully');
                    editModal.hide();
                    loadPaymentList();
                    loadCustomerList();
                }
            });
        }
        
        // Delete payment
        function deletePayment(paymentId) {
            if (confirm('Are you sure you want to delete this payment record?')) {
                const paymentIndex = payments.findIndex(p => p.id === paymentId);
                if (paymentIndex !== -1) {
                    // Update customer debt
                    const customer = customers.find(c => c.id === payments[paymentIndex].customerId);
                    if (customer) {
                        customer.totalDebt += payments[paymentIndex].amount;
                    }
                    
                    payments.splice(paymentIndex, 1);
                    alert('Payment record deleted successfully');
                    loadPaymentList();
                    loadCustomerList();
                }
            }
        }
        
        // Load fine list
        function loadFineList() {
            const fineTableBody = document.getElementById('fineTableBody');
            fineTableBody.innerHTML = '';
            
            fines.forEach(fine => {
                const customer = customers.find(c => c.id === fine.customerId);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${fine.type}</td>
                    <td>${fine.amount} AED</td>
                    <td>${fine.date}</td>
                    <td>${fine.reason}</td>
                    <td><span class="badge ${fine.status === 'Paid' ? 'bg-success' : 'bg-danger'}">${fine.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary view-fine" data-id="${fine.id}">View</button>
                        <button class="btn btn-sm btn-warning edit-fine" data-id="${fine.id}">Edit</button>
                        <button class="btn btn-sm btn-danger delete-fine" data-id="${fine.id}">Delete</button>
                    </td>
                `;
                fineTableBody.appendChild(row);
            });
            
            // Add event listeners for fine actions
            document.querySelectorAll('.view-fine').forEach(button => {
                button.addEventListener('click', function() {
                    const fineId = parseInt(this.getAttribute('data-id'));
                    viewFineDetails(fineId);
                });
            });
            
            document.querySelectorAll('.edit-fine').forEach(button => {
                button.addEventListener('click', function() {
                    const fineId = parseInt(this.getAttribute('data-id'));
                    editFine(fineId);
                });
            });
            
            document.querySelectorAll('.delete-fine').forEach(button => {
                button.addEventListener('click', function() {
                    const fineId = parseInt(this.getAttribute('data-id'));
                    deleteFine(fineId);
                });
            });
            
            // Fine search
            document.getElementById('fineSearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('fineSearch').value.toLowerCase();
                filterFineList(searchTerm);
            });
            
            document.getElementById('fineSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterFineList(searchTerm);
            });
        }
        
        // Filter fine list
        function filterFineList(searchTerm) {
            const rows = document.querySelectorAll('#fineTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // View fine details
        function viewFineDetails(fineId) {
            const fine = fines.find(f => f.id === fineId);
            if (!fine) return;
            
            const customer = customers.find(c => c.id === fine.customerId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Fine/Tax Details';
            modalBody.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Customer:</strong> ${customer ? customer.fullName : 'N/A'}</p>
                        <p><strong>Type:</strong> ${fine.type}</p>
                        <p><strong>Amount:</strong> ${fine.amount} AED</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Date:</strong> ${fine.date}</p>
                        <p><strong>Status:</strong> <span class="badge ${fine.status === 'Paid' ? 'bg-success' : 'bg-danger'}">${fine.status}</span></p>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <p><strong>Reason:</strong> ${fine.reason}</p>
                    </div>
                </div>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
        }
        
        // Edit fine
        function editFine(fineId) {
            const fine = fines.find(f => f.id === fineId);
            if (!fine) return;
            
            const customer = customers.find(c => c.id === fine.customerId);
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit Fine/Tax';
            modalBody.innerHTML = `
                <form id="editFineForm">
                    <input type="hidden" id="editFineId" value="${fine.id}">
                    <div class="mb-3">
                        <label for="editFineCustomer" class="form-label">Customer</label>
                        <input type="text" class="form-control" id="editFineCustomer" value="${customer ? customer.fullName : 'N/A'}" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="editFineType" class="form-label">Type</label>
                        <select class="form-select" id="editFineType" required>
                            <option value="Fine" ${fine.type === 'Fine' ? 'selected' : ''}>Fine</option>
                            <option value="Tax" ${fine.type === 'Tax' ? 'selected' : ''}>Tax</option>
                            <option value="Penalty" ${fine.type === 'Penalty' ? 'selected' : ''}>Penalty</option>
                            <option value="Salik" ${fine.type === 'Salik' ? 'selected' : ''}>Salik</option>
                            <option value="Parking" ${fine.type === 'Parking' ? 'selected' : ''}>Parking</option>
                            <option value="Car Wash" ${fine.type === 'Car Wash' ? 'selected' : ''}>Car Wash</option>
                            <option value="Fuel" ${fine.type === 'Fuel' ? 'selected' : ''}>Fuel</option>
                            <option value="Delivery fees" ${fine.type === 'Delivery fees' ? 'selected' : ''}>Delivery fees</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editFineAmount" class="form-label">Amount</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="editFineAmount" value="${fine.amount}" required>
                            <span class="input-group-text">AED</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editFineDate" class="form-label">Date</label>
                        <input type="date" class="form-control" id="editFineDate" value="${fine.date}" required>
                    </div>
                    <div class="mb-3">
                        <label for="editFineStatus" class="form-label">Status</label>
                        <select class="form-select" id="editFineStatus" required>
                            <option value="Unpaid" ${fine.status === 'Unpaid' ? 'selected' : ''}>Unpaid</option>
                            <option value="Paid" ${fine.status === 'Paid' ? 'selected' : ''}>Paid</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editFineReason" class="form-label">Reason</label>
                        <textarea class="form-control" id="editFineReason" rows="3" required>${fine.reason}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editFineForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editFineId').value);
                const type = document.getElementById('editFineType').value;
                const amount = parseFloat(document.getElementById('editFineAmount').value);
                const date = document.getElementById('editFineDate').value;
                const status = document.getElementById('editFineStatus').value;
                const reason = document.getElementById('editFineReason').value;
                
                const fineIndex = fines.findIndex(f => f.id === id);
                if (fineIndex !== -1) {
                    // Update customer debt if amount or status changed
                    const customer = customers.find(c => c.id === fines[fineIndex].customerId);
                    if (customer) {
                        const oldAmount = fines[fineIndex].amount;
                        const oldStatus = fines[fineIndex].status;
                        
                        if (oldStatus === 'Unpaid' && status === 'Paid') {
                            customer.totalDebt -= oldAmount;
                        } else if (oldStatus === 'Paid' && status === 'Unpaid') {
                            customer.totalDebt += oldAmount;
                        }
                        
                        if (amount !== oldAmount && status === 'Unpaid') {
                            customer.totalDebt = customer.totalDebt - oldAmount + amount;
                        }
                    }
                    
                    fines[fineIndex] = {
                        ...fines[fineIndex],
                        type: type,
                        amount: amount,
                        date: date,
                        status: status,
                        reason: reason
                    };
                    
                    alert('Fine/Tax updated successfully');
                    editModal.hide();
                    loadFineList();
                    loadCustomerList();
                }
            });
        }
        
        // Delete fine
        function deleteFine(fineId) {
            if (confirm('Are you sure you want to delete this fine/tax record?')) {
                const fineIndex = fines.findIndex(f => f.id === fineId);
                if (fineIndex !== -1) {
                    // Update customer debt if fine was unpaid
                    if (fines[fineIndex].status === 'Unpaid') {
                        const customer = customers.find(c => c.id === fines[fineIndex].customerId);
                        if (customer) {
                            customer.totalDebt -= fines[fineIndex].amount;
                        }
                    }
                    
                    fines.splice(fineIndex, 1);
                    alert('Fine/Tax record deleted successfully');
                    loadFineList();
                    loadCustomerList();
                }
            }
        }
        
        // Load user management
        function loadUserManagement() {
            const userTableBody = document.getElementById('userTableBody');
            userTableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.username}</td>
                    <td><span class="badge ${user.role === 'admin' ? 'bg-primary' : 'bg-secondary'}">${user.role}</span></td>
                    <td>${user.lastLogin ? user.lastLogin.toLocaleString() : 'Never'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning edit-user" data-username="${user.username}">Edit</button>
                        ${user.username !== 'admin' ? `<button class="btn btn-sm btn-danger delete-user" data-username="${user.username}">Delete</button>` : ''}
                    </td>
                `;
                userTableBody.appendChild(row);
            });
            
            // Add event listeners for user actions
            document.querySelectorAll('.edit-user').forEach(button => {
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    editUser(username);
                });
            });
            
            document.querySelectorAll('.delete-user').forEach(button => {
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    deleteUser(username);
                });
            });
        }
        
        // Edit user
        function editUser(username) {
            const user = users.find(u => u.username === username);
            if (!user) return;
            
            const modalTitle = document.getElementById('editModalTitle');
            const modalBody = document.getElementById('editModalBody');
            
            modalTitle.textContent = 'Edit User';
            modalBody.innerHTML = `
                <form id="editUserForm">
                    <input type="hidden" id="editUserUsername" value="${user.username}">
                    <div class="mb-3">
                        <label for="editUserPassword" class="form-label">New Password</label>
                        <input type="password" class="form-control" id="editUserPassword" placeholder="Leave blank to keep current password">
                    </div>
                    <div class="mb-3">
                        <label for="editUserRole" class="form-label">Role</label>
                        <select class="form-select" id="editUserRole" required>
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </form>
            `;
            
            // Show the modal
            const editModal = new bootstrap.Modal(document.getElementById('editModal'));
            editModal.show();
            
            // Handle form submission
            document.getElementById('editUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const username = document.getElementById('editUserUsername').value;
                const password = document.getElementById('editUserPassword').value;
                const role = document.getElementById('editUserRole').value;
                
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex !== -1) {
                    if (password) {
                        users[userIndex].password = password;
                    }
                    users[userIndex].role = role;
                    
                    alert('User updated successfully');
                    editModal.hide();
                    loadUserManagement();
                }
            });
        }
        
        // Delete user
        function deleteUser(username) {
            if (confirm('Are you sure you want to delete this user?')) {
                const userIndex = users.findIndex(u => u.username === username);
                if (userIndex !== -1) {
                    users.splice(userIndex, 1);
                    alert('User deleted successfully');
                    loadUserManagement();
                }
            }
        }
        
        // Generate report
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const customerName = document.getElementById('reportCustomer').value;
            
            let reportData = [];
            let headers = [];
            
            switch (reportType) {
                case 'rental':
                    headers = ['Invoice Code', 'Customer', 'Vehicle', 'Start Date', 'End Date', 'Amount', 'Status'];
                    reportData = rentals.map(rental => {
                        const customer = customers.find(c => c.id === rental.customerId);
                        const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                        return [
                            rental.invoiceCode,
                            customer ? customer.fullName : 'N/A',
                            vehicle ? vehicle.name : 'N/A',
                            rental.startDate,
                            rental.endDate,
                            `${rental.amount} AED`,
                            rental.status
                        ];
                    });
                    break;
                    
                case 'payment':
                    headers = ['Customer', 'Amount', 'Date', 'Notes'];
                    reportData = payments.map(payment => {
                        const customer = customers.find(c => c.id === payment.customerId);
                        return [
                            customer ? customer.fullName : 'N/A',
                            `${payment.amount} AED`,
                            payment.date,
                            payment.notes
                        ];
                    });
                    break;
                    
                case 'vehicle':
                    headers = ['Name', 'Model', 'Color', 'Plate', 'Odometer', 'Rental Price', 'Status'];
                    reportData = vehicles.map(vehicle => [
                        vehicle.name,
                        vehicle.model,
                        vehicle.color,
                        vehicle.plate,
                        vehicle.odometer.toLocaleString(),
                        `${vehicle.rentalPrice} AED`,
                        vehicle.status
                    ]);
                    break;
                    
                case 'customer':
                    headers = ['Full Name', 'Age', 'ID', 'Nationality', 'Contact', 'Total Debt'];
                    reportData = customers.map(customer => [
                        customer.fullName,
                        customer.age,
                        customer.idNumber,
                        customer.nationality,
                        customer.contact,
                        `${customer.totalDebt} AED`
                    ]);
                    break;
                    
                case 'customerActivity':
                    headers = ['Date', 'Type', 'Description', 'Amount', 'Balance'];
                    if (customerName) {
                        const customer = customers.find(c => c.fullName === customerName);
                        if (customer) {
                            // Get all customer activities
                            let activities = [];
                            
                            // Add rentals
                            rentals.filter(r => r.customerId === customer.id).forEach(rental => {
                                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                                activities.push({
                                    date: rental.startDate,
                                    type: 'Rental',
                                    description: `Rental of ${vehicle ? vehicle.name : 'N/A'} (${rental.invoiceCode})`,
                                    amount: rental.amount,
                                    balance: customer.totalDebt
                                });
                            });
                            
                            // Add payments
                            payments.filter(p => p.customerId === customer.id).forEach(payment => {
                                activities.push({
                                    date: payment.date,
                                    type: 'Payment',
                                    description: `Payment - ${payment.notes}`,
                                    amount: -payment.amount,
                                    balance: customer.totalDebt
                                });
                            });
                            
                            // Add fines
                            fines.filter(f => f.customerId === customer.id).forEach(fine => {
                                activities.push({
                                    date: fine.date,
                                    type: fine.type,
                                    description: `${fine.type} - ${fine.reason}`,
                                    amount: fine.amount,
                                    balance: customer.totalDebt
                                });
                            });
                            
                            // Sort by date
                            activities.sort((a, b) => new Date(a.date) - new Date(b.date));
                            
                            // Calculate running balance
                            let balance = 0;
                            activities.forEach(activity => {
                                balance += activity.amount;
                                activity.balance = balance;
                            });
                            
                            reportData = activities.map(activity => [
                                activity.date,
                                activity.type,
                                activity.description,
                                `${activity.amount} AED`,
                                `${activity.balance} AED`
                            ]);
                        }
                    }
                    break;
                    
                case 'maintenance':
                    headers = ['Vehicle', 'Type', 'Date', 'Cost', 'Status', 'Notes'];
                    reportData = maintenance.map(maintenanceRecord => {
                        const vehicle = vehicles.find(v => v.id === maintenanceRecord.vehicleId);
                        return [
                            vehicle ? vehicle.name : 'N/A',
                            maintenanceRecord.type,
                            maintenanceRecord.date,
                            `${maintenanceRecord.cost} AED`,
                            maintenanceRecord.status,
                            maintenanceRecord.notes
                        ];
                    });
                    break;
                    
                case 'fine':
                    headers = ['Customer', 'Type', 'Amount', 'Date', 'Reason', 'Status'];
                    reportData = fines.map(fine => {
                        const customer = customers.find(c => c.id === fine.customerId);
                        return [
                            customer ? customer.fullName : 'N/A',
                            fine.type,
                            `${fine.amount} AED`,
                            fine.date,
                            fine.reason,
                            fine.status
                        ];
                    });
                    break;
            }
            
            // Filter by date if provided
            if (startDate && endDate) {
                reportData = reportData.filter(row => {
                    const dateField = reportType === 'rental' ? row[3] : 
                                    reportType === 'payment' ? row[2] : 
                                    reportType === 'maintenance' ? row[2] : 
                                    reportType === 'fine' ? row[3] : 
                                    reportType === 'customerActivity' ? row[0] : '';
                    
                    return dateField >= startDate && dateField <= endDate;
                });
            }
            
            // Update report table
            const reportTable = document.getElementById('reportTable');
            const reportTableBody = document.getElementById('reportTableBody');
            
            // Clear existing content
            reportTable.querySelector('thead').innerHTML = '';
            reportTableBody.innerHTML = '';
            
            // Add headers
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            reportTable.querySelector('thead').appendChild(headerRow);
            
            // Add data rows
            reportData.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach(cellData => {
                    const td = document.createElement('td');
                    td.textContent = cellData;
                    row.appendChild(td);
                });
                reportTableBody.appendChild(row);
            });
        }
        
        // Export to Excel
        function exportToExcel() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const customerName = document.getElementById('reportCustomer').value;
            
            let data = [];
            let fileName = '';
            
            switch (reportType) {
                case 'rental':
                    fileName = 'Rental_Report';
                    data = rentals.map(rental => {
                        const customer = customers.find(c => c.id === rental.customerId);
                        const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                        return {
                            'Invoice Code': rental.invoiceCode,
                            'Customer': customer ? customer.fullName : 'N/A',
                            'Vehicle': vehicle ? vehicle.name : 'N/A',
                            'Start Date': rental.startDate,
                            'End Date': rental.endDate,
                            'Amount': rental.amount,
                            'Status': rental.status
                        };
                    });
                    break;
                    
                case 'payment':
                    fileName = 'Payment_Report';
                    data = payments.map(payment => {
                        const customer = customers.find(c => c.id === payment.customerId);
                        return {
                            'Customer': customer ? customer.fullName : 'N/A',
                            'Amount': payment.amount,
                            'Date': payment.date,
                            'Notes': payment.notes
                        };
                    });
                    break;
                    
                case 'vehicle':
                    fileName = 'Vehicle_Report';
                    data = vehicles.map(vehicle => ({
                        'Name': vehicle.name,
                        'Model': vehicle.model,
                        'Color': vehicle.color,
                        'Plate': vehicle.plate,
                        'Odometer': vehicle.odometer,
                        'Rental Price': vehicle.rentalPrice,
                        'Status': vehicle.status
                    }));
                    break;
                    
                case 'customer':
                    fileName = 'Customer_Report';
                    data = customers.map(customer => ({
                        'Full Name': customer.fullName,
                        'Age': customer.age,
                        'ID': customer.idNumber,
                        'Nationality': customer.nationality,
                        'Contact': customer.contact,
                        'Total Debt': customer.totalDebt
                    }));
                    break;
                    
                case 'customerActivity':
                    fileName = 'Customer_Activity_Report';
                    if (customerName) {
                        const customer = customers.find(c => c.fullName === customerName);
                        if (customer) {
                            // Get all customer activities
                            let activities = [];
                            
                            // Add rentals
                            rentals.filter(r => r.customerId === customer.id).forEach(rental => {
                                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                                activities.push({
                                    'Date': rental.startDate,
                                    'Type': 'Rental',
                                    'Description': `Rental of ${vehicle ? vehicle.name : 'N/A'} (${rental.invoiceCode})`,
                                    'Amount': rental.amount,
                                    'Balance': customer.totalDebt
                                });
                            });
                            
                            // Add payments
                            payments.filter(p => p.customerId === customer.id).forEach(payment => {
                                activities.push({
                                    'Date': payment.date,
                                    'Type': 'Payment',
                                    'Description': `Payment - ${payment.notes}`,
                                    'Amount': -payment.amount,
                                    'Balance': customer.totalDebt
                                });
                            });
                            
                            // Add fines
                            fines.filter(f => f.customerId === customer.id).forEach(fine => {
                                activities.push({
                                    'Date': fine.date,
                                    'Type': fine.type,
                                    'Description': `${fine.type} - ${fine.reason}`,
                                    'Amount': fine.amount,
                                    'Balance': customer.totalDebt
                                });
                            });
                            
                            // Sort by date
                            activities.sort((a, b) => new Date(a.Date) - new Date(b.Date));
                            
                            // Calculate running balance
                            let balance = 0;
                            activities.forEach(activity => {
                                balance += activity.Amount;
                                activity.Balance = balance;
                            });
                            
                            data = activities;
                        }
                    }
                    break;
                    
                case 'maintenance':
                    fileName = 'Maintenance_Report';
                    data = maintenance.map(maintenanceRecord => {
                        const vehicle = vehicles.find(v => v.id === maintenanceRecord.vehicleId);
                        return {
                            'Vehicle': vehicle ? vehicle.name : 'N/A',
                            'Type': maintenanceRecord.type,
                            'Date': maintenanceRecord.date,
                            'Cost': maintenanceRecord.cost,
                            'Status': maintenanceRecord.status,
                            'Notes': maintenanceRecord.notes
                        };
                    });
                    break;
                    
                case 'fine':
                    fileName = 'Fine_Tax_Report';
                    data = fines.map(fine => {
                        const customer = customers.find(c => c.id === fine.customerId);
                        return {
                            'Customer': customer ? customer.fullName : 'N/A',
                            'Type': fine.type,
                            'Amount': fine.amount,
                            'Date': fine.date,
                            'Reason': fine.reason,
                            'Status': fine.status
                        };
                    });
                    break;
            }
            
            // Filter by date if provided
            if (startDate && endDate) {
                data = data.filter(item => {
                    const dateField = reportType === 'rental' ? item['Start Date'] : 
                                    reportType === 'payment' ? item['Date'] : 
                                    reportType === 'maintenance' ? item['Date'] : 
                                    reportType === 'fine' ? item['Date'] : 
                                    reportType === 'customerActivity' ? item['Date'] : '';
                    
                    return dateField >= startDate && dateField <= endDate;
                });
            }
            
            // Add timestamp to filename
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            fileName += `_${timestamp}.xlsx`;
            
            // Create worksheet and workbook
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            
            // Export to Excel
            XLSX.writeFile(wb, fileName);
        }
        
        // Load F.RETU.RENT data
        function loadFRRData() {
            const startDate = document.getElementById('frrStartDate').value;
            const endDate = document.getElementById('frrEndDate').value;
            const customerName = document.getElementById('frrCustomer').value;
            const vehicleName = document.getElementById('frrVehicle').value;
            
            const frrTableBody = document.getElementById('frrTableBody');
            frrTableBody.innerHTML = '';
            
            // Get all rentals
            let filteredRentals = [...rentals];
            
            // Filter by date
            if (startDate && endDate) {
                filteredRentals = filteredRentals.filter(rental => 
                    rental.startDate >= startDate && rental.startDate <= endDate
                );
            }
            
            // Filter by customer
            if (customerName) {
                const customer = customers.find(c => c.fullName === customerName);
                if (customer) {
                    filteredRentals = filteredRentals.filter(rental => rental.customerId === customer.id);
                }
            }
            
            // Filter by vehicle
            if (vehicleName) {
                const vehicle = vehicles.find(v => v.name === vehicleName);
                if (vehicle) {
                    filteredRentals = filteredRentals.filter(rental => rental.vehicleId === vehicle.id);
                }
            }
            
            // Process each rental
            filteredRentals.forEach(rental => {
                const customer = customers.find(c => c.id === rental.customerId);
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                const returnRecord = returns.find(r => r.rentalId === rental.id);
                
                // Calculate rental days
                let rentalDays = 0;
                if (returnRecord) {
                    const startDate = new Date(rental.startDate);
                    const returnDate = new Date(returnRecord.actualReturnDate);
                    rentalDays = Math.ceil((returnDate - startDate) / (1000 * 60 * 60 * 24));
                }
                
                // Get fine amount
                const fineAmount = returnRecord ? returnRecord.fine : 0;
                
                // Get tax amount (assuming 5% tax rate)
                const taxAmount = rental.amount * (systemSettings.taxRate / 100);
                
                // Get payment amount for this rental
                const paymentAmount = payments
                    .filter(p => p.customerId === rental.customerId)
                    .reduce((sum, payment) => sum + payment.amount, 0);
                
                // Calculate total amount
                const totalAmount = rental.amount + fineAmount + taxAmount;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${rental.invoiceCode}</td>
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${rental.startDate}</td>
                    <td>${returnRecord ? returnRecord.actualReturnDate : 'Not Returned'}</td>
                    <td>${rental.amount} AED</td>
                    <td>${fineAmount} AED</td>
                    <td>${taxAmount.toFixed(2)} AED</td>
                    <td>${paymentAmount} AED</td>
                    <td>${totalAmount.toFixed(2)} AED</td>
                    <td><span class="badge ${rental.status === 'Active' ? 'bg-warning' : 'bg-success'}">${rental.status}</span></td>
                `;
                frrTableBody.appendChild(row);
            });
        }
        
        // Export F.RETU.RENT to Excel
        function exportFRRToExcel() {
            const startDate = document.getElementById('frrStartDate').value;
            const endDate = document.getElementById('frrEndDate').value;
            const customerName = document.getElementById('frrCustomer').value;
            const vehicleName = document.getElementById('frrVehicle').value;
            
            // Get all rentals
            let filteredRentals = [...rentals];
            
            // Filter by date
            if (startDate && endDate) {
                filteredRentals = filteredRentals.filter(rental => 
                    rental.startDate >= startDate && rental.startDate <= endDate
                );
            }
            
            // Filter by customer
            if (customerName) {
                const customer = customers.find(c => c.fullName === customerName);
                if (customer) {
                    filteredRentals = filteredRentals.filter(rental => rental.customerId === customer.id);
                }
            }
            
            // Filter by vehicle
            if (vehicleName) {
                const vehicle = vehicles.find(v => v.name === vehicleName);
                if (vehicle) {
                    filteredRentals = filteredRentals.filter(rental => rental.vehicleId === vehicle.id);
                }
            }
            
            // Prepare data for export
            const data = filteredRentals.map(rental => {
                const customer = customers.find(c => c.id === rental.customerId);
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                const returnRecord = returns.find(r => r.rentalId === rental.id);
                
                // Calculate rental days
                let rentalDays = 0;
                if (returnRecord) {
                    const startDate = new Date(rental.startDate);
                    const returnDate = new Date(returnRecord.actualReturnDate);
                    rentalDays = Math.ceil((returnDate - startDate) / (1000 * 60 * 60 * 24));
                }
                
                // Get fine amount
                const fineAmount = returnRecord ? returnRecord.fine : 0;
                
                // Get tax amount (assuming 5% tax rate)
                const taxAmount = rental.amount * (systemSettings.taxRate / 100);
                
                // Get payment amount for this rental
                const paymentAmount = payments
                    .filter(p => p.customerId === rental.customerId)
                    .reduce((sum, payment) => sum + payment.amount, 0);
                
                // Calculate total amount
                const totalAmount = rental.amount + fineAmount + taxAmount;
                
                return {
                    'Invoice Code': rental.invoiceCode,
                    'Customer': customer ? customer.fullName : 'N/A',
                    'Vehicle': vehicle ? vehicle.name : 'N/A',
                    'Rental Date': rental.startDate,
                    'Return Date': returnRecord ? returnRecord.actualReturnDate : 'Not Returned',
                    'Rental Days': rentalDays,
                    'Rental Amount': rental.amount,
                    'Fine Amount': fineAmount,
                    'Tax Amount': taxAmount,
                    'Payment Amount': paymentAmount,
                    'Total Amount': totalAmount,
                    'Status': rental.status
                };
            });
            
            // Add timestamp to filename
            const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
            const fileName = `F_RETU_RENT_Report_${timestamp}.xlsx`;
            
            // Create worksheet and workbook
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'F.RETU.RENT Report');
            
            // Export to Excel
            XLSX.writeFile(wb, fileName);
        }
        
        // Print invoice
        function printInvoice(rentalId) {
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = customers.find(c => c.id === rental.customerId);
            const vehicle = vehicles.find(v => v.id === rental.vehicleId);
            
            // Calculate rental days
            const startDate = new Date(rental.startDate);
            const endDate = new Date(rental.endDate);
            const rentalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            
            // Update print content
            document.getElementById('printInvoiceCode').textContent = rental.invoiceCode;
            document.getElementById('printInvoiceDate').textContent = new Date().toLocaleDateString();
            document.getElementById('printCustomerName').textContent = customer ? customer.fullName : 'N/A';
            document.getElementById('printVehicleName').textContent = vehicle ? vehicle.name : 'N/A';
            document.getElementById('printCustomerId').textContent = customer ? customer.idNumber : 'N/A';
            document.getElementById('printCustomerAddress').textContent = customer ? customer.address : 'N/A';
            document.getElementById('printRentalAmount').textContent = `${rental.amount / rentalDays} AED per day`;
            document.getElementById('printRentalDays').textContent = rentalDays;
            document.getElementById('printTotalAmount').textContent = `${rental.amount} AED`;
            
            // Generate rental history
            const rentalHistory = document.getElementById('printRentalHistory');
            rentalHistory.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                        <th style="border: 1px solid #000; padding: 5px;">Start Date</th>
                        <th style="border: 1px solid #000; padding: 5px;">End Date</th>
                        <th style="border: 1px solid #000; padding: 5px;">Days</th>
                        <th style="border: 1px solid #000; padding: 5px;">Amount</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #000; padding: 5px;">${rental.startDate}</td>
                        <td style="border: 1px solid #000; padding: 5px;">${rental.endDate}</td>
                        <td style="border: 1px solid #000; padding: 5px;">${rentalDays}</td>
                        <td style="border: 1px solid #000; padding: 5px;">${rental.amount} AED</td>
                    </tr>
                </table>
            `;
            
            // Show print section and print
            document.getElementById('invoicePrint').style.display = 'block';
            window.print();
            document.getElementById('invoicePrint').style.display = 'none';
        }
        
        // Check for vehicle return reminders
        function checkVehicleReturnReminders() {
            const today = new Date();
            const upcomingReturns = [];
            
            rentals.forEach(rental => {
                if (rental.status === 'Active') {
                    const returnDate = new Date(rental.endDate);
                    const diffTime = returnDate - today;
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                    
                    if (diffDays <= 3 && diffDays >= 0) {
                        const customer = customers.find(c => c.id === rental.customerId);
                        const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                        
                        upcomingReturns.push({
                            invoiceCode: rental.invoiceCode,
                            customer: customer ? customer.fullName : 'N/A',
                            vehicle: vehicle ? vehicle.name : 'N/A',
                            returnDate: rental.endDate,
                            daysLeft: diffDays
                        });
                    }
                }
            });
            
            if (upcomingReturns.length > 0) {
                showReturnReminders(upcomingReturns);
            }
        }
        
        // Show return reminders
        function showReturnReminders(returns) {
            const notificationContent = document.getElementById('notificationContent');
            notificationContent.innerHTML = '<h6>Vehicles due for return soon:</h6>';
            
            returns.forEach(returnItem => {
                const div = document.createElement('div');
                div.className = 'alert alert-warning mt-2';
                div.innerHTML = `
                    <strong>${returnItem.vehicle}</strong> - ${returnItem.customer}<br>
                    Invoice: ${returnItem.invoiceCode}<br>
                    Due: ${returnItem.returnDate} (${returnItem.daysLeft} day${returnItem.daysLeft !== 1 ? 's' : ''} left)
                `;
                notificationContent.appendChild(div);
            });
            
            // Show notification modal
            const notificationModal = new bootstrap.Modal(document.getElementById('notificationModal'));
            notificationModal.show();
        }
        
        // Load vehicle history
        function loadVehicleHistory() {
            const vehicleHistoryTableBody = document.getElementById('vehicleHistoryTableBody');
            vehicleHistoryTableBody.innerHTML = '';
            
            rentals.forEach(rental => {
                const customer = customers.find(c => c.id === rental.customerId);
                const vehicle = vehicles.find(v => v.id === rental.vehicleId);
                const returnRecord = returns.find(r => r.rentalId === rental.id);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${vehicle ? vehicle.name : 'N/A'}</td>
                    <td>${customer ? customer.fullName : 'N/A'}</td>
                    <td>${rental.startDate}</td>
                    <td>${returnRecord ? returnRecord.actualReturnDate : 'Not Returned'}</td>
                    <td>${rental.amount} AED</td>
                    <td><span class="badge ${rental.status === 'Active' ? 'bg-warning' : 'bg-success'}">${rental.status}</span></td>
                `;
                vehicleHistoryTableBody.appendChild(row);
            });
            
            // Vehicle history search
            document.getElementById('vehicleHistorySearchBtn').addEventListener('click', function() {
                const searchTerm = document.getElementById('vehicleHistorySearch').value.toLowerCase();
                filterVehicleHistory(searchTerm);
            });
            
            document.getElementById('vehicleHistorySearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                filterVehicleHistory(searchTerm);
            });
        }
        
        // Filter vehicle history
        function filterVehicleHistory(searchTerm) {
            const rows = document.querySelectorAll('#vehicleHistoryTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Initialize vehicle history when the tab is shown
        document.querySelector('a[href="#vehicleHistory"]').addEventListener('shown.bs.tab', function() {
            loadVehicleHistory();
        });
    </script>
</body>
</html>