<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --danger-color: #e74c3c;
            --warning-color: #f39c12;
            --info-color: #17a2b8;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .navbar-brand {
            font-weight: bold;
        }
        
        .sidebar {
            background-color: var(--secondary-color);
            color: white;
            min-height: calc(100vh - 56px);
            padding: 0;
        }
        
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .sidebar .nav-link:hover, .sidebar .nav-link.active {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .sidebar .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        .card {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            margin-bottom: 20px;
        }
        
        .card-header {
            background-color: white;
            border-bottom: 1px solid rgba(0, 0, 0, 0.125);
            font-weight: 600;
        }
        
        .dashboard-card {
            transition: transform 0.3s;
        }
        
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        
        .table-responsive {
            border-radius: 5px;
        }
        
        .tab-content {
            padding: 20px;
            background-color: white;
            border-radius: 0 0 5px 5px;
        }
        
        .nav-tabs .nav-link.active {
            border-bottom: 3px solid var(--primary-color);
            font-weight: 600;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(52, 152, 219, 0.25);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .btn-success {
            background-color: var(--success-color);
            border-color: var(--success-color);
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .system-name {
            font-size: 1.2rem;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .copyright {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block;
            }
            body {
                background-color: white;
            }
            .card {
                box-shadow: none;
                border: 1px solid #ddd;
            }
        }
        
        .vehicle-details, .customer-details {
            display: none;
            margin-top: 20px;
        }
        
        .suggestion-list {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            width: 100%;
            display: none;
        }
        
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        
        .status-returned {
            background-color: #d4edda;
        }
        
        .status-not-returned {
            background-color: #f8d7da;
        }
        
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        
        .invoice-logo {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .invoice-logo img {
            max-width: 200px;
            height: auto;
        }
        
        .custom-logo {
            max-height: 50px;
            margin-right: 10px;
        }
        
        .currency-badge {
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .user-only {
            display: none;
        }
        
        .system-logo-large {
            max-width: 200px;
            max-height: 80px;
            margin-bottom: 15px;
        }
        
        .signature-area {
            margin-top: 50px;
            border-top: 1px solid #000;
            padding-top: 10px;
        }
        
        .maintenance-status {
            background-color: #fff3cd;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
        
        .vehicle-image {
            max-width: 200px;
            max-height: 150px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .customer-form-container {
            display: none;
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background-color: #f8f9fa;
        }
        
        .form-section {
            margin-bottom: 20px;
        }
        
        .debt-summary {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .permission-item {
            margin-bottom: 10px;
        }
        
        .advanced-search {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="text-center mb-4">
            <i class="fas fa-car fa-3x text-primary mb-3"></i>
            <h2>Car Rental System</h2>
            <p class="text-muted">Please login to continue</p>
        </div>
        <form id="loginForm">
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required>
            </div>
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Login</button>
        </form>
        <div class="text-center mt-3">
            <small class="text-muted">Default admin password: 000000</small>
        </div>
        <div class="text-center mt-4">
            <small class="text-muted">Created by Farzad Programmer - Not Editable</small>
        </div>
    </div>

    <!-- Main Application -->
    <div id="mainApp" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-dark no-print">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <img id="headerLogo" src="" class="custom-logo" style="display: none;">
                    <span id="headerSystemName">Car Rental System</span>
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user-circle"></i> <span id="currentUser">Admin</span>
                            </a>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#changePasswordModal"><i class="fas fa-key"></i> Change Password</a></li>
                                <li class="admin-only"><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#userManagementModal"><i class="fas fa-users"></i> User Management</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container-fluid">
            <div class="row">
                <!-- Sidebar -->
                <div class="col-md-2 sidebar d-none d-md-block no-print">
                    <div class="logo-container">
                        <img id="sidebarLogo" src="" class="system-logo-large" style="display: none;">
                        <span class="system-name" id="sidebarSystemName">RentalSys</span>
                    </div>
                    <ul class="nav flex-column">
                        <li class="nav-item dashboard-item">
                            <a class="nav-link active" href="#dashboard" data-bs-toggle="tab">
                                <i class="fas fa-tachometer-alt"></i> Dashboard
                            </a>
                        </li>
                        <li class="nav-item vehicles-item">
                            <a class="nav-link" href="#vehicles" data-bs-toggle="tab">
                                <i class="fas fa-car"></i> Vehicles
                            </a>
                        </li>
                        <li class="nav-item rentals-customers-item">
                            <a class="nav-link" href="#rentals-customers" data-bs-toggle="tab">
                                <i class="fas fa-users"></i> Rentals & Customers
                            </a>
                        </li>
                        <li class="nav-item returns-item">
                            <a class="nav-link" href="#returns" data-bs-toggle="tab">
                                <i class="fas fa-undo"></i> Vehicle Returns
                            </a>
                        </li>
                        <li class="nav-item maintenance-item">
                            <a class="nav-link" href="#maintenance" data-bs-toggle="tab">
                                <i class="fas fa-tools"></i> Vehicle Maintenance
                            </a>
                        </li>
                        <li class="nav-item payments-item">
                            <a class="nav-link" href="#payments" data-bs-toggle="tab">
                                <i class="fas fa-money-bill-wave"></i> Payments
                            </a>
                        </li>
                        <li class="nav-item fines-item">
                            <a class="nav-link" href="#fines" data-bs-toggle="tab">
                                <i class="fas fa-gavel"></i> Fines & Taxes
                            </a>
                        </li>
                        <li class="nav-item reports-item">
                            <a class="nav-link" href="#reports" data-bs-toggle="tab">
                                <i class="fas fa-chart-bar"></i> Reports
                            </a>
                        </li>
                        <li class="nav-item admin-only settings-item">
                            <a class="nav-link" href="#settings" data-bs-toggle="tab">
                                <i class="fas fa-cogs"></i> System Settings
                            </a>
                        </li>
                    </ul>
                    <div class="copyright">
                        Created by Farzad Programmer<br>Not Editable
                    </div>
                </div>

                <!-- Main Content -->
                <div class="col-md-10 ms-sm-auto col-lg-10 px-4">
                    <div class="tab-content mt-4">
                        <!-- Dashboard Tab -->
                        <div class="tab-pane fade show active" id="dashboard">
                            <h2 class="mb-4">Dashboard</h2>
                            <div class="row" id="dashboardStats">
                                <!-- Dashboard statistics will be loaded here -->
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Recent Rentals
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="recentRentalsTable">
                                                        <!-- Recent rentals will be loaded here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            Vehicle Status
                                        </div>
                                        <div class="card-body">
                                            <canvas id="vehicleStatusChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicles Tab -->
                        <div class="tab-pane fade" id="vehicles">
                            <h2 class="mb-4">Vehicle Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#addVehicle">Add Vehicle</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleList">Vehicle List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#vehicleHistory">Vehicle History</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="addVehicle">
                                    <div class="card">
                                        <div class="card-header">
                                            Add New Vehicle
                                        </div>
                                        <div class="card-body">
                                            <form id="addVehicleForm">
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleName" class="form-label">Vehicle Name</label>
                                                        <input type="text" class="form-control" id="vehicleName" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleOdometer" class="form-label">Odometer</label>
                                                        <input type="number" class="form-control" id="vehicleOdometer" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleVin" class="form-label">VIN #</label>
                                                        <input type="text" class="form-control" id="vehicleVin" required>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehiclePlate" class="form-label">Plate Number</label>
                                                        <input type="text" class="form-control" id="vehiclePlate" required>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleColor" class="form-label">Color</label>
                                                        <input type="text" class="form-control" id="vehicleColor" placeholder="Type color..." required>
                                                        <div class="suggestion-list" id="colorSuggestions"></div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleModel" class="form-label">Model</label>
                                                        <input type="text" class="form-control" id="vehicleModel" placeholder="Type model year..." required>
                                                        <div class="suggestion-list" id="modelSuggestions"></div>
                                                    </div>
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleRentalPrice" class="form-label">Rental Price (per day)</label>
                                                        <div class="input-group">
                                                            <input type="number" class="form-control" id="vehicleRentalPrice" required>
                                                            <span class="input-group-text">AED</span>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="vehicleImage" class="form-label">Vehicle Image</label>
                                                        <input type="file" class="form-control" id="vehicleImage" accept="image/*">
                                                    </div>
                                                </div>
                                                <button type="submit" class="btn btn-primary">Add Vehicle</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleSearch" placeholder="Search vehicles...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Image</th>
                                                            <th>Name</th>
                                                            <th>Model</th>
                                                            <th>Color</th>
                                                            <th>Plate #</th>
                                                            <th>Odometer</th>
                                                            <th>Rental Price</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleTableBody">
                                                        <!-- Vehicle data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Vehicle Details Section -->
                                    <div class="card vehicle-details" id="vehicleDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeVehicleDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="vehicleDetailsContent">
                                            <!-- Vehicle details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="vehicleHistory">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Vehicle Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="vehicleHistorySearch" placeholder="Search by vehicle name...">
                                                <button class="btn btn-outline-secondary" type="button" id="vehicleHistorySearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Vehicle</th>
                                                            <th>Customer</th>
                                                            <th>Rental Date</th>
                                                            <th>Return Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="vehicleHistoryTableBody">
                                                        <!-- Vehicle history will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Rentals & Customers Tab -->
                        <div class="tab-pane fade" id="rentals-customers">
                            <h2 class="mb-4">Rentals & Customers Management</h2>
                            
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#rentalCar">Rent a Car</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#customerList">Customer List</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#rentalList">Rental List</a>
                                </li>
                            </ul>
                            
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="rentalCar">
                                    <div class="card">
                                        <div class="card-header">
                                            Rent a Car
                                        </div>
                                        <div class="card-body">
                                            <form id="createRentalForm">
                                                <div class="form-section">
                                                    <h5>Customer Information</h5>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalCustomer" class="form-label">Customer</label>
                                                            <input type="text" class="form-control" id="rentalCustomer" placeholder="Search customer or add new...">
                                                            <div class="suggestion-list" id="customerSuggestions"></div>
                                                            <div class="form-text">If customer doesn't exist, you can add them below</div>
                                                        </div>
                                                        <div class="col-md-6 mb-3 d-flex align-items-end">
                                                            <button type="button" class="btn btn-outline-primary" id="toggleCustomerForm">
                                                                <i class="fas fa-user-plus"></i> Add New Customer
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- New Customer Form (Initially Hidden) -->
                                                    <div class="customer-form-container" id="newCustomerForm">
                                                        <h6>Add New Customer</h6>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerFullName" class="form-label">Full Name *</label>
                                                                <input type="text" class="form-control" id="customerFullName">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerAge" class="form-label">Age *</label>
                                                                <input type="number" class="form-control" id="customerAge">
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerId" class="form-label">PS/ID *</label>
                                                                <input type="text" class="form-control" id="customerId">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerNationality" class="form-label">Nationality *</label>
                                                                <input type="text" class="form-control" id="customerNationality" placeholder="Type country name...">
                                                                <div class="suggestion-list" id="nationalitySuggestions"></div>
                                                            </div>
                                                        </div>
                                                        <div class="row">
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerContact" class="form-label">Contact Number *</label>
                                                                <input type="text" class="form-control" id="customerContact">
                                                            </div>
                                                            <div class="col-md-6 mb-3">
                                                                <label for="customerAddress" class="form-label">Address *</label>
                                                                <input type="text" class="form-control" id="customerAddress">
                                                            </div>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label for="guaranteeDoc" class="form-label">Guarantee / Document</label>
                                                            <input type="file" class="form-control" id="guaranteeDoc">
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="form-section">
                                                    <h5>Vehicle Information</h5>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalVehicle" class="form-label">Vehicle</label>
                                                            <input type="text" class="form-control" id="rentalVehicle" placeholder="Search vehicle...">
                                                            <div class="suggestion-list" id="vehicleSuggestions"></div>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalAmount" class="form-label">Rental Amount (per day)</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control" id="rentalAmount" required>
                                                                <span class="input-group-text">AED</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalDays" class="form-label">Rental Days</label>
                                                            <input type="number" class="form-control" id="rentalDays" required>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="invoiceCode" class="form-label">Invoice Code</label>
                                                            <input type="text" class="form-control" id="invoiceCode">
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalStartDate" class="form-label">Rental Start Date</label>
                                                            <input type="date" class="form-control" id="rentalStartDate" required>
                                                        </div>
                                                        <div class="col-md-6 mb-3">
                                                            <label for="rentalEndDate" class="form-label">Rental End Date</label>
                                                            <input type="date" class="form-control" id="rentalEndDate" required>
                                                        </div>
                                                    </div>
                                                    <div class="row">
                                                        <div class="col-md-6 mb-3">
                                                            <label for="advancePayment" class="form-label">Advance Payment (Optional)</label>
                                                            <div class="input-group">
                                                                <input type="number" class="form-control" id="advancePayment" value="0">
                                                                <span class="input-group-text">AED</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <button type="submit" class="btn btn-primary">Create Rental</button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="customerList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer List</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="customerSearch" placeholder="Search customers...">
                                                <button class="btn btn-outline-secondary" type="button" id="customerSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Full Name</th>
                                                            <th>Age</th>
                                                            <th>ID</th>
                                                            <th>Nationality</th>
                                                            <th>Contact</th>
                                                            <th>Total Debt</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="customerTableBody">
                                                        <!-- Customer data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Customer Details Section -->
                                    <div class="card customer-details" id="customerDetailsCard">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Customer Details</span>
                                            <button class="btn btn-sm btn-secondary" id="closeCustomerDetails">Close</button>
                                        </div>
                                        <div class="card-body" id="customerDetailsContent">
                                            <!-- Customer details will be populated here -->
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="rentalList">
                                    <div class="card">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <span>Rental History</span>
                                            <div class="input-group" style="width: 300px;">
                                                <input type="text" class="form-control" id="rentalSearch" placeholder="Search by invoice code...">
                                                <button class="btn btn-outline-secondary" type="button" id="rentalSearchBtn">
                                                    <i class="fas fa-search"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>Invoice Code</th>
                                                            <th>Customer</th>
                                                            <th>Vehicle</th>
                                                            <th>Start Date</th>
                                                            <th>End Date</th>
                                                            <th>Amount</th>
                                                            <th>Status</th>
                                                            <th>Actions</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="rentalTableBody">
                                                        <!-- Rental data will be populated here -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Invoice for Printing -->
                            <div id="invoicePrint" class="print-only" style="display: none;">
                                <div class="invoice-logo">
                                    <img id="printLogo" src="" style="max-width: 200px; display: none;">
                                    <h3 id="printSystemName">Car Rental System</h3>
                                </div>
                                <div class="card">
                                    <div class="card-header text-center">
                                        <h3>Car Rental Invoice</h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Invoice Code:</strong> <span id="printInvoiceCode"></span>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Date:</strong> <span id="printInvoiceDate"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Customer:</strong> <span id="printCustomerName"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Vehicle:</strong> <span id="printVehicleName"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-6">
                                                <strong>Customer ID:</strong> <span id="printCustomerId"></span>
                                            </div>
                                            <div class="col-6">
                                                <strong>Customer Address:</strong> <span id="printCustomerAddress"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental Amount (per day):</strong> <span id="printRentalAmount"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental Days:</strong> <span id="printRentalDays"></span>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-12">
                                                <strong>Rental History:</strong>
                                                <div id="printRentalHistory"></div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-12">
                                                <hr>
                                                <h4 class="text-end">Total: <span id="printTotalAmount"></span></h4>
                                            </div>
                                        </div>
                                        <div class="row signature-area">
                                            <div class="col-6">
                                                <strong>Customer Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000;"></div>
                                            </div>
                                            <div class="col-6 text-end">
                                                <strong>Company Signature:</strong>
                                                <div style="height: 50px; border-bottom: 1px solid #000;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Returns Tab -->
                        <div class="tab-pane fade" id="returns">
                            <h2 class="mb-4">Vehicle Returns</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Return Vehicle
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="returnInvoiceSearch" class="form-label">Search by Invoice Code</label>
                                            <input type="text" class="form-control" id="returnInvoiceSearch" placeholder="Search invoice code...">
                                            <div class="suggestion-list" id="returnInvoiceSuggestions"></div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary me-2" id="searchInvoiceBtn">Search</button>
                                        </div>
                                    </div>
                                    <div id="returnFormContainer" style="display: none;">
                                        <form id="returnVehicleForm">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Customer</label>
                                                    <input type="text" class="form-control" id="returnCustomer" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Vehicle</label>
                                                    <input type="text" class="form-control" id="returnVehicle" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label class="form-label">Rental Start Date</label>
                                                    <input type="text" class="form-control" id="returnStartDate" readonly>
                                                </div>
                                                <div class="col-md-6">
                                                    <label class="form-label">Rental End Date</label>
                                                    <input type="text" class="form-control" id="returnEndDate" readonly>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="returnOdometer" class="form-label">Odometer at Return</label>
                                                    <input type="number" class="form-control" id="returnOdometer" required>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="returnDate" class="form-label">Actual Return Date</label>
                                                    <input type="date" class="form-control" id="returnDate" required>
                                                </div>
                                            </div>
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="fineAmount" class="form-label">Fine Amount (if any)</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="fineAmount" value="0">
                                                        <span class="input-group-text">AED</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="fineReason" class="form-label">Fine Reason</label>
                                                    <input type="text" class="form-control" id="fineReason">
                                                </div>
                                            </div>
                                            <button type="submit" class="btn btn-success">Complete Return</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Recent Returns
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Invoice Code</th>
                                                    <th>Customer</th>
                                                    <th>Vehicle</th>
                                                    <th>Return Date</th>
                                                    <th>Fine Amount</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="returnTableBody">
                                                <!-- Return data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Vehicle Maintenance Tab -->
                        <div class="tab-pane fade" id="maintenance">
                            <h2 class="mb-4">Vehicle Maintenance</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Schedule Maintenance
                                </div>
                                <div class="card-body">
                                    <form id="scheduleMaintenanceForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="maintenanceVehicle" class="form-label">Vehicle</label>
                                                <input type="text" class="form-control" id="maintenanceVehicle" placeholder="Search vehicle...">
                                                <div class="suggestion-list" id="maintenanceVehicleSuggestions"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="maintenanceType" class="form-label">Maintenance Type</label>
                                                <select class="form-select" id="maintenanceType" required>
                                                    <option value="">Select type...</option>
                                                    <option value="Oil Change">Oil Change</option>
                                                    <option value="Tire Rotation">Tire Rotation</option>
                                                    <option value="Brake Service">Brake Service</option>
                                                    <option value="Engine Check">Engine Check</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="maintenanceDate" class="form-label">Scheduled Date</label>
                                                <input type="date" class="form-control" id="maintenanceDate" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="maintenanceCost" class="form-label">Estimated Cost</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="maintenanceCost" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="maintenanceNotes" class="form-label">Notes</label>
                                            <textarea class="form-control" id="maintenanceNotes" rows="3"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Schedule Maintenance</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Maintenance History
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Vehicle</th>
                                                    <th>Type</th>
                                                    <th>Scheduled Date</th>
                                                    <th>Cost</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="maintenanceTableBody">
                                                <!-- Maintenance data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payments Tab -->
                        <div class="tab-pane fade" id="payments">
                            <h2 class="mb-4">Payment Management</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Record Payment
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label for="paymentCustomer" class="form-label">Search Customer</label>
                                            <input type="text" class="form-control" id="paymentCustomer" placeholder="Search customer name...">
                                            <div class="suggestion-list" id="paymentCustomerSuggestions"></div>
                                        </div>
                                        <div class="col-md-6 d-flex align-items-end">
                                            <button class="btn btn-primary me-2" id="searchPaymentCustomerBtn">Search</button>
                                        </div>
                                    </div>
                                    <div id="paymentDetailsContainer" style="display: none;">
                                        <div class="debt-summary">
                                            <h5>Customer Debt Summary</h5>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <p><strong>Customer:</strong> <span id="paymentCustomerName"></span></p>
                                                    <p><strong>ID:</strong> <span id="paymentCustomerId"></span></p>
                                                </div>
                                                <div class="col-md-4">
                                                    <p><strong>Rental Debt:</strong> <span id="paymentRentalDebt">0</span> AED</p>
                                                    <p><strong>Fines Debt:</strong> <span id="paymentFinesDebt">0</span> AED</p>
                                                </div>
                                                <div class="col-md-4">
                                                    <p><strong>Total Debt:</strong> <span id="paymentTotalDebt">0</span> AED</p>
                                                </div>
                                            </div>
                                        </div>
                                        <form id="recordPaymentForm">
                                            <input type="hidden" id="paymentCustomerIdInput">
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <label for="paymentAmount" class="form-label">Payment Amount</label>
                                                    <div class="input-group">
                                                        <input type="number" class="form-control" id="paymentAmount" required>
                                                        <span class="input-group-text">AED</span>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <label for="paymentDate" class="form-label">Payment Date</label>
                                                    <input type="date" class="form-control" id="paymentDate" required>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="paymentNotes" class="form-label">Notes</label>
                                                <textarea class="form-control" id="paymentNotes" rows="3"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Record Payment</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Payment History
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Notes</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="paymentTableBody">
                                                <!-- Payment data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fines & Taxes Tab -->
                        <div class="tab-pane fade" id="fines">
                            <h2 class="mb-4">Fines & Taxes</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Add Fine
                                </div>
                                <div class="card-body">
                                    <form id="addFineForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="fineCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="fineCustomer" placeholder="Search customer...">
                                                <div class="suggestion-list" id="fineCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="fineAmount" class="form-label">Amount</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="fineAmount" required>
                                                    <span class="input-group-text">AED</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="fineDate" class="form-label">Date</label>
                                                <input type="date" class="form-control" id="fineDate" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="fineType" class="form-label">Type</label>
                                                <select class="form-select" id="fineType" required>
                                                    <option value="">Select type...</option>
                                                    <option value="Traffic Fine">Traffic Fine</option>
                                                    <option value="Late Return">Late Return</option>
                                                    <option value="Damage">Damage</option>
                                                    <option value="Other">Other</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="fineReason" class="form-label">Reason</label>
                                            <textarea class="form-control" id="fineReason" rows="3" required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Add Fine</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Fines History
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Customer</th>
                                                    <th>Amount</th>
                                                    <th>Date</th>
                                                    <th>Type</th>
                                                    <th>Reason</th>
                                                    <th>Status</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="fineTableBody">
                                                <!-- Fine data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Reports Tab -->
                        <div class="tab-pane fade" id="reports">
                            <h2 class="mb-4">Reports</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    Generate Report
                                </div>
                                <div class="card-body">
                                    <div class="advanced-search">
                                        <h5>Advanced Search</h5>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="reportType" class="form-label">Report Type</label>
                                                <select class="form-select" id="reportType">
                                                    <option value="rental">Rental Report</option>
                                                    <option value="financial">Financial Report</option>
                                                    <option value="vehicle">Vehicle Report</option>
                                                    <option value="customer">Customer Report</option>
                                                    <option value="maintenance">Maintenance Report</option>
                                                    <option value="fines">Fines Report</option>
                                                </select>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="reportStartDate" class="form-label">Start Date</label>
                                                <input type="date" class="form-control" id="reportStartDate">
                                            </div>
                                            <div class="col-md-4">
                                                <label for="reportEndDate" class="form-label">End Date</label>
                                                <input type="date" class="form-control" id="reportEndDate">
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-4">
                                                <label for="reportCustomer" class="form-label">Customer</label>
                                                <input type="text" class="form-control" id="reportCustomer" placeholder="Filter by customer...">
                                                <div class="suggestion-list" id="reportCustomerSuggestions"></div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="reportVehicle" class="form-label">Vehicle</label>
                                                <input type="text" class="form-control" id="reportVehicle" placeholder="Filter by vehicle...">
                                                <div class="suggestion-list" id="reportVehicleSuggestions"></div>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="reportStatus" class="form-label">Status</label>
                                                <select class="form-select" id="reportStatus">
                                                    <option value="">All Statuses</option>
                                                    <option value="active">Active</option>
                                                    <option value="completed">Completed</option>
                                                    <option value="cancelled">Cancelled</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" id="generateReportBtn">Generate Report</button>
                                    <button class="btn btn-success ms-2" id="exportReportBtn">
                                        <i class="fas fa-file-export"></i> Export to Excel
                                    </button>
                                </div>
                            </div>
                            
                            <div class="card mt-4">
                                <div class="card-header">
                                    Report Results
                                </div>
                                <div class="card-body">
                                    <div id="reportResults">
                                        <!-- Report results will be displayed here -->
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings Tab -->
                        <div class="tab-pane fade" id="settings">
                            <h2 class="mb-4">System Settings</h2>
                            
                            <div class="card">
                                <div class="card-header">
                                    General Settings
                                </div>
                                <div class="card-body">
                                    <form id="systemSettingsForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="systemName" class="form-label">System Name</label>
                                                <input type="text" class="form-control" id="systemName" value="Car Rental System">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="systemCurrency" class="form-label">Currency</label>
                                                <input type="text" class="form-control" id="systemCurrency" value="AED" readonly>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label for="companyLogo" class="form-label">Company Logo</label>
                                                <input type="file" class="form-control" id="companyLogo" accept="image/*">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="backupInterval" class="form-label">Backup Interval</label>
                                                <select class="form-select" id="backupInterval">
                                                    <option value="daily">Daily</option>
                                                    <option value="weekly">Weekly</option>
                                                    <option value="monthly">Monthly</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6 d-flex align-items-end">
                                                <button type="button" class="btn btn-warning me-2" id="createBackupBtn">Create Backup Now</button>
                                                <button type="button" class="btn btn-info" id="restoreBackupBtn">Restore Backup</button>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="adminPassword" class="form-label">Admin Password</label>
                                                <input type="password" class="form-control" id="adminPassword" placeholder="Enter new admin password">
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Save Settings</button>
                                    </form>
                                </div>
                            </div>
                            
                            <div class="card mt-4 admin-only">
                                <div class="card-header">
                                    User Management
                                </div>
                                <div class="card-body">
                                    <form id="addUserForm" class="mb-4">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label for="newUsername" class="form-label">Username</label>
                                                <input type="text" class="form-control" id="newUsername" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="newUserPassword" class="form-label">Password</label>
                                                <input type="password" class="form-control" id="newUserPassword" required>
                                            </div>
                                            <div class="col-md-4">
                                                <label for="newUserRole" class="form-label">Role</label>
                                                <select class="form-select" id="newUserRole" required>
                                                    <option value="viewer">Viewer</option>
                                                    <option value="user">User</option>
                                                    <option value="admin">Admin</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mt-3">
                                            <div class="col-md-12">
                                                <label class="form-label">Permissions</label>
                                                <div class="row">
                                                    <div class="col-md-3 permission-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="permissionVehicles" checked>
                                                            <label class="form-check-label" for="permissionVehicles">Vehicles Management</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 permission-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="permissionRentals" checked>
                                                            <label class="form-check-label" for="permissionRentals">Rentals Management</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 permission-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="permissionPayments" checked>
                                                            <label class="form-check-label" for="permissionPayments">Payments Management</label>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3 permission-item">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="permissionReports" checked>
                                                            <label class="form-check-label" for="permissionReports">Reports</label>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary mt-3">Add User</button>
                                    </form>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Username</th>
                                                    <th>Role</th>
                                                    <th>Permissions</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="userTableBody">
                                                <!-- User data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Change Password</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Current Password</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">New Password</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirm New Password</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Change Password</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- User Management Modal -->
    <div class="modal fade" id="userManagementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">User Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addUserModalForm" class="mb-4">
                        <div class="row">
                            <div class="col-md-3">
                                <label for="modalUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="modalUsername" required>
                            </div>
                            <div class="col-md-3">
                                <label for="modalPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="modalPassword" required>
                            </div>
                            <div class="col-md-3">
                                <label for="modalRole" class="form-label">Role</label>
                                <select class="form-select" id="modalRole" required>
                                    <option value="viewer">Viewer</option>
                                    <option value="user">User</option>
                                    <option value="admin">Admin</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end">
                                <button type="submit" class="btn btn-primary w-100">Add User</button>
                            </div>
                        </div>
                    </form>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Role</th>
                                    <th>Permissions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userManagementTable">
                                <!-- User management data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Success</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="successMessage">
                    Operation completed successfully.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal fade" id="errorModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Error</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="errorMessage">
                    An error occurred.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script>
        // Application data
        let appData = {
            users: [
                { 
                    username: 'admin', 
                    password: '000000', 
                    role: 'admin',
                    permissions: {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: true,
                        delete: true,
                        edit: true,
                        addUser: true
                    }
                },
                { 
                    username: 'user', 
                    password: '123456', 
                    role: 'user',
                    permissions: {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: false,
                        delete: false,
                        edit: true,
                        addUser: false
                    }
                },
                { 
                    username: 'viewer', 
                    password: '123456', 
                    role: 'viewer',
                    permissions: {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: false,
                        delete: false,
                        edit: false,
                        addUser: false
                    }
                }
            ],
            currentUser: null,
            vehicles: [],
            customers: [],
            rentals: [],
            returns: [],
            maintenance: [],
            payments: [],
            fines: [],
            settings: {
                systemName: 'Car Rental System',
                currency: 'AED',
                backupInterval: 'weekly',
                logo: null
            },
            colors: ['Red', 'Blue', 'Black', 'White', 'Silver', 'Gray', 'Green', 'Yellow', 'Orange', 'Purple'],
            models: ['2020', '2021', '2022', '2023', '2024'],
            nationalities: ['United Arab Emirates', 'Saudi Arabia', 'Oman', 'Kuwait', 'Qatar', 'Bahrain', 'Egypt', 'Jordan', 'Lebanon', 'Syria', 'India', 'Pakistan', 'Bangladesh', 'Philippines', 'United States', 'United Kingdom', 'Canada', 'Australia']
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Load data from localStorage
            loadData();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize the dashboard
            initializeDashboard();
            
            // Set default dates
            setDefaultDates();
            
            // Check if user is logged in
            checkLoginStatus();
        });

        // Load data from localStorage
        function loadData() {
            const savedData = localStorage.getItem('carRentalData');
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                appData = { ...appData, ...parsedData };
            }
            
            // Update UI with settings
            document.getElementById('headerSystemName').textContent = appData.settings.systemName;
            document.getElementById('sidebarSystemName').textContent = appData.settings.systemName;
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('carRentalData', JSON.stringify(appData));
        }

        // Set up event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Change password form
            document.getElementById('changePasswordForm').addEventListener('submit', handleChangePassword);
            
            // User management forms
            document.getElementById('addUserForm').addEventListener('submit', handleAddUser);
            document.getElementById('addUserModalForm').addEventListener('submit', handleAddUserModal);
            
            // Vehicle form
            document.getElementById('addVehicleForm').addEventListener('submit', handleAddVehicle);
            
            // Rental form
            document.getElementById('createRentalForm').addEventListener('submit', handleCreateRental);
            
            // Return form
            document.getElementById('returnVehicleForm').addEventListener('submit', handleReturnVehicle);
            
            // Maintenance form
            document.getElementById('scheduleMaintenanceForm').addEventListener('submit', handleScheduleMaintenance);
            
            // Payment form
            document.getElementById('recordPaymentForm').addEventListener('submit', handleRecordPayment);
            
            // Fine form
            document.getElementById('addFineForm').addEventListener('submit', handleAddFine);
            
            // Report form
            document.getElementById('generateReportBtn').addEventListener('click', handleGenerateReport);
            
            // Settings form
            document.getElementById('systemSettingsForm').addEventListener('submit', handleSaveSettings);
            
            // Export report button
            document.getElementById('exportReportBtn').addEventListener('click', handleExportReport);
            
            // Search buttons
            document.getElementById('vehicleSearchBtn').addEventListener('click', searchVehicles);
            document.getElementById('customerSearchBtn').addEventListener('click', searchCustomers);
            document.getElementById('rentalSearchBtn').addEventListener('click', searchRentals);
            document.getElementById('searchInvoiceBtn').addEventListener('click', searchInvoiceForReturn);
            document.getElementById('searchPaymentCustomerBtn').addEventListener('click', searchPaymentCustomer);
            
            // Backup buttons
            document.getElementById('createBackupBtn').addEventListener('click', handleCreateBackup);
            document.getElementById('restoreBackupBtn').addEventListener('click', handleRestoreBackup);
            
            // Toggle customer form
            document.getElementById('toggleCustomerForm').addEventListener('click', toggleCustomerForm);
            
            // Close details buttons
            document.getElementById('closeVehicleDetails').addEventListener('click', closeVehicleDetails);
            document.getElementById('closeCustomerDetails').addEventListener('click', closeCustomerDetails);
            
            // Auto-suggestions
            setupAutoSuggestions();
            
            // Tab change events
            setupTabEvents();
        }

        // Set default dates
        function setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('rentalStartDate').value = today;
            document.getElementById('returnDate').value = today;
            document.getElementById('maintenanceDate').value = today;
            document.getElementById('paymentDate').value = today;
            document.getElementById('fineDate').value = today;
            document.getElementById('reportStartDate').value = today;
            document.getElementById('reportEndDate').value = today;
            
            // Set end date to 7 days from today
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('rentalEndDate').value = nextWeek.toISOString().split('T')[0];
        }

        // Check login status
        function checkLoginStatus() {
            const currentUser = sessionStorage.getItem('currentUser');
            if (currentUser) {
                appData.currentUser = JSON.parse(currentUser);
                showMainApp();
            } else {
                showLoginScreen();
            }
        }

        // Show login screen
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('mainApp').style.display = 'none';
        }

        // Show main application
        function showMainApp() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUser').textContent = appData.currentUser.username;
            
            // Show/hide admin features based on role and permissions
            updateUIPermissions();
            
            // Load initial data
            loadVehicleTable();
            loadCustomerTable();
            loadRentalTable();
            loadReturnTable();
            loadMaintenanceTable();
            loadPaymentTable();
            loadFineTable();
            loadUserTable();
        }

        // Update UI based on user permissions
        function updateUIPermissions() {
            const user = appData.currentUser;
            
            // Admin elements
            const adminElements = document.querySelectorAll('.admin-only');
            adminElements.forEach(el => {
                el.style.display = user.role === 'admin' ? 'block' : 'none';
            });
            
            // Action buttons based on permissions
            updateActionButtons();
        }

        // Update action buttons based on permissions
        function updateActionButtons() {
            const user = appData.currentUser;
            
            // Edit buttons
            const editButtons = document.querySelectorAll('.edit-vehicle, .edit-customer, .edit-maintenance, .edit-user');
            editButtons.forEach(btn => {
                btn.style.display = user.permissions.edit ? 'inline-block' : 'none';
            });
            
            // Delete buttons
            const deleteButtons = document.querySelectorAll('.delete-vehicle, .delete-customer, .delete-maintenance, .delete-user');
            deleteButtons.forEach(btn => {
                btn.style.display = user.permissions.delete ? 'inline-block' : 'none';
            });
            
            // Add user buttons
            const addUserButtons = document.querySelectorAll('#addUserForm button, #addUserModalForm button');
            addUserButtons.forEach(btn => {
                btn.style.display = user.permissions.addUser ? 'inline-block' : 'none';
            });
        }

        // Handle login
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            const user = appData.users.find(u => u.username === username && u.password === password);
            
            if (user) {
                appData.currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(user));
                showMainApp();
            } else {
                showError('Invalid username or password');
            }
        }

        // Handle logout
        function handleLogout() {
            appData.currentUser = null;
            sessionStorage.removeItem('currentUser');
            showLoginScreen();
        }

        // Handle change password
        function handleChangePassword(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (currentPassword !== appData.currentUser.password) {
                showError('Current password is incorrect');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showError('New passwords do not match');
                return;
            }
            
            // Update password
            appData.currentUser.password = newPassword;
            const userIndex = appData.users.findIndex(u => u.username === appData.currentUser.username);
            appData.users[userIndex].password = newPassword;
            
            saveData();
            showSuccess('Password changed successfully');
            document.getElementById('changePasswordModal').querySelector('.btn-close').click();
        }

        // Handle add user from settings
        function handleAddUser(e) {
            e.preventDefault();
            
            if (!appData.currentUser.permissions.addUser) {
                showError('You do not have permission to add users');
                return;
            }
            
            const username = document.getElementById('newUsername').value;
            const password = document.getElementById('newUserPassword').value;
            const role = document.getElementById('newUserRole').value;
            
            if (appData.users.find(u => u.username === username)) {
                showError('Username already exists');
                return;
            }
            
            // Get permissions from checkboxes
            const permissions = {
                vehicles: document.getElementById('permissionVehicles').checked,
                rentals: document.getElementById('permissionRentals').checked,
                payments: document.getElementById('permissionPayments').checked,
                reports: document.getElementById('permissionReports').checked,
                settings: role === 'admin',
                delete: role === 'admin',
                edit: role !== 'viewer',
                addUser: role === 'admin'
            };
            
            const newUser = {
                username,
                password,
                role,
                permissions
            };
            
            appData.users.push(newUser);
            saveData();
            loadUserTable();
            showSuccess('User added successfully');
            document.getElementById('addUserForm').reset();
        }

        // Handle add user from modal
        function handleAddUserModal(e) {
            e.preventDefault();
            
            if (!appData.currentUser.permissions.addUser) {
                showError('You do not have permission to add users');
                return;
            }
            
            const username = document.getElementById('modalUsername').value;
            const password = document.getElementById('modalPassword').value;
            const role = document.getElementById('modalRole').value;
            
            if (appData.users.find(u => u.username === username)) {
                showError('Username already exists');
                return;
            }
            
            // Set permissions based on role
            const permissions = getDefaultPermissions(role);
            
            const newUser = {
                username,
                password,
                role,
                permissions
            };
            
            appData.users.push(newUser);
            saveData();
            loadUserManagementTable();
            showSuccess('User added successfully');
            document.getElementById('addUserModalForm').reset();
        }

        // Get default permissions for a role
        function getDefaultPermissions(role) {
            switch (role) {
                case 'admin':
                    return {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: true,
                        delete: true,
                        edit: true,
                        addUser: true
                    };
                case 'user':
                    return {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: false,
                        delete: false,
                        edit: true,
                        addUser: false
                    };
                case 'viewer':
                    return {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: false,
                        delete: false,
                        edit: false,
                        addUser: false
                    };
                default:
                    return {
                        vehicles: true,
                        rentals: true,
                        payments: true,
                        reports: true,
                        settings: false,
                        delete: false,
                        edit: false,
                        addUser: false
                    };
            }
        }

        // Handle add vehicle
        function handleAddVehicle(e) {
            e.preventDefault();
            
            const vehicle = {
                id: generateId(),
                name: document.getElementById('vehicleName').value,
                odometer: parseInt(document.getElementById('vehicleOdometer').value),
                vin: document.getElementById('vehicleVin').value,
                plate: document.getElementById('vehiclePlate').value,
                color: document.getElementById('vehicleColor').value,
                model: document.getElementById('vehicleModel').value,
                rentalPrice: parseFloat(document.getElementById('vehicleRentalPrice').value),
                status: 'available',
                image: null,
                createdAt: new Date().toISOString()
            };
            
            // Handle image upload
            const imageInput = document.getElementById('vehicleImage');
            if (imageInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    vehicle.image = e.target.result;
                    completeAddVehicle(vehicle);
                };
                reader.readAsDataURL(imageInput.files[0]);
            } else {
                completeAddVehicle(vehicle);
            }
        }

        function completeAddVehicle(vehicle) {
            appData.vehicles.push(vehicle);
            saveData();
            loadVehicleTable();
            showSuccess('Vehicle added successfully');
            document.getElementById('addVehicleForm').reset();
            
            // Add to suggestions if not already there
            if (!appData.colors.includes(vehicle.color)) {
                appData.colors.push(vehicle.color);
            }
            if (!appData.models.includes(vehicle.model)) {
                appData.models.push(vehicle.model);
            }
        }

        // Handle create rental
        function handleCreateRental(e) {
            e.preventDefault();
            
            // Check if we need to add a new customer
            const customerName = document.getElementById('rentalCustomer').value;
            let customer = appData.customers.find(c => c.fullName === customerName);
            
            if (!customer) {
                // Validate new customer form
                if (!validateNewCustomerForm()) {
                    showError('Please fill in all required customer fields');
                    return;
                }
                
                // Add new customer
                customer = {
                    id: generateId(),
                    fullName: document.getElementById('customerFullName').value,
                    age: parseInt(document.getElementById('customerAge').value),
                    idNumber: document.getElementById('customerId').value,
                    nationality: document.getElementById('customerNationality').value,
                    contact: document.getElementById('customerContact').value,
                    address: document.getElementById('customerAddress').value,
                    guaranteeDoc: null,
                    totalDebt: 0,
                    createdAt: new Date().toISOString()
                };
                
                // Handle document upload
                const docInput = document.getElementById('guaranteeDoc');
                if (docInput.files.length > 0) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        customer.guaranteeDoc = e.target.result;
                        completeAddCustomerAndRental(customer);
                    };
                    reader.readAsDataURL(docInput.files[0]);
                } else {
                    completeAddCustomerAndRental(customer);
                }
            } else {
                // Use existing customer
                completeCreateRental(customer);
            }
        }

        function validateNewCustomerForm() {
            const fullName = document.getElementById('customerFullName').value;
            const age = document.getElementById('customerAge').value;
            const idNumber = document.getElementById('customerId').value;
            const nationality = document.getElementById('customerNationality').value;
            const contact = document.getElementById('customerContact').value;
            const address = document.getElementById('customerAddress').value;
            
            return fullName && age && idNumber && nationality && contact && address;
        }

        function completeAddCustomerAndRental(customer) {
            appData.customers.push(customer);
            saveData();
            loadCustomerTable();
            completeCreateRental(customer);
            
            // Add to suggestions if not already there
            if (!appData.nationalities.includes(customer.nationality)) {
                appData.nationalities.push(customer.nationality);
            }
        }

        function completeCreateRental(customer) {
            const vehicleName = document.getElementById('rentalVehicle').value;
            const vehicle = appData.vehicles.find(v => v.name === vehicleName);
            
            if (!vehicle) {
                showError('Vehicle not found');
                return;
            }
            
            if (vehicle.status !== 'available') {
                showError('Vehicle is not available for rental');
                return;
            }
            
            const advancePayment = parseFloat(document.getElementById('advancePayment').value) || 0;
            
            const rental = {
                id: generateId(),
                invoiceCode: document.getElementById('invoiceCode').value || generateInvoiceCode(),
                customerId: customer.id,
                customerName: customer.fullName,
                vehicleId: vehicle.id,
                vehicleName: vehicle.name,
                rentalAmount: parseFloat(document.getElementById('rentalAmount').value),
                rentalDays: parseInt(document.getElementById('rentalDays').value),
                startDate: document.getElementById('rentalStartDate').value,
                endDate: document.getElementById('rentalEndDate').value,
                advancePayment: advancePayment,
                status: 'active',
                createdAt: new Date().toISOString()
            };
            
            // Update vehicle status
            vehicle.status = 'rented';
            
            // If advance payment is provided, record it
            if (advancePayment > 0) {
                const payment = {
                    id: generateId(),
                    customerId: customer.id,
                    customerName: customer.fullName,
                    amount: advancePayment,
                    date: new Date().toISOString().split('T')[0],
                    notes: `Advance payment for rental ${rental.invoiceCode}`,
                    createdAt: new Date().toISOString()
                };
                
                appData.payments.push(payment);
                
                // Update customer debt
                customer.totalDebt = Math.max(0, (customer.totalDebt || 0) - advancePayment);
            }
            
            appData.rentals.push(rental);
            saveData();
            loadRentalTable();
            loadVehicleTable();
            loadPaymentTable();
            showSuccess('Rental created successfully');
            
            // Print invoice
            printInvoice(rental, customer, vehicle);
            
            // Reset form
            document.getElementById('createRentalForm').reset();
            setDefaultDates();
            document.getElementById('customerSuggestions').style.display = 'none';
            document.getElementById('vehicleSuggestions').style.display = 'none';
            document.getElementById('newCustomerForm').style.display = 'none';
        }

        // Handle return vehicle
        function handleReturnVehicle(e) {
            e.preventDefault();
            
            const invoiceCode = document.getElementById('returnInvoiceSearch').value;
            const rental = appData.rentals.find(r => r.invoiceCode === invoiceCode && r.status === 'active');
            
            if (!rental) {
                showError('Active rental not found for this invoice code');
                return;
            }
            
            const returnRecord = {
                id: generateId(),
                rentalId: rental.id,
                invoiceCode: rental.invoiceCode,
                customerId: rental.customerId,
                customerName: rental.customerName,
                vehicleId: rental.vehicleId,
                vehicleName: rental.vehicleName,
                returnOdometer: parseInt(document.getElementById('returnOdometer').value),
                returnDate: document.getElementById('returnDate').value,
                fineAmount: parseFloat(document.getElementById('fineAmount').value) || 0,
                fineReason: document.getElementById('fineReason').value || '',
                createdAt: new Date().toISOString()
            };
            
            // Update rental status
            rental.status = 'returned';
            rental.actualEndDate = returnRecord.returnDate;
            
            // Update vehicle status and odometer
            const vehicle = appData.vehicles.find(v => v.id === rental.vehicleId);
            if (vehicle) {
                vehicle.status = 'available';
                vehicle.odometer = returnRecord.returnOdometer;
            }
            
            // Update customer debt if there's a fine
            if (returnRecord.fineAmount > 0) {
                const customer = appData.customers.find(c => c.id === rental.customerId);
                if (customer) {
                    customer.totalDebt += returnRecord.fineAmount;
                }
                
                // Add to fines
                const fine = {
                    id: generateId(),
                    customerId: rental.customerId,
                    customerName: rental.customerName,
                    amount: returnRecord.fineAmount,
                    date: returnRecord.returnDate,
                    type: 'Late Return',
                    reason: returnRecord.fineReason,
                    status: 'unpaid',
                    createdAt: new Date().toISOString()
                };
                
                appData.fines.push(fine);
            }
            
            appData.returns.push(returnRecord);
            saveData();
            loadReturnTable();
            loadRentalTable();
            loadVehicleTable();
            loadCustomerTable();
            loadFineTable();
            showSuccess('Vehicle returned successfully');
            document.getElementById('returnVehicleForm').reset();
            document.getElementById('returnFormContainer').style.display = 'none';
        }

        // Handle schedule maintenance
        function handleScheduleMaintenance(e) {
            e.preventDefault();
            
            const vehicleName = document.getElementById('maintenanceVehicle').value;
            const vehicle = appData.vehicles.find(v => v.name === vehicleName);
            
            if (!vehicle) {
                showError('Vehicle not found');
                return;
            }
            
            const maintenance = {
                id: generateId(),
                vehicleId: vehicle.id,
                vehicleName: vehicle.name,
                type: document.getElementById('maintenanceType').value,
                scheduledDate: document.getElementById('maintenanceDate').value,
                cost: parseFloat(document.getElementById('maintenanceCost').value),
                notes: document.getElementById('maintenanceNotes').value,
                status: 'scheduled',
                createdAt: new Date().toISOString()
            };
            
            // Update vehicle status if it's available
            if (vehicle.status === 'available') {
                vehicle.status = 'maintenance';
            }
            
            appData.maintenance.push(maintenance);
            saveData();
            loadMaintenanceTable();
            loadVehicleTable();
            showSuccess('Maintenance scheduled successfully');
            document.getElementById('scheduleMaintenanceForm').reset();
            setDefaultDates();
        }

        // Handle search payment customer
        function searchPaymentCustomer() {
            const customerName = document.getElementById('paymentCustomer').value;
            const customer = appData.customers.find(c => c.fullName === customerName);
            
            if (customer) {
                document.getElementById('paymentCustomerName').textContent = customer.fullName;
                document.getElementById('paymentCustomerId').textContent = customer.idNumber;
                document.getElementById('paymentCustomerIdInput').value = customer.id;
                
                // Calculate debt
                const rentalDebt = calculateRentalDebt(customer.id);
                const finesDebt = calculateFinesDebt(customer.id);
                const totalDebt = rentalDebt + finesDebt;
                
                document.getElementById('paymentRentalDebt').textContent = rentalDebt.toFixed(2);
                document.getElementById('paymentFinesDebt').textContent = finesDebt.toFixed(2);
                document.getElementById('paymentTotalDebt').textContent = totalDebt.toFixed(2);
                
                document.getElementById('paymentDetailsContainer').style.display = 'block';
            } else {
                showError('Customer not found');
            }
        }

        // Calculate rental debt for a customer
        function calculateRentalDebt(customerId) {
            const customerRentals = appData.rentals.filter(r => r.customerId === customerId);
            let totalRentalAmount = 0;
            
            customerRentals.forEach(rental => {
                totalRentalAmount += rental.rentalAmount * rental.rentalDays;
            });
            
            // Subtract payments
            const customerPayments = appData.payments.filter(p => p.customerId === customerId);
            const totalPayments = customerPayments.reduce((sum, payment) => sum + payment.amount, 0);
            
            return Math.max(0, totalRentalAmount - totalPayments);
        }

        // Calculate fines debt for a customer
        function calculateFinesDebt(customerId) {
            const customerFines = appData.fines.filter(f => f.customerId === customerId && f.status === 'unpaid');
            return customerFines.reduce((sum, fine) => sum + fine.amount, 0);
        }

        // Handle record payment
        function handleRecordPayment(e) {
            e.preventDefault();
            
            const customerId = document.getElementById('paymentCustomerIdInput').value;
            const customer = appData.customers.find(c => c.id === customerId);
            
            if (!customer) {
                showError('Customer not found');
                return;
            }
            
            const payment = {
                id: generateId(),
                customerId: customer.id,
                customerName: customer.fullName,
                amount: parseFloat(document.getElementById('paymentAmount').value),
                date: document.getElementById('paymentDate').value,
                notes: document.getElementById('paymentNotes').value,
                createdAt: new Date().toISOString()
            };
            
            appData.payments.push(payment);
            
            // Update customer debt
            customer.totalDebt = Math.max(0, customer.totalDebt - payment.amount);
            
            // Update fines status if payment covers fines
            updateFinesStatus(customerId, payment.amount);
            
            saveData();
            loadPaymentTable();
            loadCustomerTable();
            loadFineTable();
            showSuccess('Payment recorded successfully');
            document.getElementById('recordPaymentForm').reset();
            document.getElementById('paymentDetailsContainer').style.display = 'none';
            document.getElementById('paymentCustomer').value = '';
        }

        // Update fines status based on payment
        function updateFinesStatus(customerId, paymentAmount) {
            const customerFines = appData.fines.filter(f => f.customerId === customerId && f.status === 'unpaid');
            let remainingAmount = paymentAmount;
            
            for (const fine of customerFines) {
                if (remainingAmount <= 0) break;
                
                if (remainingAmount >= fine.amount) {
                    fine.status = 'paid';
                    remainingAmount -= fine.amount;
                } else {
                    // Partial payment - we could implement this if needed
                    break;
                }
            }
        }

        // Handle add fine
        function handleAddFine(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('fineCustomer').value;
            const customer = appData.customers.find(c => c.fullName === customerName);
            
            if (!customer) {
                showError('Customer not found');
                return;
            }
            
            const fine = {
                id: generateId(),
                customerId: customer.id,
                customerName: customer.fullName,
                amount: parseFloat(document.getElementById('fineAmount').value),
                date: document.getElementById('fineDate').value,
                type: document.getElementById('fineType').value,
                reason: document.getElementById('fineReason').value,
                status: 'unpaid',
                createdAt: new Date().toISOString()
            };
            
            // Update customer debt
            customer.totalDebt += fine.amount;
            
            appData.fines.push(fine);
            saveData();
            loadFineTable();
            loadCustomerTable();
            showSuccess('Fine added successfully');
            document.getElementById('addFineForm').reset();
            setDefaultDates();
        }

        // Handle generate report
        function handleGenerateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const customerFilter = document.getElementById('reportCustomer').value;
            const vehicleFilter = document.getElementById('reportVehicle').value;
            const statusFilter = document.getElementById('reportStatus').value;
            
            let results = [];
            let title = '';
            
            switch (reportType) {
                case 'rental':
                    results = appData.rentals.filter(r => {
                        const matchesDate = (!startDate || r.createdAt >= startDate) && (!endDate || r.createdAt <= endDate);
                        const matchesCustomer = !customerFilter || r.customerName.includes(customerFilter);
                        const matchesVehicle = !vehicleFilter || r.vehicleName.includes(vehicleFilter);
                        const matchesStatus = !statusFilter || r.status === statusFilter;
                        return matchesDate && matchesCustomer && matchesVehicle && matchesStatus;
                    });
                    title = 'Rental Report';
                    break;
                case 'financial':
                    results = appData.payments.filter(p => {
                        const matchesDate = (!startDate || p.date >= startDate) && (!endDate || p.date <= endDate);
                        const matchesCustomer = !customerFilter || p.customerName.includes(customerFilter);
                        return matchesDate && matchesCustomer;
                    });
                    title = 'Financial Report';
                    break;
                case 'vehicle':
                    results = appData.vehicles.filter(v => {
                        const matchesVehicle = !vehicleFilter || v.name.includes(vehicleFilter);
                        return matchesVehicle;
                    });
                    title = 'Vehicle Report';
                    break;
                case 'customer':
                    results = appData.customers.filter(c => {
                        const matchesCustomer = !customerFilter || c.fullName.includes(customerFilter);
                        return matchesCustomer;
                    });
                    title = 'Customer Report';
                    break;
                case 'maintenance':
                    results = appData.maintenance.filter(m => {
                        const matchesDate = (!startDate || m.scheduledDate >= startDate) && (!endDate || m.scheduledDate <= endDate);
                        const matchesVehicle = !vehicleFilter || m.vehicleName.includes(vehicleFilter);
                        return matchesDate && matchesVehicle;
                    });
                    title = 'Maintenance Report';
                    break;
                case 'fines':
                    results = appData.fines.filter(f => {
                        const matchesDate = (!startDate || f.date >= startDate) && (!endDate || f.date <= endDate);
                        const matchesCustomer = !customerFilter || f.customerName.includes(customerFilter);
                        return matchesDate && matchesCustomer;
                    });
                    title = 'Fines Report';
                    break;
            }
            
            displayReportResults(results, title, reportType);
        }

        // Handle export report
        function handleExportReport() {
            const reportResults = document.getElementById('reportResults');
            const table = reportResults.querySelector('table');
            
            if (!table) {
                showError('No report data to export');
                return;
            }
            
            // Convert table to worksheet
            const ws = XLSX.utils.table_to_sheet(table);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            
            // Generate filename
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const filename = `${reportType}_report_${startDate}_to_${endDate}.xlsx`;
            
            // Export to Excel
            XLSX.writeFile(wb, filename);
        }

        // Handle save settings
        function handleSaveSettings(e) {
            e.preventDefault();
            
            appData.settings.systemName = document.getElementById('systemName').value;
            appData.settings.backupInterval = document.getElementById('backupInterval').value;
            
            // Handle logo upload
            const logoInput = document.getElementById('companyLogo');
            if (logoInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    appData.settings.logo = e.target.result;
                    completeSaveSettings();
                };
                reader.readAsDataURL(logoInput.files[0]);
            } else {
                completeSaveSettings();
            }
            
            // Update admin password if provided
            const adminPassword = document.getElementById('adminPassword').value;
            if (adminPassword) {
                const adminUser = appData.users.find(u => u.role === 'admin');
                if (adminUser) {
                    adminUser.password = adminPassword;
                    
                    // Update current user if it's the admin
                    if (appData.currentUser.role === 'admin') {
                        appData.currentUser.password = adminPassword;
                        sessionStorage.setItem('currentUser', JSON.stringify(appData.currentUser));
                    }
                }
            }
        }

        function completeSaveSettings() {
            saveData();
            
            // Update UI with new settings
            document.getElementById('headerSystemName').textContent = appData.settings.systemName;
            document.getElementById('sidebarSystemName').textContent = appData.settings.systemName;
            
            showSuccess('Settings saved successfully');
        }

        // Handle create backup
        function handleCreateBackup() {
            const backupData = {
                vehicles: appData.vehicles,
                customers: appData.customers,
                rentals: appData.rentals,
                returns: appData.returns,
                maintenance: appData.maintenance,
                payments: appData.payments,
                fines: appData.fines,
                users: appData.users,
                settings: appData.settings,
                timestamp: new Date().toISOString()
            };
            
            const backupBlob = new Blob([JSON.stringify(backupData)], { type: 'application/json' });
            const backupUrl = URL.createObjectURL(backupBlob);
            
            const a = document.createElement('a');
            a.href = backupUrl;
            a.download = `car_rental_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            showSuccess('Backup created successfully');
        }

        // Handle restore backup
        function handleRestoreBackup() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Restore data
                        appData.vehicles = backupData.vehicles || [];
                        appData.customers = backupData.customers || [];
                        appData.rentals = backupData.rentals || [];
                        appData.returns = backupData.returns || [];
                        appData.maintenance = backupData.maintenance || [];
                        appData.payments = backupData.payments || [];
                        appData.fines = backupData.fines || [];
                        appData.users = backupData.users || appData.users;
                        appData.settings = backupData.settings || appData.settings;
                        
                        saveData();
                        
                        // Reload all data
                        loadVehicleTable();
                        loadCustomerTable();
                        loadRentalTable();
                        loadReturnTable();
                        loadMaintenanceTable();
                        loadPaymentTable();
                        loadFineTable();
                        loadUserTable();
                        initializeDashboard();
                        
                        showSuccess('Backup restored successfully');
                    } catch (error) {
                        showError('Error restoring backup: Invalid file format');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // Initialize dashboard
        function initializeDashboard() {
            updateDashboardStats();
            loadRecentRentals();
            initializeVehicleStatusChart();
        }

        // Update dashboard statistics
        function updateDashboardStats() {
            const stats = {
                totalVehicles: appData.vehicles.length,
                availableVehicles: appData.vehicles.filter(v => v.status === 'available').length,
                rentedVehicles: appData.vehicles.filter(v => v.status === 'rented').length,
                totalCustomers: appData.customers.length,
                activeRentals: appData.rentals.filter(r => r.status === 'active').length,
                totalRevenue: appData.payments.reduce((sum, payment) => sum + payment.amount, 0)
            };
            
            const statsHTML = `
                <div class="col-md-2">
                    <div class="card dashboard-card bg-primary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${stats.totalVehicles}</h4>
                                    <p>Total Vehicles</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-car fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-success text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${stats.availableVehicles}</h4>
                                    <p>Available</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-check-circle fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-warning text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${stats.rentedVehicles}</h4>
                                    <p>Rented</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-road fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-info text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${stats.totalCustomers}</h4>
                                    <p>Customers</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-users fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-secondary text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${stats.activeRentals}</h4>
                                    <p>Active Rentals</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-clipboard-list fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="card dashboard-card bg-dark text-white">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <div>
                                    <h4>${stats.totalRevenue.toFixed(2)}</h4>
                                    <p>Total Revenue</p>
                                </div>
                                <div class="align-self-center">
                                    <i class="fas fa-money-bill-wave fa-2x"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('dashboardStats').innerHTML = statsHTML;
        }

        // Load recent rentals
        function loadRecentRentals() {
            const recentRentals = appData.rentals
                .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
                .slice(0, 5);
            
            let tableHTML = '';
            
            if (recentRentals.length === 0) {
                tableHTML = '<tr><td colspan="5" class="text-center">No recent rentals</td></tr>';
            } else {
                recentRentals.forEach(rental => {
                    tableHTML += `
                        <tr>
                            <td>${rental.customerName}</td>
                            <td>${rental.vehicleName}</td>
                            <td>${formatDate(rental.startDate)}</td>
                            <td>${rental.rentalAmount} ${appData.settings.currency}</td>
                            <td><span class="badge ${rental.status === 'active' ? 'bg-success' : 'bg-secondary'}">${rental.status}</span></td>
                        </tr>
                    `;
                });
            }
            
            document.getElementById('recentRentalsTable').innerHTML = tableHTML;
        }

        // Initialize vehicle status chart
        function initializeVehicleStatusChart() {
            const ctx = document.getElementById('vehicleStatusChart').getContext('2d');
            
            const available = appData.vehicles.filter(v => v.status === 'available').length;
            const rented = appData.vehicles.filter(v => v.status === 'rented').length;
            const maintenance = appData.vehicles.filter(v => v.status === 'maintenance').length;
            
            // Destroy existing chart if it exists
            if (window.vehicleStatusChart) {
                window.vehicleStatusChart.destroy();
            }
            
            window.vehicleStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Available', 'Rented', 'Maintenance'],
                    datasets: [{
                        data: [available, rented, maintenance],
                        backgroundColor: [
                            '#28a745',
                            '#ffc107',
                            '#17a2b8'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Load vehicle table
        function loadVehicleTable() {
            const tableBody = document.getElementById('vehicleTableBody');
            let tableHTML = '';
            
            if (appData.vehicles.length === 0) {
                tableHTML = '<tr><td colspan="9" class="text-center">No vehicles found</td></tr>';
            } else {
                appData.vehicles.forEach(vehicle => {
                    const statusBadge = vehicle.status === 'available' ? 
                        '<span class="badge bg-success">Available</span>' :
                        vehicle.status === 'rented' ? 
                        '<span class="badge bg-warning">Rented</span>' :
                        '<span class="badge bg-info">Maintenance</span>';
                    
                    const canEdit = appData.currentUser.permissions.edit;
                    const canDelete = appData.currentUser.permissions.delete;
                    
                    tableHTML += `
                        <tr>
                            <td>
                                ${vehicle.image ? 
                                    `<img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}">` : 
                                    '<i class="fas fa-car text-muted"></i>'
                                }
                            </td>
                            <td>${vehicle.name}</td>
                            <td>${vehicle.model}</td>
                            <td>${vehicle.color}</td>
                            <td>${vehicle.plate}</td>
                            <td>${vehicle.odometer.toLocaleString()} km</td>
                            <td>${vehicle.rentalPrice} ${appData.settings.currency}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-vehicle" data-id="${vehicle.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-warning edit-vehicle" data-id="${vehicle.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger delete-vehicle" data-id="${vehicle.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Add event listeners to action buttons
            document.querySelectorAll('.view-vehicle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const vehicleId = this.getAttribute('data-id');
                    viewVehicleDetails(vehicleId);
                });
            });
            
            if (appData.currentUser.permissions.edit) {
                document.querySelectorAll('.edit-vehicle').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const vehicleId = this.getAttribute('data-id');
                        editVehicle(vehicleId);
                    });
                });
            }
            
            if (appData.currentUser.permissions.delete) {
                document.querySelectorAll('.delete-vehicle').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const vehicleId = this.getAttribute('data-id');
                        deleteVehicle(vehicleId);
                    });
                });
            }
        }

        // Load customer table
        function loadCustomerTable() {
            const tableBody = document.getElementById('customerTableBody');
            let tableHTML = '';
            
            if (appData.customers.length === 0) {
                tableHTML = '<tr><td colspan="7" class="text-center">No customers found</td></tr>';
            } else {
                appData.customers.forEach(customer => {
                    const canEdit = appData.currentUser.permissions.edit;
                    const canDelete = appData.currentUser.permissions.delete;
                    
                    tableHTML += `
                        <tr>
                            <td>${customer.fullName}</td>
                            <td>${customer.age}</td>
                            <td>${customer.idNumber}</td>
                            <td>${customer.nationality}</td>
                            <td>${customer.contact}</td>
                            <td>${customer.totalDebt} ${appData.settings.currency}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-customer" data-id="${customer.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-warning edit-customer" data-id="${customer.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger delete-customer" data-id="${customer.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Add event listeners to action buttons
            document.querySelectorAll('.view-customer').forEach(btn => {
                btn.addEventListener('click', function() {
                    const customerId = this.getAttribute('data-id');
                    viewCustomerDetails(customerId);
                });
            });
            
            if (appData.currentUser.permissions.edit) {
                document.querySelectorAll('.edit-customer').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const customerId = this.getAttribute('data-id');
                        editCustomer(customerId);
                    });
                });
            }
            
            if (appData.currentUser.permissions.delete) {
                document.querySelectorAll('.delete-customer').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const customerId = this.getAttribute('data-id');
                        deleteCustomer(customerId);
                    });
                });
            }
        }

        // Load rental table
        function loadRentalTable() {
            const tableBody = document.getElementById('rentalTableBody');
            let tableHTML = '';
            
            if (appData.rentals.length === 0) {
                tableHTML = '<tr><td colspan="8" class="text-center">No rentals found</td></tr>';
            } else {
                appData.rentals.forEach(rental => {
                    const statusBadge = rental.status === 'active' ? 
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Returned</span>';
                    
                    tableHTML += `
                        <tr>
                            <td>${rental.invoiceCode}</td>
                            <td>${rental.customerName}</td>
                            <td>${rental.vehicleName}</td>
                            <td>${formatDate(rental.startDate)}</td>
                            <td>${formatDate(rental.endDate)}</td>
                            <td>${rental.rentalAmount} ${appData.settings.currency}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info print-invoice" data-id="${rental.id}">
                                    <i class="fas fa-print"></i>
                                </button>
                                ${rental.status === 'active' ? 
                                    `<button class="btn btn-sm btn-success return-vehicle" data-id="${rental.id}">
                                        <i class="fas fa-undo"></i>
                                    </button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Add event listeners to action buttons
            document.querySelectorAll('.print-invoice').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rentalId = this.getAttribute('data-id');
                    printRentalInvoice(rentalId);
                });
            });
            
            document.querySelectorAll('.return-vehicle').forEach(btn => {
                btn.addEventListener('click', function() {
                    const rentalId = this.getAttribute('data-id');
                    quickReturnVehicle(rentalId);
                });
            });
        }

        // Load return table
        function loadReturnTable() {
            const tableBody = document.getElementById('returnTableBody');
            let tableHTML = '';
            
            if (appData.returns.length === 0) {
                tableHTML = '<tr><td colspan="6" class="text-center">No returns found</td></tr>';
            } else {
                appData.returns.forEach(returnRecord => {
                    tableHTML += `
                        <tr>
                            <td>${returnRecord.invoiceCode}</td>
                            <td>${returnRecord.customerName}</td>
                            <td>${returnRecord.vehicleName}</td>
                            <td>${formatDate(returnRecord.returnDate)}</td>
                            <td>${returnRecord.fineAmount} ${appData.settings.currency}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-return" data-id="${returnRecord.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Load maintenance table
        function loadMaintenanceTable() {
            const tableBody = document.getElementById('maintenanceTableBody');
            let tableHTML = '';
            
            if (appData.maintenance.length === 0) {
                tableHTML = '<tr><td colspan="6" class="text-center">No maintenance records found</td></tr>';
            } else {
                appData.maintenance.forEach(maintenance => {
                    const statusBadge = maintenance.status === 'scheduled' ? 
                        '<span class="badge bg-warning">Scheduled</span>' :
                        maintenance.status === 'in-progress' ? 
                        '<span class="badge bg-info">In Progress</span>' :
                        '<span class="badge bg-success">Completed</span>';
                    
                    const canEdit = appData.currentUser.permissions.edit;
                    const canDelete = appData.currentUser.permissions.delete;
                    
                    tableHTML += `
                        <tr>
                            <td>${maintenance.vehicleName}</td>
                            <td>${maintenance.type}</td>
                            <td>${formatDate(maintenance.scheduledDate)}</td>
                            <td>${maintenance.cost} ${appData.settings.currency}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-maintenance" data-id="${maintenance.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-warning edit-maintenance" data-id="${maintenance.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger delete-maintenance" data-id="${maintenance.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Load payment table
        function loadPaymentTable() {
            const tableBody = document.getElementById('paymentTableBody');
            let tableHTML = '';
            
            if (appData.payments.length === 0) {
                tableHTML = '<tr><td colspan="5" class="text-center">No payments found</td></tr>';
            } else {
                appData.payments.forEach(payment => {
                    tableHTML += `
                        <tr>
                            <td>${payment.customerName}</td>
                            <td>${payment.amount} ${appData.settings.currency}</td>
                            <td>${formatDate(payment.date)}</td>
                            <td>${payment.notes}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-payment" data-id="${payment.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Load fine table
        function loadFineTable() {
            const tableBody = document.getElementById('fineTableBody');
            let tableHTML = '';
            
            if (appData.fines.length === 0) {
                tableHTML = '<tr><td colspan="7" class="text-center">No fines found</td></tr>';
            } else {
                appData.fines.forEach(fine => {
                    const statusBadge = fine.status === 'paid' ? 
                        '<span class="badge bg-success">Paid</span>' :
                        '<span class="badge bg-danger">Unpaid</span>';
                    
                    tableHTML += `
                        <tr>
                            <td>${fine.customerName}</td>
                            <td>${fine.amount} ${appData.settings.currency}</td>
                            <td>${formatDate(fine.date)}</td>
                            <td>${fine.type}</td>
                            <td>${fine.reason}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-fine" data-id="${fine.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${fine.status === 'unpaid' ? 
                                    `<button class="btn btn-sm btn-success mark-paid" data-id="${fine.id}">
                                        <i class="fas fa-check"></i>
                                    </button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
            
            // Add event listeners to mark paid buttons
            document.querySelectorAll('.mark-paid').forEach(btn => {
                btn.addEventListener('click', function() {
                    const fineId = this.getAttribute('data-id');
                    markFineAsPaid(fineId);
                });
            });
        }

        // Load user table
        function loadUserTable() {
            const tableBody = document.getElementById('userTableBody');
            let tableHTML = '';
            
            appData.users.forEach(user => {
                // Don't show current user in the list or allow deletion of current user
                if (user.username === appData.currentUser.username) return;
                
                const permissionsText = [];
                if (user.permissions.vehicles) permissionsText.push('Vehicles');
                if (user.permissions.rentals) permissionsText.push('Rentals');
                if (user.permissions.payments) permissionsText.push('Payments');
                if (user.permissions.reports) permissionsText.push('Reports');
                if (user.permissions.settings) permissionsText.push('Settings');
                
                const canEdit = appData.currentUser.permissions.edit;
                const canDelete = appData.currentUser.permissions.delete;
                
                tableHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>${permissionsText.join(', ')}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-warning edit-user" data-username="${user.username}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            ${canDelete ? `
                                <button class="btn btn-sm btn-danger delete-user" data-username="${user.username}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            
            // Add event listeners to action buttons
            if (appData.currentUser.permissions.edit) {
                document.querySelectorAll('.edit-user').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        editUser(username);
                    });
                });
            }
            
            if (appData.currentUser.permissions.delete) {
                document.querySelectorAll('.delete-user').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const username = this.getAttribute('data-username');
                        deleteUser(username);
                    });
                });
            }
        }

        // Load user management table
        function loadUserManagementTable() {
            const tableBody = document.getElementById('userManagementTable');
            let tableHTML = '';
            
            appData.users.forEach(user => {
                // Don't show current user in the list or allow deletion of current user
                if (user.username === appData.currentUser.username) return;
                
                const permissionsText = [];
                if (user.permissions.vehicles) permissionsText.push('Vehicles');
                if (user.permissions.rentals) permissionsText.push('Rentals');
                if (user.permissions.payments) permissionsText.push('Payments');
                if (user.permissions.reports) permissionsText.push('Reports');
                if (user.permissions.settings) permissionsText.push('Settings');
                
                const canEdit = appData.currentUser.permissions.edit;
                const canDelete = appData.currentUser.permissions.delete;
                
                tableHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td>${permissionsText.join(', ')}</td>
                        <td>
                            ${canEdit ? `
                                <button class="btn btn-sm btn-warning edit-user-modal" data-username="${user.username}">
                                    <i class="fas fa-edit"></i>
                                </button>
                            ` : ''}
                            ${canDelete ? `
                                <button class="btn btn-sm btn-danger delete-user-modal" data-username="${user.username}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        // Search vehicles
        function searchVehicles() {
            const searchTerm = document.getElementById('vehicleSearch').value.toLowerCase();
            const filteredVehicles = appData.vehicles.filter(vehicle => 
                vehicle.name.toLowerCase().includes(searchTerm) ||
                vehicle.plate.toLowerCase().includes(searchTerm) ||
                vehicle.model.toLowerCase().includes(searchTerm) ||
                vehicle.color.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.getElementById('vehicleTableBody');
            let tableHTML = '';
            
            if (filteredVehicles.length === 0) {
                tableHTML = '<tr><td colspan="9" class="text-center">No vehicles found</td></tr>';
            } else {
                filteredVehicles.forEach(vehicle => {
                    const statusBadge = vehicle.status === 'available' ? 
                        '<span class="badge bg-success">Available</span>' :
                        vehicle.status === 'rented' ? 
                        '<span class="badge bg-warning">Rented</span>' :
                        '<span class="badge bg-info">Maintenance</span>';
                    
                    const canEdit = appData.currentUser.permissions.edit;
                    const canDelete = appData.currentUser.permissions.delete;
                    
                    tableHTML += `
                        <tr>
                            <td>
                                ${vehicle.image ? 
                                    `<img src="${vehicle.image}" class="vehicle-image" alt="${vehicle.name}">` : 
                                    '<i class="fas fa-car text-muted"></i>'
                                }
                            </td>
                            <td>${vehicle.name}</td>
                            <td>${vehicle.model}</td>
                            <td>${vehicle.color}</td>
                            <td>${vehicle.plate}</td>
                            <td>${vehicle.odometer.toLocaleString()} km</td>
                            <td>${vehicle.rentalPrice} ${appData.settings.currency}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-vehicle" data-id="${vehicle.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-warning edit-vehicle" data-id="${vehicle.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger delete-vehicle" data-id="${vehicle.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Search customers
        function searchCustomers() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase();
            const filteredCustomers = appData.customers.filter(customer => 
                customer.fullName.toLowerCase().includes(searchTerm) ||
                customer.idNumber.toLowerCase().includes(searchTerm) ||
                customer.contact.toLowerCase().includes(searchTerm) ||
                customer.nationality.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.getElementById('customerTableBody');
            let tableHTML = '';
            
            if (filteredCustomers.length === 0) {
                tableHTML = '<tr><td colspan="7" class="text-center">No customers found</td></tr>';
            } else {
                filteredCustomers.forEach(customer => {
                    const canEdit = appData.currentUser.permissions.edit;
                    const canDelete = appData.currentUser.permissions.delete;
                    
                    tableHTML += `
                        <tr>
                            <td>${customer.fullName}</td>
                            <td>${customer.age}</td>
                            <td>${customer.idNumber}</td>
                            <td>${customer.nationality}</td>
                            <td>${customer.contact}</td>
                            <td>${customer.totalDebt} ${appData.settings.currency}</td>
                            <td>
                                <button class="btn btn-sm btn-info view-customer" data-id="${customer.id}">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${canEdit ? `
                                    <button class="btn btn-sm btn-warning edit-customer" data-id="${customer.id}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                ` : ''}
                                ${canDelete ? `
                                    <button class="btn btn-sm btn-danger delete-customer" data-id="${customer.id}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                ` : ''}
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Search rentals
        function searchRentals() {
            const searchTerm = document.getElementById('rentalSearch').value.toLowerCase();
            const filteredRentals = appData.rentals.filter(rental => 
                rental.invoiceCode.toLowerCase().includes(searchTerm) ||
                rental.customerName.toLowerCase().includes(searchTerm) ||
                rental.vehicleName.toLowerCase().includes(searchTerm)
            );
            
            const tableBody = document.getElementById('rentalTableBody');
            let tableHTML = '';
            
            if (filteredRentals.length === 0) {
                tableHTML = '<tr><td colspan="8" class="text-center">No rentals found</td></tr>';
            } else {
                filteredRentals.forEach(rental => {
                    const statusBadge = rental.status === 'active' ? 
                        '<span class="badge bg-success">Active</span>' :
                        '<span class="badge bg-secondary">Returned</span>';
                    
                    tableHTML += `
                        <tr>
                            <td>${rental.invoiceCode}</td>
                            <td>${rental.customerName}</td>
                            <td>${rental.vehicleName}</td>
                            <td>${formatDate(rental.startDate)}</td>
                            <td>${formatDate(rental.endDate)}</td>
                            <td>${rental.rentalAmount} ${appData.settings.currency}</td>
                            <td>${statusBadge}</td>
                            <td>
                                <button class="btn btn-sm btn-info print-invoice" data-id="${rental.id}">
                                    <i class="fas fa-print"></i>
                                </button>
                                ${rental.status === 'active' ? 
                                    `<button class="btn btn-sm btn-success return-vehicle" data-id="${rental.id}">
                                        <i class="fas fa-undo"></i>
                                    </button>` : 
                                    ''
                                }
                            </td>
                        </tr>
                    `;
                });
            }
            
            tableBody.innerHTML = tableHTML;
        }

        // Search invoice for return
        function searchInvoiceForReturn() {
            const invoiceCode = document.getElementById('returnInvoiceSearch').value;
            const rental = appData.rentals.find(r => r.invoiceCode === invoiceCode && r.status === 'active');
            
            if (rental) {
                document.getElementById('returnCustomer').value = rental.customerName;
                document.getElementById('returnVehicle').value = rental.vehicleName;
                document.getElementById('returnStartDate').value = rental.startDate;
                document.getElementById('returnEndDate').value = rental.endDate;
                document.getElementById('returnFormContainer').style.display = 'block';
            } else {
                showError('Active rental not found for this invoice code');
                document.getElementById('returnFormContainer').style.display = 'none';
            }
        }

        // Toggle customer form
        function toggleCustomerForm() {
            const customerForm = document.getElementById('newCustomerForm');
            if (customerForm.style.display === 'none' || customerForm.style.display === '') {
                customerForm.style.display = 'block';
                document.getElementById('toggleCustomerForm').innerHTML = '<i class="fas fa-user-minus"></i> Cancel Add Customer';
            } else {
                customerForm.style.display = 'none';
                document.getElementById('toggleCustomerForm').innerHTML = '<i class="fas fa-user-plus"></i> Add New Customer';
            }
        }

        // View vehicle details
        function viewVehicleDetails(vehicleId) {
            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const detailsContent = document.getElementById('vehicleDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        ${vehicle.image ? 
                            `<img src="${vehicle.image}" class="img-fluid" alt="${vehicle.name}">` : 
                            '<div class="text-center p-4 bg-light"><i class="fas fa-car fa-5x text-muted"></i></div>'
                        }
                    </div>
                    <div class="col-md-8">
                        <h4>${vehicle.name}</h4>
                        <table class="table table-bordered">
                            <tr>
                                <th>Model</th>
                                <td>${vehicle.model}</td>
                            </tr>
                            <tr>
                                <th>Color</th>
                                <td>${vehicle.color}</td>
                            </tr>
                            <tr>
                                <th>Plate Number</th>
                                <td>${vehicle.plate}</td>
                            </tr>
                            <tr>
                                <th>VIN #</th>
                                <td>${vehicle.vin}</td>
                            </tr>
                            <tr>
                                <th>Odometer</th>
                                <td>${vehicle.odometer.toLocaleString()} km</td>
                            </tr>
                            <tr>
                                <th>Rental Price</th>
                                <td>${vehicle.rentalPrice} ${appData.settings.currency} / day</td>
                            </tr>
                            <tr>
                                <th>Status</th>
                                <td>
                                    ${vehicle.status === 'available' ? 
                                        '<span class="badge bg-success">Available</span>' :
                                        vehicle.status === 'rented' ? 
                                        '<span class="badge bg-warning">Rented</span>' :
                                        '<span class="badge bg-info">Maintenance</span>'
                                    }
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            `;
            
            document.getElementById('vehicleDetailsCard').style.display = 'block';
        }

        // Close vehicle details
        function closeVehicleDetails() {
            document.getElementById('vehicleDetailsCard').style.display = 'none';
        }

        // View customer details
        function viewCustomerDetails(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const customerRentals = appData.rentals.filter(r => r.customerId === customerId);
            const customerFines = appData.fines.filter(f => f.customerId === customerId);
            const customerPayments = appData.payments.filter(p => p.customerId === customerId);
            
            const detailsContent = document.getElementById('customerDetailsContent');
            detailsContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h4>${customer.fullName}</h4>
                        <table class="table table-bordered">
                            <tr>
                                <th>Age</th>
                                <td>${customer.age}</td>
                            </tr>
                            <tr>
                                <th>ID Number</th>
                                <td>${customer.idNumber}</td>
                            </tr>
                            <tr>
                                <th>Nationality</th>
                                <td>${customer.nationality}</td>
                            </tr>
                            <tr>
                                <th>Contact</th>
                                <td>${customer.contact}</td>
                            </tr>
                            <tr>
                                <th>Address</th>
                                <td>${customer.address}</td>
                            </tr>
                            <tr>
                                <th>Total Debt</th>
                                <td>${customer.totalDebt} ${appData.settings.currency}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>Rental History</h5>
                        ${customerRentals.length > 0 ? 
                            `<ul class="list-group">
                                ${customerRentals.map(rental => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${rental.vehicleName} (${formatDate(rental.startDate)} - ${formatDate(rental.endDate)})
                                        <span class="badge ${rental.status === 'active' ? 'bg-success' : 'bg-secondary'}">${rental.status}</span>
                                    </li>
                                `).join('')}
                            </ul>` :
                            '<p>No rental history</p>'
                        }
                        
                        <h5 class="mt-3">Fines</h5>
                        ${customerFines.length > 0 ? 
                            `<ul class="list-group">
                                ${customerFines.map(fine => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${fine.reason}
                                        <span class="badge ${fine.status === 'paid' ? 'bg-success' : 'bg-danger'}">${fine.amount} ${appData.settings.currency}</span>
                                    </li>
                                `).join('')}
                            </ul>` :
                            '<p>No fines</p>'
                        }
                        
                        <h5 class="mt-3">Payments</h5>
                        ${customerPayments.length > 0 ? 
                            `<ul class="list-group">
                                ${customerPayments.map(payment => `
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        ${formatDate(payment.date)}
                                        <span class="badge bg-success">${payment.amount} ${appData.settings.currency}</span>
                                    </li>
                                `).join('')}
                            </ul>` :
                            '<p>No payments</p>'
                        }
                    </div>
                </div>
            `;
            
            document.getElementById('customerDetailsCard').style.display = 'block';
        }

        // Close customer details
        function closeCustomerDetails() {
            document.getElementById('customerDetailsCard').style.display = 'none';
        }

        // Print invoice
        function printInvoice(rental, customer, vehicle) {
            // Update print content
            document.getElementById('printInvoiceCode').textContent = rental.invoiceCode;
            document.getElementById('printInvoiceDate').textContent = formatDate(new Date().toISOString().split('T')[0]);
            document.getElementById('printCustomerName').textContent = customer.fullName;
            document.getElementById('printVehicleName').textContent = vehicle.name;
            document.getElementById('printCustomerId').textContent = customer.idNumber;
            document.getElementById('printCustomerAddress').textContent = customer.address;
            document.getElementById('printRentalAmount').textContent = `${rental.rentalAmount} ${appData.settings.currency}`;
            document.getElementById('printRentalDays').textContent = rental.rentalDays;
            document.getElementById('printTotalAmount').textContent = `${rental.rentalAmount * rental.rentalDays} ${appData.settings.currency}`;
            
            // Set system name and logo for printing
            document.getElementById('printSystemName').textContent = appData.settings.systemName;
            if (appData.settings.logo) {
                document.getElementById('printLogo').src = appData.settings.logo;
                document.getElementById('printLogo').style.display = 'block';
            }
            
            // Show rental history
            const rentalHistory = `
                <div>
                    <strong>Start Date:</strong> ${formatDate(rental.startDate)}<br>
                    <strong>End Date:</strong> ${formatDate(rental.endDate)}<br>
                    <strong>Days:</strong> ${rental.rentalDays}<br>
                    <strong>Amount per Day:</strong> ${rental.rentalAmount} ${appData.settings.currency}
                </div>
            `;
            document.getElementById('printRentalHistory').innerHTML = rentalHistory;
            
            // Print the invoice
            window.print();
        }

        // Print rental invoice
        function printRentalInvoice(rentalId) {
            const rental = appData.rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            const customer = appData.customers.find(c => c.id === rental.customerId);
            const vehicle = appData.vehicles.find(v => v.id === rental.vehicleId);
            
            if (customer && vehicle) {
                printInvoice(rental, customer, vehicle);
            }
        }

        // Quick return vehicle
        function quickReturnVehicle(rentalId) {
            const rental = appData.rentals.find(r => r.id === rentalId);
            if (!rental) return;
            
            // Pre-fill the return form
            document.getElementById('returnInvoiceSearch').value = rental.invoiceCode;
            document.getElementById('returnCustomer').value = rental.customerName;
            document.getElementById('returnVehicle').value = rental.vehicleName;
            document.getElementById('returnStartDate').value = rental.startDate;
            document.getElementById('returnEndDate').value = rental.endDate;
            document.getElementById('returnFormContainer').style.display = 'block';
            
            // Switch to returns tab
            document.querySelector('a[href="#returns"]').click();
        }

        // Mark fine as paid
        function markFineAsPaid(fineId) {
            const fine = appData.fines.find(f => f.id === fineId);
            if (!fine) return;
            
            fine.status = 'paid';
            
            // Update customer debt
            const customer = appData.customers.find(c => c.id === fine.customerId);
            if (customer) {
                customer.totalDebt -= fine.amount;
            }
            
            saveData();
            loadFineTable();
            loadCustomerTable();
            showSuccess('Fine marked as paid');
        }

        // Display report results
        function displayReportResults(results, title, reportType) {
            const reportResults = document.getElementById('reportResults');
            
            if (results.length === 0) {
                reportResults.innerHTML = `<p>No data found for the selected criteria.</p>`;
                return;
            }
            
            let tableHTML = `<h4>${title}</h4>`;
            tableHTML += `<div class="table-responsive"><table class="table table-striped"><thead><tr>`;
            
            // Generate table headers based on report type
            switch (reportType) {
                case 'rental':
                    tableHTML += `
                        <th>Invoice Code</th>
                        <th>Customer</th>
                        <th>Vehicle</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Amount</th>
                        <th>Status</th>
                    `;
                    break;
                case 'financial':
                    tableHTML += `
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Notes</th>
                    `;
                    break;
                case 'vehicle':
                    tableHTML += `
                        <th>Name</th>
                        <th>Model</th>
                        <th>Color</th>
                        <th>Plate</th>
                        <th>Odometer</th>
                        <th>Rental Price</th>
                        <th>Status</th>
                    `;
                    break;
                case 'customer':
                    tableHTML += `
                        <th>Full Name</th>
                        <th>Age</th>
                        <th>ID</th>
                        <th>Nationality</th>
                        <th>Contact</th>
                        <th>Total Debt</th>
                    `;
                    break;
                case 'maintenance':
                    tableHTML += `
                        <th>Vehicle</th>
                        <th>Type</th>
                        <th>Scheduled Date</th>
                        <th>Cost</th>
                        <th>Status</th>
                    `;
                    break;
                case 'fines':
                    tableHTML += `
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Reason</th>
                        <th>Status</th>
                    `;
                    break;
            }
            
            tableHTML += `</tr></thead><tbody>`;
            
            // Generate table rows
            results.forEach(item => {
                tableHTML += `<tr>`;
                
                switch (reportType) {
                    case 'rental':
                        tableHTML += `
                            <td>${item.invoiceCode}</td>
                            <td>${item.customerName}</td>
                            <td>${item.vehicleName}</td>
                            <td>${formatDate(item.startDate)}</td>
                            <td>${formatDate(item.endDate)}</td>
                            <td>${item.rentalAmount} ${appData.settings.currency}</td>
                            <td>${item.status}</td>
                        `;
                        break;
                    case 'financial':
                        tableHTML += `
                            <td>${item.customerName}</td>
                            <td>${item.amount} ${appData.settings.currency}</td>
                            <td>${formatDate(item.date)}</td>
                            <td>${item.notes}</td>
                        `;
                        break;
                    case 'vehicle':
                        tableHTML += `
                            <td>${item.name}</td>
                            <td>${item.model}</td>
                            <td>${item.color}</td>
                            <td>${item.plate}</td>
                            <td>${item.odometer.toLocaleString()} km</td>
                            <td>${item.rentalPrice} ${appData.settings.currency}</td>
                            <td>${item.status}</td>
                        `;
                        break;
                    case 'customer':
                        tableHTML += `
                            <td>${item.fullName}</td>
                            <td>${item.age}</td>
                            <td>${item.idNumber}</td>
                            <td>${item.nationality}</td>
                            <td>${item.contact}</td>
                            <td>${item.totalDebt} ${appData.settings.currency}</td>
                        `;
                        break;
                    case 'maintenance':
                        tableHTML += `
                            <td>${item.vehicleName}</td>
                            <td>${item.type}</td>
                            <td>${formatDate(item.scheduledDate)}</td>
                            <td>${item.cost} ${appData.settings.currency}</td>
                            <td>${item.status}</td>
                        `;
                        break;
                    case 'fines':
                        tableHTML += `
                            <td>${item.customerName}</td>
                            <td>${item.amount} ${appData.settings.currency}</td>
                            <td>${formatDate(item.date)}</td>
                            <td>${item.type}</td>
                            <td>${item.reason}</td>
                            <td>${item.status}</td>
                        `;
                        break;
                }
                
                tableHTML += `</tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            
            // Add summary
            const total = results.reduce((sum, item) => {
                if (reportType === 'rental') return sum + (item.rentalAmount * item.rentalDays);
                if (reportType === 'financial') return sum + item.amount;
                if (reportType === 'maintenance') return sum + item.cost;
                if (reportType === 'fines') return sum + item.amount;
                return sum;
            }, 0);
            
            if (['rental', 'financial', 'maintenance', 'fines'].includes(reportType)) {
                tableHTML += `<div class="mt-3"><strong>Total: ${total.toFixed(2)} ${appData.settings.currency}</strong></div>`;
            }
            
            tableHTML += `<div class="mt-2"><strong>Records: ${results.length}</strong></div>`;
            
            reportResults.innerHTML = tableHTML;
        }

        // Setup auto-suggestions
        function setupAutoSuggestions() {
            // Customer suggestions for rental
            document.getElementById('rentalCustomer').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.customers
                    .filter(customer => customer.fullName.toLowerCase().includes(searchTerm))
                    .slice(0, 5);
                
                displaySuggestions('customerSuggestions', suggestions.map(c => c.fullName));
            });
            
            // Vehicle suggestions for rental
            document.getElementById('rentalVehicle').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.vehicles
                    .filter(vehicle => vehicle.status === 'available' && vehicle.name.toLowerCase().includes(searchTerm))
                    .slice(0, 5);
                
                displaySuggestions('vehicleSuggestions', suggestions.map(v => v.name));
                
                // Auto-fill rental amount if a vehicle is selected
                const selectedVehicle = appData.vehicles.find(v => v.name === this.value);
                if (selectedVehicle) {
                    document.getElementById('rentalAmount').value = selectedVehicle.rentalPrice;
                }
            });
            
            // Color suggestions
            document.getElementById('vehicleColor').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.colors
                    .filter(color => color.toLowerCase().includes(searchTerm))
                    .slice(0, 5);
                
                displaySuggestions('colorSuggestions', suggestions);
            });
            
            // Model suggestions
            document.getElementById('vehicleModel').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.models
                    .filter(model => model.toLowerCase().includes(searchTerm))
                    .slice(0, 5);
                
                displaySuggestions('modelSuggestions', suggestions);
            });
            
            // Nationality suggestions
            document.getElementById('customerNationality').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.nationalities
                    .filter(nationality => nationality.toLowerCase().includes(searchTerm))
                    .slice(0, 5);
                
                displaySuggestions('nationalitySuggestions', suggestions);
            });
            
            // Return invoice suggestions
            document.getElementById('returnInvoiceSearch').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.rentals
                    .filter(rental => rental.status === 'active' && rental.invoiceCode.toLowerCase().includes(searchTerm))
                    .slice(0, 5)
                    .map(r => r.invoiceCode);
                
                displaySuggestions('returnInvoiceSuggestions', suggestions);
            });
            
            // Payment customer suggestions
            document.getElementById('paymentCustomer').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.customers
                    .filter(customer => customer.fullName.toLowerCase().includes(searchTerm))
                    .slice(0, 5)
                    .map(c => c.fullName);
                
                displaySuggestions('paymentCustomerSuggestions', suggestions);
            });
            
            // Maintenance vehicle suggestions
            document.getElementById('maintenanceVehicle').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.vehicles
                    .filter(vehicle => vehicle.name.toLowerCase().includes(searchTerm))
                    .slice(0, 5)
                    .map(v => v.name);
                
                displaySuggestions('maintenanceVehicleSuggestions', suggestions);
            });
            
            // Fine customer suggestions
            document.getElementById('fineCustomer').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.customers
                    .filter(customer => customer.fullName.toLowerCase().includes(searchTerm))
                    .slice(0, 5)
                    .map(c => c.fullName);
                
                displaySuggestions('fineCustomerSuggestions', suggestions);
            });
            
            // Report customer suggestions
            document.getElementById('reportCustomer').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.customers
                    .filter(customer => customer.fullName.toLowerCase().includes(searchTerm))
                    .slice(0, 5)
                    .map(c => c.fullName);
                
                displaySuggestions('reportCustomerSuggestions', suggestions);
            });
            
            // Report vehicle suggestions
            document.getElementById('reportVehicle').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const suggestions = appData.vehicles
                    .filter(vehicle => vehicle.name.toLowerCase().includes(searchTerm))
                    .slice(0, 5)
                    .map(v => v.name);
                
                displaySuggestions('reportVehicleSuggestions', suggestions);
            });
            
            // Close suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.matches('.suggestion-list, .suggestion-list *')) {
                    hideAllSuggestions();
                }
            });
        }

        // Display suggestions
        function displaySuggestions(containerId, suggestions) {
            const container = document.getElementById(containerId);
            
            if (suggestions.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = '';
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion;
                div.addEventListener('click', function() {
                    const input = container.previousElementSibling;
                    input.value = suggestion;
                    container.style.display = 'none';
                    
                    // Trigger change event for auto-fill
                    if (input.id === 'rentalVehicle') {
                        const event = new Event('change');
                        input.dispatchEvent(event);
                    }
                });
                container.appendChild(div);
            });
            
            container.style.display = 'block';
        }

        // Hide all suggestions
        function hideAllSuggestions() {
            document.querySelectorAll('.suggestion-list').forEach(container => {
                container.style.display = 'none';
            });
        }

        // Setup tab events
        function setupTabEvents() {
            // When switching to dashboard, update stats
            document.querySelector('a[href="#dashboard"]').addEventListener('click', function() {
                updateDashboardStats();
                loadRecentRentals();
            });
            
            // When switching to vehicles, load table
            document.querySelector('a[href="#vehicles"]').addEventListener('click', function() {
                loadVehicleTable();
            });
            
            // When switching to rentals-customers, load tables
            document.querySelector('a[href="#rentals-customers"]').addEventListener('click', function() {
                loadCustomerTable();
                loadRentalTable();
            });
            
            // When switching to returns, load table
            document.querySelector('a[href="#returns"]').addEventListener('click', function() {
                loadReturnTable();
            });
            
            // When switching to maintenance, load table
            document.querySelector('a[href="#maintenance"]').addEventListener('click', function() {
                loadMaintenanceTable();
            });
            
            // When switching to payments, load table
            document.querySelector('a[href="#payments"]').addEventListener('click', function() {
                loadPaymentTable();
            });
            
            // When switching to fines, load table
            document.querySelector('a[href="#fines"]').addEventListener('click', function() {
                loadFineTable();
            });
            
            // When switching to settings, load user table
            document.querySelector('a[href="#settings"]').addEventListener('click', function() {
                loadUserTable();
            });
        }

        // Utility functions
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function generateInvoiceCode() {
            const date = new Date();
            const year = date.getFullYear().toString().substr(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const random = Math.random().toString(36).substr(2, 5).toUpperCase();
            return `INV-${year}${month}${day}-${random}`;
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US');
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            new bootstrap.Modal(document.getElementById('successModal')).show();
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            new bootstrap.Modal(document.getElementById('errorModal')).show();
        }

        // Note: The following functions are placeholders and need to be implemented
        function editVehicle(vehicleId) {
            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            const newPrice = prompt(`Enter new rental price for ${vehicle.name}:`, vehicle.rentalPrice);
            if (newPrice && !isNaN(newPrice)) {
                vehicle.rentalPrice = parseFloat(newPrice);
                saveData();
                loadVehicleTable();
                showSuccess('Vehicle updated successfully');
            }
        }

        function deleteVehicle(vehicleId) {
            const vehicle = appData.vehicles.find(v => v.id === vehicleId);
            if (!vehicle) return;
            
            if (confirm(`Are you sure you want to delete ${vehicle.name}?`)) {
                // Check if vehicle is currently rented
                const activeRental = appData.rentals.find(r => r.vehicleId === vehicleId && r.status === 'active');
                if (activeRental) {
                    showError('Cannot delete vehicle that is currently rented');
                    return;
                }
                
                appData.vehicles = appData.vehicles.filter(v => v.id !== vehicleId);
                saveData();
                loadVehicleTable();
                showSuccess('Vehicle deleted successfully');
            }
        }

        function editCustomer(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const newContact = prompt(`Enter new contact number for ${customer.fullName}:`, customer.contact);
            if (newContact) {
                customer.contact = newContact;
                saveData();
                loadCustomerTable();
                showSuccess('Customer updated successfully');
            }
        }

        function deleteCustomer(customerId) {
            const customer = appData.customers.find(c => c.id === customerId);
            if (!customer) return;
            
            if (confirm(`Are you sure you want to delete ${customer.fullName}?`)) {
                // Check if customer has active rentals
                const activeRental = appData.rentals.find(r => r.customerId === customerId && r.status === 'active');
                if (activeRental) {
                    showError('Cannot delete customer with active rentals');
                    return;
                }
                
                appData.customers = appData.customers.filter(c => c.id !== customerId);
                saveData();
                loadCustomerTable();
                showSuccess('Customer deleted successfully');
            }
        }

        function editUser(username) {
            const user = appData.users.find(u => u.username === username);
            if (!user) return;
            
            const newRole = prompt(`Enter new role for ${username} (admin/user/viewer):`, user.role);
            if (newRole && ['admin', 'user', 'viewer'].includes(newRole)) {
                user.role = newRole;
                user.permissions = getDefaultPermissions(newRole);
                saveData();
                loadUserTable();
                loadUserManagementTable();
                showSuccess('User updated successfully');
            }
        }

        function deleteUser(username) {
            if (username === appData.currentUser.username) {
                showError('You cannot delete your own account');
                return;
            }
            
            if (confirm(`Are you sure you want to delete user ${username}?`)) {
                appData.users = appData.users.filter(u => u.username !== username);
                saveData();
                loadUserTable();
                loadUserManagementTable();
                showSuccess('User deleted successfully');
            }
        }

        function viewReturn(returnId) {
            showError('View return functionality not implemented in this demo');
        }

        function viewMaintenance(maintenanceId) {
            showError('View maintenance functionality not implemented in this demo');
        }

        function editMaintenance(maintenanceId) {
            const maintenance = appData.maintenance.find(m => m.id === maintenanceId);
            if (!maintenance) return;
            
            const newStatus = prompt(`Enter new status for maintenance (scheduled/in-progress/completed):`, maintenance.status);
            if (newStatus && ['scheduled', 'in-progress', 'completed'].includes(newStatus)) {
                maintenance.status = newStatus;
                saveData();
                loadMaintenanceTable();
                showSuccess('Maintenance updated successfully');
            }
        }

        function deleteMaintenance(maintenanceId) {
            const maintenance = appData.maintenance.find(m => m.id === maintenanceId);
            if (!maintenance) return;
            
            if (confirm('Are you sure you want to delete this maintenance record?')) {
                appData.maintenance = appData.maintenance.filter(m => m.id !== maintenanceId);
                saveData();
                loadMaintenanceTable();
                showSuccess('Maintenance record deleted successfully');
            }
        }

        function viewPayment(paymentId) {
            showError('View payment functionality not implemented in this demo');
        }

        function viewFine(fineId) {
            showError('View fine functionality not implemented in this demo');
        }
    </script>
</body>
</html>